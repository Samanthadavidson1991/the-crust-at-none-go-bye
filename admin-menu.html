<!DOCTYPE html>
<html lang="en">
<head>
    <script>
      // Detect environment and set API base URL
      const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      const API_BASE_URL = isLocal
        ? ''
        : 'https://the-crust-at-none-go-bye-admin.onrender.com';
    </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Menu Editor | None Go Bye</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <!-- Moved styles to styles.css -->
</head>
<body class="admin-page">
    <!-- Login redirect removed for dashboard access -->
      <script>
        // Login/session check
        fetch(API_BASE_URL + '/api/admin/check', { credentials: 'include' })
          .then(r => {
            if (!r.ok) window.location.href = 'login.html';
          });
      </script>
      <script src="/admin-order-toast.js"></script>
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <header>
    <h1 class="main-heading underline">Admin  Menu Editor</h1>
      <h1 class="main-heading underline">Admin Menu Editor <button id="lock-page-btn" class="float-right mt-8" onclick="lockAdminPage()">Lock this page</button></h1>
    <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
      <a href="admin-menu.html">Menu Editor</a>
      <a href="stock-management.html">Stock Management</a>
      <a href="timeslots.html">Time Slots</a>
      <a href="orders.html">Orders</a>
      <a href="running-orders.html">Running Orders</a>
      <a href="takings.html">Takings</a>
      <a href="pos.html">POS Manual Order</a>
      <a href="offers.html">Special Offers</a>
      
    </nav>
  </header>
  <main>
        <script>
        // --- Lock Page Logic ---
        function lockAdminPage() {
          fetch(API_BASE_URL + '/api/admin/lock', { method: 'POST', credentials: 'include' })
            .then(r => {
              if (r.ok) {
                alert('Page locked. You will not be logged out automatically.');
              } else {
                alert('Failed to lock page.');
              }
            });
        }
        </script>
    <main id="main-content">
    <section class="admin-section">
      <!-- Announcement Section (Dashboard) -->
      <div id="admin-announcement" class="admin-announcement"></div>
        <strong>Announcement:</strong>
        <span id="admin-announcement-text"></span>
        <form id="admin-announcement-form">
          <input type="text" id="admin-announcement-input" placeholder="Edit announcement...">
          <button type="submit">Update</button>
        </form>
            <!-- Toppings UI removed -->
        <form id="addPizzaMasterToppingForm" class="mb-12 flex gap-8 align-center">
          <input type="text" id="pizzaMasterToppingInput" placeholder="Topping name" required title="Pizza topping name">
          <select id="pizzaMasterToppingType" required title="Topping type">
            <!DOCTYPE html>
            <option value="meat">Meat</option>
            <option value="vegetable">Vegetable</option>
            <option value="other">Other</option>
          </select>
          <input type="number" id="pizzaMasterToppingPrice" placeholder="Price (£)" step="0.01" min="0" required title="Topping price">
          <button type="submit">Add Topping</button>
        </form>
        <div class="flex gap-40">
          <div class="flex-1">
            <h4>Meat</h4>
            <ul id="pizzaMeatToppingsList"></ul>
          </div>
          <div class="flex-1">
            <h4>Vegetable</h4>
            <ul id="pizzaVegToppingsList"></ul>
          </div>
        </div>
      </div>
      <div id="salad-topping-master-section" class="mb-32">
        <h3>Salad Master Toppings</h3>
        <form id="addSaladMasterToppingForm" class="mb-12 flex gap-8 align-center">
          <input type="text" id="saladMasterToppingInput" placeholder="Topping name" required title="Salad topping name">
          <select id="saladMasterToppingType" required title="Topping type">
            <option value="">Type</option>
            <option value="meat">Meat</option>
            <option value="vegetable">Vegetable</option>
            <option value="other">Other</option>
          </select>
            <input type="number" id="saladMasterToppingPrice" placeholder="Price (£)" step="0.01" min="0" required title="Topping price">          
          </form>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const saladMasterToppingType = document.getElementById('saladMasterToppingType');
              if (saladMasterToppingType) {
                saladMasterToppingType.addEventListener('change', function() {
                  // ...existing code...
                });
              }
            });
          </script>
        <div class="flex gap-40">
          <div class="flex-1">
            <h4>Meat</h4>
            <ul id="saladMeatToppingsList"></ul>
          </div>
          <div class="flex-1">
            <h4>Vegetable</h4>
            <ul id="saladVegToppingsList"></ul>
          </div>
        </div>
      </div>
      <form class="menu-form" id="menuForm">
        <div id="dessertDrinkFields" class="d-none">
          <label><b>Price (£):</b></label>
          <input type="number" id="dessertDrinkPriceInput" name="price" placeholder="Price (£)" step="0.01" min="0">
        </div>
        <select name="category" id="categorySelect" required title="Select menu category">
          <option value="">Select Category</option>
          <option value="Pizza">Pizza</option>
          <option value="Sides">Sides</option>
          <option value="Desserts">Desserts</option>
          <option value="Drinks">Drinks</option>
          <option value="Salads">Salads</option>
        </select>
        <input type="text" name="name" placeholder="Item Name" required>
        <input type="text" name="description" placeholder="Description" required>
        <div id="sidesFields" class="d-none">
          <label><b>Options & Prices:</b></label><br>
          <div id="sidesOptionsList"></div>
          <input type="text" id="sideOptionNameInput" placeholder="Option name (e.g. Regular, With Dip)">
          <input type="number" id="sideOptionPriceInput" placeholder="Price (£)" step="0.01" min="0">
          <button type="button" id="addSideOptionBtn">Add Option</button>
          <br><br>
        </div>
        <div id="pizzaFields" class="d-none">
          <label><b>Toppings:</b></label>
          <div id="toppingsList"></div>
          <input type="text" id="toppingInput" placeholder="Add topping">
          <button type="button" id="addToppingBtn">Add Topping</button>
          <br><br>
          <label><b>Sizes & Prices:</b></label><br>
          <div id="sizesList"></div>
          <select id="sizeNameInput" class="mb-12" title="Size name">
            <option value="">Select size</option>
            <option value="12in">12in</option>
            <option value="8in">8in</option>
            <option value="Gluten Free">Gluten Free</option>
          </select>
          <input type="number" id="sizePriceInput" placeholder="Price (£)" step="0.01" min="0">
          <button type="button" id="addSizeBtn">Add Size</button>
          <br><br>
        </div>
        <button type="submit">Add / Update Item</button>
      </form>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const categorySelect = document.getElementById('categorySelect');
          const dessertDrinkFields = document.getElementById('dessertDrinkFields');
          if (categorySelect && dessertDrinkFields) {
            function updateDessertDrinkFields() {
              const cat = categorySelect.value;
              dessertDrinkFields.style.display = (cat === 'Desserts' || cat === 'Drinks') ? '' : 'none';
            }
            categorySelect.addEventListener('change', updateDessertDrinkFields);
            updateDessertDrinkFields();
          }
        });
      </script>
      <div class="menu-list">
              <script>
                // Show price input for Desserts/Drinks
                document.addEventListener('DOMContentLoaded', function() {
                  const categorySelect = document.getElementById('categorySelect');
                  const dessertDrinkFields = document.getElementById('dessertDrinkFields');
                  if (categorySelect && dessertDrinkFields) {
                    function updateDessertDrinkFields() {
        <script>
          document.getElementById('menuForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            // Gather form data
            const category = document.getElementById('categorySelect').value;
            const name = this.elements['name'].value.trim();
            const description = this.elements['description'].value.trim();
            let price = null;
            let item = { category, name, description };
            // Gather toppings, sizes, sideOptions from global arrays
            if (category === 'Pizza') {
              item.toppings = window.toppings || [];
              item.sizes = window.sizes || [];
            } else if (category === 'Sides') {
              item.sideOptions = window.sideOptions || [];
            } else if (category === 'Desserts' || category === 'Drinks') {
              price = document.getElementById('dessertDrinkPriceInput').value;
              item.price = price ? parseFloat(price) : null;
            }
            // POST to backend
            try {
              const res = await fetch(API_BASE_URL + '/api/menu', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(item)
              });
              if (res.ok) {
                alert('Menu item saved!');
                fetchAdminMenu(); // Refresh menu preview
                this.reset();
              } else {
                const err = await res.json();
                alert('Error saving menu item: ' + (err.error || 'Unknown error'));
              }
            } catch (err) {
              alert('Failed to save menu item: ' + err.message);
            }
          });
        </script>
                      const cat = categorySelect.value;
                      dessertDrinkFields.style.display = (cat === 'Desserts' || cat === 'Drinks') ? '' : 'none';
                    }
                    categorySelect.addEventListener('change', updateDessertDrinkFields);
                    updateDessertDrinkFields();
                  }
                });
              </script>
        <h3>Current Menu Preview</h3>
        <div id="admin-menu-loading">Loading menu...</div>
  <div id="admin-menu-content" class="d-none"></div>
      </div>
    </section>
  <script>
                // --- Editable Announcement Section Logic ---
                // Store announcement in localStorage for now (can be upgraded to backend later)
                function getAdminAnnouncement() {
                  return localStorage.getItem('adminAnnouncementText') || '';
                }
                function setAdminAnnouncement(text) {
                  localStorage.setItem('adminAnnouncementText', text);
                }
                document.addEventListener('DOMContentLoaded', function() {
                  var annDiv = document.getElementById('admin-announcement');
                  var annText = document.getElementById('admin-announcement-text');
                  var annForm = document.getElementById('admin-announcement-form');
                  var annInput = document.getElementById('admin-announcement-input');
                  function updateAnnouncementUI() {
                    var text = getAdminAnnouncement();
                    if (text && text.trim().length > 0) {
                      annText.textContent = text;
                      annDiv.style.display = '';
                    } else {
                      annText.textContent = '';
                      annDiv.style.display = '';
                    }
                    annInput.value = text;
                  }
                  annForm.onsubmit = function(e) {
                    e.preventDefault();
                    var newText = annInput.value.trim();
                    setAdminAnnouncement(newText);
                    updateAnnouncementUI();
                  };
                  updateAnnouncementUI();
                });
                // --- Master Toppings Section ---
                // (Removed duplicate/legacy DOMContentLoaded for master toppings and menu preview)
            // --- Toppings, Sizes, and Side Options logic for menu item ---
            // Arrays to hold current form state
            let toppings = [];
            let sizes = [];
            let sideOptions = [];

            // DOM elements
            const addToppingBtn = document.getElementById('addToppingBtn');
            const toppingInput = document.getElementById('toppingInput');
            const toppingsList = document.getElementById('toppingsList');
            const addSizeBtn = document.getElementById('addSizeBtn');
            const sizeNameInput = document.getElementById('sizeNameInput');
            const sizePriceInput = document.getElementById('sizePriceInput');
            const sizesList = document.getElementById('sizesList');
            const addSideOptionBtn = document.getElementById('addSideOptionBtn');
            const sideOptionNameInput = document.getElementById('sideOptionNameInput');
            const sideOptionPriceInput = document.getElementById('sideOptionPriceInput');
            const sidesOptionsList = document.getElementById('sidesOptionsList');

            // Render toppings
            function renderToppings() {
              toppingsList.innerHTML = '';
              toppings.forEach((t, i) => {
                const span = document.createElement('span');
                span.textContent = t;
                span.style.marginRight = '8px';
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'x';
                removeBtn.type = 'button';
                removeBtn.style.marginLeft = '4px';
                removeBtn.onclick = () => { toppings.splice(i, 1); renderToppings(); };
                span.appendChild(removeBtn);
                toppingsList.appendChild(span);
              });
            }
            addToppingBtn.onclick = function() {
              const val = toppingInput.value.trim();
              if(val) { toppings.push(val); toppingInput.value = ''; renderToppings(); }
            };

            // Render sizes
            function renderSizes() {
              sizesList.innerHTML = '';
              sizes.forEach((s, i) => {
                const div = document.createElement('div');
                div.textContent = `${s.name} - £${parseFloat(s.price).toFixed(2)}`;
                div.style.marginRight = '8px';
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'x';
                removeBtn.type = 'button';
                removeBtn.style.marginLeft = '4px';
                removeBtn.onclick = () => { sizes.splice(i, 1); renderSizes(); };
                div.appendChild(removeBtn);
                sizesList.appendChild(div);
              });
            }
            addSizeBtn.onclick = function() {
              let name = sizeNameInput.value;
              const price = sizePriceInput.value.trim();
              // Only allow dropdown values for pizza
              const cat = document.getElementById('categorySelect').value;
              if (cat === 'Pizza') {
                if ((name === '12in' || name === '8in' || name === 'Gluten Free') && price && !isNaN(price)) {
                  sizes.push({name, price: parseFloat(price)});
                  sizeNameInput.value = '';
                  sizePriceInput.value = '';
                  renderSizes();
                }
              } else {
                // For non-pizza, allow free text (fallback, not shown in UI)
                if (name && price && !isNaN(price)) {
                  sizes.push({name, price: parseFloat(price)});
                  sizeNameInput.value = '';
                  sizePriceInput.value = '';
                  renderSizes();
                }
              }
            };

            // Render side options
            function renderSideOptions() {
              sidesOptionsList.innerHTML = '';
              sideOptions.forEach((s, i) => {
                const div = document.createElement('div');
                div.textContent = `${s.name} - £${parseFloat(s.price).toFixed(2)}`;
                div.style.marginRight = '8px';
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'x';
                removeBtn.type = 'button';
                removeBtn.style.marginLeft = '4px';
                removeBtn.onclick = () => { sideOptions.splice(i, 1); renderSideOptions(); };
                div.appendChild(removeBtn);
                sidesOptionsList.appendChild(div);
              });
            }
            addSideOptionBtn.onclick = function() {
              const name = sideOptionNameInput.value.trim();
              const price = sideOptionPriceInput.value.trim();
              if(name && price && !isNaN(price)) {
                sideOptions.push({name, price: parseFloat(price)});
                sideOptionNameInput.value = '';
                sideOptionPriceInput.value = '';
                renderSideOptions();
              }
            };

            // Reset all arrays and UI on form reset
            document.getElementById('menuForm').addEventListener('reset', () => {
              toppings = [];
              sizes = [];
              sideOptions = [];
              renderToppings();
              renderSizes();
              renderSideOptions();
            });

            // Initial render
            renderToppings();
            renderSizes();
            renderSideOptions();
        // Show/hide pizza and sides fields based on category
        document.addEventListener('DOMContentLoaded', function() {
          const categorySelect = document.getElementById('categorySelect');
          const pizzaFields = document.getElementById('pizzaFields');
          const sidesFields = document.getElementById('sidesFields');
          function updateFields() {
            const cat = categorySelect.value;
            if (cat === 'Pizza') {
              pizzaFields.classList.remove('d-none');
              sidesFields.classList.add('d-none');
            } else if (cat === 'Sides') {
              pizzaFields.classList.add('d-none');
              sidesFields.classList.remove('d-none');
            } else {
              pizzaFields.classList.add('d-none');
              sidesFields.classList.add('d-none');
            }
          }
          categorySelect.addEventListener('change', updateFields);
          updateFields();
        });
    // --- Admin Menu Preview Section ---
    async function fetchAdminMenu() {
      const loading = document.getElementById('admin-menu-loading');
      const content = document.getElementById('admin-menu-content');
      loading.style.display = '';
      content.classList.add('d-none');
      try {
        const res = await fetch(API_BASE_URL + '/api/menu', { credentials: 'include' });
        const menu = await res.json();
        renderAdminMenu(menu.items || []);
        loading.style.display = 'none';
        content.classList.remove('d-none');
      } catch (err) {
        loading.textContent = 'Error loading menu.';
        content.classList.add('d-none');
        console.error('Failed to fetch admin menu:', err);
      }
    }

    function renderAdminMenu(menu) {
      const content = document.getElementById('admin-menu-content');
      if (!menu || !Array.isArray(menu) || menu.length === 0) {
        content.innerHTML = '<em>No menu items yet.</em>';
        return;
      }
      // Group by category
      const categories = {};
      menu.forEach(item => {
        const cat = item.category || 'Other';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(item);
      });
      let html = '';
      Object.keys(categories).forEach(cat => {
        html += `<h4>${cat}</h4><ul style='padding-left:0;'>`;
        categories[cat].forEach(item => {
          html += `<li style='margin-bottom:8px;list-style:none;'><b>${item.name}</b> - ${item.description ? item.description : ''}`;
          if(cat === 'Pizza' && item.sizes && Array.isArray(item.sizes) && item.sizes.length) {
            html += '<ul style="list-style:none;padding:0;">';
            item.sizes.forEach(size => {
              html += `<li>${size.name}: <span class='price'>£${parseFloat(size.price).toFixed(2)}</span></li>`;
            });
            html += '</ul>';
          } else if ((cat === 'Desserts' || cat === 'Drinks') && item.price !== undefined) {
            html += ` <span class='price'>£${parseFloat(item.price).toFixed(2)}</span>`;
          }
          html += `</li>`;
        });
        html += '</ul>';
      });
      content.innerHTML = html;
    }
    // --- Pizza Master Toppings Section ---
    async function fetchPizzaMasterToppings() {
      const res = await fetch(API_BASE_URL + '/api/pizza-topping-stock', { credentials: 'include' });
      const toppings = await res.json();
      renderPizzaMasterToppings(toppings);
    }
    function renderPizzaMasterToppings(toppings) {
      const meatList = document.getElementById('pizzaMeatToppingsList');
      const vegList = document.getElementById('pizzaVegToppingsList');
      let otherList = document.getElementById('pizzaOtherToppingsList');
      if (!otherList) {
        otherList = document.createElement('ul');
        otherList.id = 'pizzaOtherToppingsList';
        const otherDiv = document.createElement('div');
        otherDiv.style.flex = '1';
        const otherHeader = document.createElement('h4');
        otherHeader.textContent = 'Other';
        otherDiv.appendChild(otherHeader);
        otherDiv.appendChild(otherList);
        if (meatList && meatList.parentElement && meatList.parentElement.parentElement) {
          if (meatList && meatList.parentElement && meatList.parentElement.parentElement) {
            meatList.parentElement.parentElement.appendChild(otherDiv);
          }
        }
      }
      meatList.innerHTML = '';
      vegList.innerHTML = '';
      otherList.innerHTML = '';
      toppings = Array.isArray(toppings) ? toppings : [];
      toppings.forEach(t => {
        const li = document.createElement('li');
        li.style.marginBottom = '4px';
        let isEditing = false;
        function renderToppingItem() {
          li.innerHTML = '';
          if (!isEditing) {
            li.textContent = `${t.topping} (${t.type || 'no type'}) £${t.price !== undefined ? parseFloat(t.price).toFixed(2) : '0.00'}`;
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.style.marginLeft = '8px';
            editBtn.onclick = () => { isEditing = true; renderToppingItem(); };
            li.appendChild(editBtn);
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Delete';
            delBtn.style.marginLeft = '8px';
            delBtn.onclick = async () => {
              await deletePizzaMasterTopping(t.topping);
              fetchPizzaMasterToppings();
            };
            li.appendChild(delBtn);
          } else {
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = t.topping;
            nameInput.style.width = '90px';
            const typeSelect = document.createElement('select');
            ['meat','vegetable','other'].forEach(opt => {
              const o = document.createElement('option');
              o.value = opt;
              o.textContent = opt.charAt(0).toUpperCase() + opt.slice(1);
              if (t.type === opt) o.selected = true;
              typeSelect.appendChild(o);
            });
            const priceInput = document.createElement('input');
            priceInput.type = 'number';
            priceInput.step = '0.01';
            priceInput.min = '0';
            priceInput.style.width = '70px';
            priceInput.value = t.price !== undefined ? parseFloat(t.price).toFixed(2) : '0.50';
            function updatePriceField() {
              if (typeSelect.value === 'other') {
                if (!priceInput.value || priceInput.value === '1.00' || priceInput.value === '0.60') priceInput.value = '0.50';
                priceInput.readOnly = false;
              } else if (typeSelect.value === 'meat') {
                priceInput.value = '1.00';
                priceInput.readOnly = false;
              } else if (typeSelect.value === 'vegetable') {
                priceInput.value = '0.60';
                priceInput.readOnly = false;
              } else {
                priceInput.value = '';
                priceInput.readOnly = false;
              }
            }
            typeSelect.addEventListener('change', updatePriceField);
            updatePriceField();
            li.appendChild(nameInput);
            li.appendChild(typeSelect);
            li.appendChild(priceInput);
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.style.marginLeft = '8px';
            saveBtn.onclick = async () => {
              const res = await fetch(API_BASE_URL + '/api/pizza-topping-stock');
              let allToppings = await res.json();
              const idx = allToppings.findIndex(x => x.topping === t.topping);
              if (idx > -1) {
                allToppings[idx] = {
                  ...allToppings[idx],
                  topping: nameInput.value.trim(),
                  type: typeSelect.value,
                  price: parseFloat(priceInput.value)
                };
                await fetch(API_BASE_URL + '/api/pizza-topping-stock', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ toppingStatus: allToppings })
                });
                isEditing = false;
                fetchPizzaMasterToppings();
              }
            };
            li.appendChild(saveBtn);
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.style.marginLeft = '8px';
            cancelBtn.onclick = () => { isEditing = false; renderToppingItem(); };
            li.appendChild(cancelBtn);
          }
        }
        renderToppingItem();
        if (typeof t.type === 'string') {
          const typeLower = t.type.trim().toLowerCase();
          if (typeLower === 'meat') {
            meatList.appendChild(li);
          } else if (typeLower === 'vegetable') {
            vegList.appendChild(li);
          } else {
            otherList.appendChild(li);
          }
        } else {
          otherList.appendChild(li);
        }
      });
    }

    async function deletePizzaMasterTopping(name) {
      const res = await fetch(API_BASE_URL + '/api/pizza-topping-stock', { credentials: 'include' });
      let toppings = await res.json();
      toppings = toppings.filter(t => t.topping !== name);
      await fetch(API_BASE_URL + '/api/pizza-topping-stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ toppingStatus: toppings }),
        credentials: 'include'
      });
      fetchPizzaMasterToppings();
    }