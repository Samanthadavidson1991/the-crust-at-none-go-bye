<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
    <!-- Login redirect removed for dashboard access -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Daily Takings | None Go Bye</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Only summary styles needed */
  </style>
</head>
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <header>
    <h1 class="main-heading underline">Admin  Daily Takings</h1>
    <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
      <a href="admin-menu.html">Menu Editor</a>
      <a href="stock-management.html">Stock Management</a>
      <a href="timeslots.html">Time Slots</a>
      <a href="orders.html">Orders</a>
      <a href="running-orders.html">Running Orders</a>
      <a href="takings.html" class="active">Takings</a>
      <a href="pos.html">POS Manual Order</a>
      <a href="offers.html">Special Offers</a>
      
    </nav>
  </header>
  <main>
    <main id="main-content">
    <section class="admin-section summary-section">
      <div class="takings-row">
        <button id="prev-day-btn">&#8592; Previous</button>
        <input type="date" id="takings-date-picker" class="takings-date-picker" title="Select date">
        <button id="next-day-btn">Next &#8594;</button>
      </div>
      <div id="running-totals" class="takings-running-totals"></div>
      <h2>Summary for <span id="summary-date"></span></h2>
      <div id="takings-summary" class="takings-summary"></div>
    </section>
  </main>
  <script>
    function formatDateInput(date) {
      return date.toISOString().slice(0, 10);
    }
    function formatMoney(val) {
      return Number(val).toFixed(2);
    }
    function getMonday(d) {
      d = new Date(d);
      var day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setHours(0,0,0,0), d.setDate(diff));
    }
    function getLastSundayOfMonth(date) {
      let d = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      while (d.getDay() !== 0) d.setDate(d.getDate() - 1);
      d.setHours(23,59,59,999);
      return d;
    }
    async function fetchTakings(selectedDate) {
      document.getElementById('summary-date').textContent = selectedDate;
      // Try to fetch archived takings first
      try {
        const res = await fetch(`/api/takings-history?date=${selectedDate}`, { credentials: 'include' });
        if (res.ok) {
          const history = await res.json();
          if (history && history.takings) {
            const { total, card, cash, refund } = history.takings;
            document.getElementById('takings-summary').innerHTML = `
              <b>Total Taken:</b> £${formatMoney(total)}<br>
              <b>Card:</b> £${formatMoney(card)}<br>
              <b>Cash:</b> £${formatMoney(cash)}<br>
              <b>Refunded:</b> £${formatMoney(refund)}<br>
            `;
            document.getElementById('running-totals').innerHTML = '';
            return;
          }
        }
      } catch (err) {}
      // If no archive, fallback to live orders
      // ...existing code...
    }
    // Date picker and navigation logic
    const dateInput = document.getElementById('takings-date-picker');
    const prevBtn = document.getElementById('prev-day-btn');
    const nextBtn = document.getElementById('next-day-btn');
    function setDateAndFetch(dateObj) {
      const dateStr = formatDateInput(dateObj);
      dateInput.value = dateStr;
      fetchTakings(dateStr);
    }
    // Set default to today
    const today = new Date();
    setDateAndFetch(today);
    dateInput.addEventListener('change', () => {
      fetchTakings(dateInput.value);
    });
    prevBtn.addEventListener('click', () => {
      const d = new Date(dateInput.value);
      d.setDate(d.getDate() - 1);
      setDateAndFetch(d);
    });
    nextBtn.addEventListener('click', () => {
      const d = new Date(dateInput.value);
      d.setDate(d.getDate() + 1);
      setDateAndFetch(d);
    });
    // Login/session check
    fetch('/api/admin/check', { credentials: 'include' })
      .then(r => {
        if (!r.ok) window.location.href = 'login.html';
      });
    // --- Lock Page Logic ---
    function lockAdminPage() {
      fetch('/api/admin/lock', { method: 'POST', credentials: 'include' })
        .then(r => {
          if (r.ok) {
            alert('Page locked. You will not be logged out automatically.');
          } else {
            alert('Failed to lock page.');
          }
        });
    }
  </script>
  <button id="lock-page-btn" class="float-right mt-8" onclick="lockAdminPage()">Lock this page</button>
</body>
</html>