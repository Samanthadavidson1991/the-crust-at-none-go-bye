<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>None Go Bye â€“ Menu</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="menu-page app-body" id="menu-page">
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <div id="cart-badge" class="cart-badge d-none">
    <button id="cart-badge-btn" class="cart-badge-btn" aria-label="View checkout cart" tabindex="0" style="background:none;border:none;cursor:pointer;font:inherit;color:inherit;">
      ðŸ›’ <span id="cart-count">0</span> in checkout
    </button>
  </div>
  <header>
  <h1 class="main-heading underline">Inspired by Naples, perfected at None Go Bye.</h1>
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
      <a href="index.html">Home</a>
      <a href="menu.html">Menu</a>
      <a href="checkout.html">Checkout</a>
      <a href="allergens.html">Allergens</a>
    </nav>
  </header>
  <main>
    <main id="main-content">
    <div id="special-offers-banner" style="display:none;margin-bottom:24px;"></div>
    <section id="dynamic-menu">
      <div id="menu-content" class="d-none"></div>
    </section>
    <script>
      // --- Dough Stock Logic ---
      let doughStock = null;
      let gfDoughStock = null;
      async function fetchDoughStocks() {
        try {
          const [doughRes, gfRes] = await Promise.all([
            fetch('https://admin.thecrustatngb.co.uk/api/dough-stock'),
            fetch('https://admin.thecrustatngb.co.uk/api/gf-dough-stock')
          ]);
          doughStock = (await doughRes.json()).stock;
          gfDoughStock = (await gfRes.json()).stock;
        } catch {
          doughStock = null;
          gfDoughStock = null;
        }
      }
      function updateCartBadge() {
        const order = JSON.parse(localStorage.getItem('order') || '[]');
        const count = order.reduce((sum, item) => sum + (item.quantity || 1), 0);
        const badge = document.getElementById('cart-badge');
        document.getElementById('cart-count').textContent = count;
        badge.style.display = count > 0 ? 'block' : 'none';
      }

      document.addEventListener('DOMContentLoaded', function() {
        updateCartBadge();
        const badgeBtn = document.getElementById('cart-badge-btn');
        if (badgeBtn) {
          badgeBtn.onclick = function() {
            window.location.href = 'checkout.html';
          };
          badgeBtn.onkeydown = function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              window.location.href = 'checkout.html';
            }
          };
        }
      });


      async function fetchSpecialOffers() {
        try {
          const res = await fetch('/api/offers');
          if (!res.ok) throw new Error('Offers fetch failed');
          const offers = await res.json();
          const banner = document.getElementById('special-offers-banner');
          if (offers.length) {
            banner.style.display = 'block';
            banner.innerHTML = offers.map(offer =>
              `<div class='special-offer' style='background:#ffe9b3;border-radius:8px;padding:12px 18px;margin-bottom:8px;font-size:1.15em;box-shadow:0 2px 8px #0001;'>
                <b>Special Offer:</b> ${offer.title} - ${offer.desc}${offer.code ? ' <b>['+offer.code+']</b>' : ''}${offer.discount ? ' <span style=\'color:#b9472e\'>(' + offer.discount + ' off)</span>' : ''}
              </div>`
            ).join('');
          } else {
            banner.style.display = 'none';
            banner.innerHTML = '';
          }
        } catch {
          // Hide banner on error
          const banner = document.getElementById('special-offers-banner');
          banner.style.display = 'none';
          banner.innerHTML = '';
        }
      }

      async function fetchMenu() {
        // Fetch menu, toppings, and dough stocks in parallel
        fetchSpecialOffers();
        try {
          const [menuRes, toppingsRes] = await Promise.all([
            fetch('/api/menu'),
            fetch('/api/pizza-topping-stock')
          ]);
          if (!menuRes.ok) throw new Error('Menu fetch failed');
          if (!toppingsRes.ok) throw new Error('Toppings fetch failed');
          const menu = await menuRes.json();
          const masterToppings = await toppingsRes.json();
          await fetchDoughStocks();
          renderMenu(menu, masterToppings);
        } catch (err) {
          const content = document.getElementById('menu-content');
          content.style.display = 'block';
          content.innerHTML = '<em style="color:red">Failed to load menu or toppings. Please try again later.</em>';
        }
      }

      function renderMenu(menu, masterToppings) {
        const content = document.getElementById('menu-content');
        if (!menu || !Array.isArray(menu) || menu.length === 0) {
          content.innerHTML = '<em>No menu items found.</em>';
          return;
        }
        content.style.display = 'block';
        // Group by category
        const categories = {};
        menu.forEach(item => {
          const cat = item.category || 'Other';
          if (!categories[cat]) categories[cat] = [];
          categories[cat].push(item);
        });
        let html = '';
        Object.keys(categories).forEach(cat => {
          html += `<h2>${cat}</h2><ul class='menu-card-list'>`;
          categories[cat].forEach(item => {
            // Determine if this item is dough-tracked or gf-dough-tracked
            const isDoughTracked = !!item.doughTracked;
            const isGFDoughTracked = !!item.gfDoughTracked;
            let outOfStock = false;
            if (isDoughTracked && (doughStock !== null && doughStock <= 0)) outOfStock = true;
            if (isGFDoughTracked && (gfDoughStock !== null && gfDoughStock <= 0)) outOfStock = true;
            html += `<li class='menu-item-card${outOfStock ? ' out-of-stock' : ''}' data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}'><b>${item.name}</b><br>${item.description ? item.description + '<br>' : ''}`;
            // Pizza: show sizes/prices
            if(cat === 'Pizza' && item.sizes && Array.isArray(item.sizes) && item.sizes.length) {
              html += '<ul style="list-style:none;padding:0;">';
              item.sizes.forEach(size => {
                html += `<li class='menu-size-option' style="cursor:pointer;${outOfStock ? 'opacity:0.5;pointer-events:none;' : ''}" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-size='${JSON.stringify(size).replace(/'/g, "&apos;")}'><span>${size.name}: <span class='price'>Â£${parseFloat(size.price).toFixed(2)}</span></span></li>`;
              });
              html += '</ul>';
              // Toppings UI
              html += `<form class='toppings-form' data-name='${item.name}'>`;
              if(item.toppings && Array.isArray(item.toppings) && item.toppings.length) {
                html += `<small><b>Remove Toppings:</b></small><br>`;
                item.toppings.forEach(topping => {
                  html += `<label style='margin-right:8px'><input type='checkbox' class='remove-topping' value='${topping}' checked> ${topping}</label>`;
                });
              }
              // Add Extra Toppings: all master toppings (not already on pizza)
              html += `<br><small><b>Add Extra Toppings:</b></small><br>`;
              masterToppings.forEach(mt => {
                let price = mt.price !== undefined ? parseFloat(mt.price).toFixed(2) : '0.00';
                // Show all master toppings, but disable if already on pizza
                const alreadyOnPizza = item.toppings && item.toppings.includes(mt.topping);
                html += `<label style='margin-right:8px'><input type='checkbox' class='add-topping' value='${mt.topping}' data-price='${price}'` + (alreadyOnPizza ? ' disabled' : '') + `> ${mt.topping}`;
                html += ` <span style='font-size:0.9em;color:#888'>(${mt.type ? mt.type.charAt(0).toUpperCase() + mt.type.slice(1) : 'Other'} â€¢ Â£${price})</span>`;
                html += `</label>`;
              });
              html += `</form>`;
            } else if(cat === 'Sides' && item.sideOptions && Array.isArray(item.sideOptions) && item.sideOptions.length) {
              html += '<ul style="list-style:none;padding:0;">';
              item.sideOptions.forEach(opt => {
                html += `<li class='menu-side-option' style="cursor:pointer;${outOfStock ? 'opacity:0.5;pointer-events:none;' : ''}" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-side='${JSON.stringify(opt).replace(/'/g, "&apos;")}'><span>${opt.name}: <span class='price'>Â£${parseFloat(opt.price).toFixed(2)}</span></span></li>`;
              });
              html += '</ul>';
            } else {
              html += `<span class='price'>Â£${parseFloat(item.price).toFixed(2)}</span>`;
            }
            if (outOfStock) {
              html += `<div class='out-of-stock-label' style='color:#b9472e;font-weight:bold;margin-top:8px;'>Out of stock</div>`;
            }
            html += `</li>`;
          });
          html += '</ul>';
        });
        content.innerHTML = html;

        updateCartBadge();

        // Only allow add-to-order via size/side/gluten free options, but skip if out of stock
        document.querySelectorAll('.menu-size-option').forEach(opt => {
          if (opt.style.pointerEvents === 'none') return;
          opt.addEventListener('click', function(e) {
            const item = JSON.parse(opt.getAttribute('data-item').replace(/&apos;/g, "'"));
            const size = JSON.parse(opt.getAttribute('data-size').replace(/&apos;/g, "'"));
            // Find the toppings form for this item
            let removed = [];
            let extraToppings = [];
            let extraToppingPrices = [];
            // Find the toppings form by traversing up to the .menu-item-card
            let menuItemCard = opt.closest('.menu-item-card');
            const form = menuItemCard ? menuItemCard.querySelector('.toppings-form') : null;
            if (form) {
              const addToppingCbs = Array.from(form.querySelectorAll('.add-topping'));
              // Removed: unchecked remove-topping
              removed = Array.from(form.querySelectorAll('.remove-topping')).filter(cb => !cb.checked).map(cb => cb.value);
              // Added: checked add-topping (all master toppings)
              addToppingCbs.forEach(cb => {
                if (cb.checked && !cb.disabled) {
                  extraToppings.push(cb.value);
                  extraToppingPrices.push(parseFloat(cb.getAttribute('data-price')) || 0);
                }
              });
            }
            // Combine default toppings (minus removed) and extra toppings
            let baseToppings = Array.isArray(item.toppings) ? item.toppings.filter(t => !removed.includes(t)) : [];
            let allToppings = baseToppings.concat(extraToppings);
            // If no default toppings, still allow extras
            if (!Array.isArray(item.toppings) || item.toppings.length === 0) {
              allToppings = extraToppings;
            }
            // Calculate total price (size + extra toppings)
            let totalPrice = parseFloat(size.price) || 0;
            extraToppingPrices.forEach(p => { totalPrice += p; });
            const orderObj = { ...item, selectedSize: size, price: totalPrice, quantity: 1, toppings: allToppings, removed };
            addToOrder(orderObj);
            // Reset the toppings form after adding to order
            if (form) {
              // Reset remove-topping checkboxes to checked
              Array.from(form.querySelectorAll('.remove-topping')).forEach(cb => { cb.checked = true; });
              // Reset add-topping checkboxes to unchecked
              Array.from(form.querySelectorAll('.add-topping')).forEach(cb => { cb.checked = false; });
            }
            opt.style.background = '#e9ece5';
            setTimeout(() => { opt.style.background = ''; }, 300);
            e.stopPropagation();
          });
        });
        document.querySelectorAll('.menu-side-option').forEach(opt => {
          if (opt.style.pointerEvents === 'none') return;
          opt.addEventListener('click', function(e) {
            const item = JSON.parse(opt.getAttribute('data-item').replace(/&apos;/g, "'"));
            const side = JSON.parse(opt.getAttribute('data-side').replace(/&apos;/g, "'"));
            addToOrder({ ...item, selectedSide: side, price: side.price, quantity: 1 });
            opt.style.background = '#e9ece5';
            setTimeout(() => { opt.style.background = ''; }, 300);
            e.stopPropagation();
          });
        });
      }

      function addToOrder(item) {
        let order = JSON.parse(localStorage.getItem('order') || '[]');
        // Try to merge with existing (same name/size/side)
        const matchIdx = order.findIndex(i => i.name === item.name && JSON.stringify(i.selectedSize) === JSON.stringify(item.selectedSize) && JSON.stringify(i.selectedSide) === JSON.stringify(item.selectedSide));
        if (matchIdx > -1) {
          order[matchIdx].quantity += 1;
        } else {
          order.push(item);
        }
        localStorage.setItem('order', JSON.stringify(order));
  updateCartBadge();
      }
      fetchMenu();
      // Add out-of-stock style
      const style = document.createElement('style');
      style.textContent = `.menu-item-card.out-of-stock { opacity: 0.5; pointer-events: none; position: relative; } .out-of-stock-label { color: #b9472e; font-weight: bold; font-size: 1.1em; }`;
      document.head.appendChild(style);
    </script>
</body>
</html>