<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>None Go Bye â€“ Menu</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body class="menu-page app-body" id="menu-page">
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <div id="cart-badge" class="cart-badge d-none">
    <button id="cart-badge-btn" class="cart-badge-btn no-style-btn" aria-label="View checkout cart" tabindex="0">
      ðŸ›’ <span id="cart-count">0</span> in checkout
    </button>
  </div>
  <header>
    <h1 class="main-heading underline">Inspired by Naples, perfected at None Go Bye.</h1>
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
      <a href="index.html">Home</a>
      <a href="menu.html">Menu</a>
      <a href="checkout.html">Checkout</a>
      <a href="offers-customer.html">Special Offers</a>
      <a href="allergens.html">Allergens</a>
    </nav>
  </header>
  <main id="main-content">
    <div id="special-offers-banner" class="special-offers-banner"></div>
    <div id="selected-offer-banner" class="selected-offer-banner"></div>
    <section id="dynamic-menu">
      <div id="menu-content" class="d-none"></div>
    </section>
  </main>
  <script>
  // --- Add updateCartBadge stub ---
  function updateCartBadge() {
    // TODO: Implement cart badge update logic
    // For now, this is a no-op to prevent errors
  }
  // --- Restore renderMenu function ---
  function renderMenu(menuData, sectionsData, masterToppingsData, sectionAssignmentsData, doughStock, gfDoughStock) {
    const masterToppings = masterToppingsData.toppings || [];
    const content = document.getElementById('menu-content');
    if (!menuData.items || !Array.isArray(menuData.items) || menuData.items.length === 0) {
      content.innerHTML = '<em>No menu items found.</em>';
      return;
    }
    content.style.display = 'block';
    // Group items by section name
    const sectionMap = {};
    menuData.items.forEach(item => {
      const section = item.section || 'Other';
      if (!sectionMap[section]) sectionMap[section] = [];
      sectionMap[section].push(item);
    });
    let html = '';
    // Render sections in DB order, then any extra sections
    sectionsData.sections.forEach(sec => {
      const sectionName = sec.name;
      if (sectionMap[sectionName]) {
        html += `<h2>${sectionName}</h2>`;
        html += `<ul class='menu-card-list'>`;
        sectionMap[sectionName].forEach(item => {
          const isDoughTracked = !!item.doughTracked;
          const isGFDoughTracked = !!item.gfDoughTracked;
          let outOfStock = false;
          if (isDoughTracked && (doughStock !== null && doughStock <= 0)) outOfStock = true;
          if (isGFDoughTracked && (gfDoughStock !== null && gfDoughStock <= 0)) outOfStock = true;
          html += `<li class='menu-item-card'><b>${item.name}</b><br>${item.description ? item.description + '<br>' : ''}`;
          if(item.sizes && Array.isArray(item.sizes) && item.sizes.length) {
            html += '<ul class="menu-size-list">';
            item.sizes.forEach(size => {
              html += `<li class="menu-size-list-item">
                <button type="button" class="menu-size-option" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-size='${JSON.stringify(size).replace(/'/g, "&apos;")}' >
                  <span class="menu-size-name">${size.name}</span>: <span class='price'>Â£${parseFloat(size.price).toFixed(2)}</span>
                </button>
              </li>`;
            });
            html += '</ul>';
            // Add a button to add without selecting a size
            if (typeof item.price === 'number') {
              html += `<button type="button" class="menu-direct-add" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-price='${item.price.toFixed(2)}'>Add to order (no size)</button>`;
            }
          } else if (typeof item.price === 'number') {
            html += `<div class="menu-direct-price">Price: <span class='price'>Â£${item.price.toFixed(2)}</span></div>`;
            html += `<button type="button" class="menu-direct-add" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-price='${item.price.toFixed(2)}'>Add to order</button>`;
          }
              // Add event listeners for direct price items
              document.querySelectorAll('.menu-direct-add').forEach(btn => {
                btn.addEventListener('click', function(e) {
                  const item = JSON.parse(btn.getAttribute('data-item').replace(/&apos;/g, "'"));
                  const price = parseFloat(btn.getAttribute('data-price'));
                  // If the button is for 'no size', do not set selectedSize
                  addToOrder({ ...item, price, quantity: 1 });
                  btn.style.background = '#e9ece5';
                  setTimeout(() => { btn.style.background = ''; }, 300);
                  e.stopPropagation();
                });
              });
          // --- Toppings UI ---
          // Pizza-specific toppings (from admin)
          if (item.toppings && Array.isArray(item.toppings) && item.toppings.length) {
            html += `<form class='toppings-form' data-name='${item.name}'>`;
            html += `<small><b>Remove Toppings:</b></small><br>`;
            item.toppings.forEach(topping => {
              html += `<label class="topping-label"><input type='checkbox' class='pizza-topping' value='${topping}' checked> ${topping}</label>`;
            });
            html += `</form>`;
          }
          // Master toppings (if allowed for this item)
          if (item.allowMasterToppings) {
            if (masterToppings.length > 0) {
              html += `<form class='toppings-form' data-name='${item.name}-master'>`;
              html += `<small><b>Add Master Toppings:</b></small><br>`;
              masterToppings.forEach(mt => {
                let price = '0.00';
                if (mt.category === 'Meat') price = masterToppingsData.settings.masterMeatPrice?.toFixed(2) || '0.00';
                else if (mt.category === 'Veg') price = masterToppingsData.settings.masterVegPrice?.toFixed(2) || '0.00';
                else if (typeof mt.price === 'number') price = mt.price.toFixed(2);
                html += `<label class="topping-label"><input type='checkbox' class='add-topping' value='${mt.name}' data-price='${price}'> ${mt.name}`;
                html += ` <span class="topping-meta">(${mt.category} â€¢ Â£${price})</span>`;
                html += `</label>`;
              });
              html += `</form>`;
            }
          }
          if (outOfStock) {
            html += `<div class='out-of-stock-label'>Out of stock</div>`;
            html += `<div class='out-of-stock-label'>Out of stock</div>`;
          }
          html += `</li>`;
        });
        html += '</ul>';
      }
    });
    // Render any sections not in DB (fallback)
    Object.keys(sectionMap).forEach(section => {
      if (!sectionsData.sections.find(sec => sec.name === section)) {
        html += `<h2>${section}</h2>`;
        html += `<ul class='menu-card-list'>`;
        sectionMap[section].forEach(item => {
          const isDoughTracked = !!item.doughTracked;
          const isGFDoughTracked = !!item.gfDoughTracked;
          let outOfStock = false;
          if (isDoughTracked && (doughStock !== null && doughStock <= 0)) outOfStock = true;
          if (isGFDoughTracked && (gfDoughStock !== null && gfDoughStock <= 0)) outOfStock = true;
          html += `<li class='menu-item-card'><b>${item.name}</b><br>${item.description ? item.description + '<br>' : ''}`;
          if(item.sizes && Array.isArray(item.sizes) && item.sizes.length) {
            html += '<ul class="menu-size-list">';
            item.sizes.forEach(size => {
              html += `<li class="menu-size-list-item">
                <button type="button" class="menu-size-option" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-size='${JSON.stringify(size).replace(/'/g, "&apos;")}' >
                  <span class="menu-size-name">${size.name}</span>: <span class='price'>Â£${parseFloat(size.price).toFixed(2)}</span>
                </button>
              </li>`;
            });
            html += '</ul>';
          }
          // Section-based toppings assignment for fallback sections
          const assignedToppingIds = (sectionAssignmentsData.assignments && sectionAssignmentsData.assignments[section]) || [];
          const assignedToppings = masterToppings.filter(mt => assignedToppingIds.includes(mt._id));
          if (assignedToppings.length > 0) {
            html += `<form class='toppings-form' data-name='${item.name}'>`;
            html += `<small><b>Add Toppings:</b></small><br>`;
            assignedToppings.forEach(mt => {
              let price = '0.00';
              if (mt.category === 'Meat') price = masterToppingsData.settings.masterMeatPrice?.toFixed(2) || '0.00';
              else if (mt.category === 'Veg') price = masterToppingsData.settings.masterVegPrice?.toFixed(2) || '0.00';
              else if (typeof mt.price === 'number') price = mt.price.toFixed(2);
              html += `<label class="topping-label"><input type='checkbox' class='add-topping' value='${mt.name}' data-price='${price}'> ${mt.name}`;
              html += ` <span class="topping-meta">(${mt.category} â€¢ Â£${price})</span>`;
              html += `</label>`;
            });
            html += `</form>`;
          }
          if (outOfStock) {
            html += `<div class='out-of-stock-label'>Out of stock</div>`;
            html += `<div class='out-of-stock-label'>Out of stock</div>`;
          }
          html += `</li>`;
        });
        html += '</ul>';
      }
    });
    content.innerHTML = html;
    updateCartBadge();
    // Add event listeners for menu actions (add to order, etc.)
    document.querySelectorAll('.menu-size-option').forEach(opt => {
      if (opt.style.pointerEvents === 'none') return;
      opt.addEventListener('click', function(e) {
        const item = JSON.parse(opt.getAttribute('data-item').replace(/&apos;/g, "'"));
        let size = null;
        try {
          size = JSON.parse(opt.getAttribute('data-size').replace(/&apos;/g, "'"));
        } catch (err) {
          size = opt.getAttribute('data-size');
        }
        // Find the toppings form for this item
        let extraToppings = [];
        let extraToppingPrices = [];
        let menuItemCard = opt.closest('.menu-item-card');
        const form = menuItemCard ? menuItemCard.querySelector('.toppings-form') : null;
        if (form) {
          const addToppingCbs = Array.from(form.querySelectorAll('.add-topping'));
          addToppingCbs.forEach(cb => {
            if (cb.checked && !cb.disabled) {
              extraToppings.push(cb.value);
              extraToppingPrices.push(parseFloat(cb.getAttribute('data-price')) || 0);
            }
          });
        }
        // Calculate total price (size + extra toppings)
        let totalPrice = parseFloat(size.price) || 0;
        extraToppingPrices.forEach(p => { totalPrice += p; });
        const orderObj = { ...item, selectedSize: size, price: totalPrice, quantity: 1, toppings: extraToppings };
        addToOrder(orderObj);
        // Reset add-topping checkboxes to unchecked
        if (form) {
          Array.from(form.querySelectorAll('.add-topping')).forEach(cb => { cb.checked = false; });
        }
        opt.style.background = '#e9ece5';
        setTimeout(() => { opt.style.background = ''; }, 300);
        e.stopPropagation();
      });
    });
    document.querySelectorAll('.menu-side-option').forEach(opt => {
      if (opt.style.pointerEvents === 'none') return;
      opt.addEventListener('click', function(e) {
        const item = JSON.parse(opt.getAttribute('data-item').replace(/&apos;/g, "'"));
        const side = JSON.parse(opt.getAttribute('data-side').replace(/&apos;/g, "'"));
        addToOrder({ ...item, selectedSide: side, price: side.price, quantity: 1 });
        opt.style.background = '#e9ece5';
        setTimeout(() => { opt.style.background = ''; }, 300);
        e.stopPropagation();
      });
    });
    // Make all other menu-item-cards clickable (desserts, drinks, etc.)
    document.querySelectorAll('.menu-item-card').forEach(card => {
      if (card.querySelector('.menu-size-option') || card.querySelector('.menu-side-option')) return;
      if (card.classList.contains('out-of-stock')) return;
      card.style.cursor = 'pointer';
      card.addEventListener('click', function(e) {
        const item = JSON.parse(card.getAttribute('data-item') ? card.getAttribute('data-item').replace(/&apos;/g, "'") : '{}');
        let price = parseFloat(item.price);
        if (isNaN(price)) price = 0;
        addToOrder({ ...item, price, quantity: 1 });
        card.style.background = '#e9ece5';
        setTimeout(() => { card.style.background = ''; }, 300);
        e.stopPropagation();
      });
    });
  }

  // --- End renderMenu function ---
  console.log("menu script loaded");
  document.addEventListener('DOMContentLoaded', async function() {
    console.log("DOMContentLoaded fired");
    console.log("Fetching menu data...");
    try {
      const [menuRes, sectionsRes, masterToppingsRes, sectionAssignmentsRes] = await Promise.all([
        fetch('/api/menu'),
        fetch('/api/sections'),
        fetch('/api/master-toppings'),
        fetch('/api/section-topping-assignments')
      ]);
      const menuData = await menuRes.json();
      const sectionsData = await sectionsRes.json();
      const masterToppingsData = await masterToppingsRes.json();
      const sectionAssignmentsData = await sectionAssignmentsRes.json();
      const doughStock = null;
      const gfDoughStock = null;
      console.log("Menu data:", menuData);
      renderMenu(menuData, sectionsData, masterToppingsData, sectionAssignmentsData, doughStock, gfDoughStock);
      const menuContent = document.getElementById('menu-content');
      if (menuContent) menuContent.classList.remove('d-none');
    } catch (err) {
      const menuContent = document.getElementById('menu-content');
      if (menuContent) {
        menuContent.innerHTML = '<span style="color:red">Failed to load menu. Please try again later.</span>';
        menuContent.classList.remove('d-none');
      }
      console.error('Menu load error:', err);
    }
  });
  </script>
</body>
</html>