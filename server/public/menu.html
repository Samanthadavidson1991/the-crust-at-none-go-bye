<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>None Go Bye â€“ Menu</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body class="menu-page app-body" id="menu-page">
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <div id="cart-badge" class="cart-badge d-none">
    <button id="cart-badge-btn" class="cart-badge-btn no-style-btn" aria-label="View checkout cart" tabindex="0">
      ðŸ›’ <span id="cart-count">0</span> in checkout
    </button>
  </div>
  <header>
    <h1 class="main-heading underline">Inspired by Naples, perfected at None Go Bye.</h1>
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
      <a href="index.html">Home</a>
      <a href="menu.html">Menu</a>
      <a href="checkout.html">Checkout</a>
      <a href="offers-customer.html">Special Offers</a>
      <a href="allergens.html">Allergens</a>
    </nav>
  </header>
  <main id="main-content">
    <div id="special-offers-banner" class="special-offers-banner"></div>
    <div id="selected-offer-banner" class="selected-offer-banner"></div>
    <section id="dynamic-menu">
      <div id="menu-content" class="d-none"></div>
    </section>
  </main>
  <script>
  // --- Add updateCartBadge stub ---
  document.addEventListener('DOMContentLoaded', function() {
    const cartBadgeBtn = document.getElementById('cart-badge-btn');
    if (cartBadgeBtn) {
      cartBadgeBtn.addEventListener('click', function() {
        window.location.href = 'checkout.html';
      });
    }
  });
  function updateCartBadge() {
    // Update the cart badge count from localStorage
    const cart = JSON.parse(localStorage.getItem('order') || '[]');
    const count = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
    const badge = document.getElementById('cart-badge');
    const countSpan = document.getElementById('cart-count');
    if (count > 0) {
      badge.classList.remove('d-none');
      countSpan.textContent = count;
    } else {
      badge.classList.add('d-none');
      countSpan.textContent = '0';
    }
  }

  // --- Add addToOrder implementation ---
  function addToOrder(item) {
    // Only add items with a valid name
    if (!item.name || typeof item.name !== 'string' || !item.name.trim()) {
      console.warn('Attempted to add item with missing or empty name:', item);
      return;
    }
    let order = JSON.parse(localStorage.getItem('order') || '[]');
    // Try to find a matching item (by name and selectedSize if present)
    let matchIdx = order.findIndex(i => i.name === item.name && JSON.stringify(i.selectedSize) === JSON.stringify(item.selectedSize) && JSON.stringify(i.masterToppings) === JSON.stringify(item.masterToppings));
    if (matchIdx > -1) {
      order[matchIdx].quantity = (order[matchIdx].quantity || 1) + (item.quantity || 1);
    } else {
      order.push(item);
    }
    localStorage.setItem('order', JSON.stringify(order));
    updateCartBadge();
    // Show a quick summary of added toppings (if any)
    if (item.masterToppings && item.masterToppings.length) {
      const msg = document.createElement('div');
      msg.className = 'toppings-added-msg';
      msg.innerHTML = `Added: <b>${item.name}</b>${item.selectedSize ? ' [' + item.selectedSize.name + ']' : ''}<br>with toppings: <span class='toppings-list-inline'>${item.masterToppings.join(', ')}</span>`;
      document.body.appendChild(msg);
      setTimeout(() => { msg.remove(); }, 2500);
    }
  }
  // --- Restore renderMenu function ---
  function renderMenu(menuData, sectionsData, masterToppingsData, sectionAssignmentsData, doughStock, gfDoughStock) {
    const masterToppings = masterToppingsData.toppings || [];
    const content = document.getElementById('menu-content');
    if (!menuData.items || !Array.isArray(menuData.items) || menuData.items.length === 0) {
      content.innerHTML = '<em>No menu items found.</em>';
      return;
    }
    content.style.display = 'block';
    // Group items by section name
    const sectionMap = {};
    menuData.items.forEach(item => {
      const section = item.section || 'Other';
      if (!sectionMap[section]) sectionMap[section] = [];
      sectionMap[section].push(item);
    });
    let html = '';
    // Render sections in DB order, then any extra sections
    sectionsData.sections.forEach(sec => {
      const sectionName = sec.name;
      if (sectionMap[sectionName]) {
        html += `<h2>${sectionName}</h2>`;
        html += `<ul class='menu-card-list'>`;
        sectionMap[sectionName].forEach(item => {
          const isDoughTracked = !!item.doughTracked;
          const isGFDoughTracked = !!item.gfDoughTracked;
          let outOfStock = false;
          if (isDoughTracked && (doughStock !== null && doughStock <= 0)) outOfStock = true;
          if (isGFDoughTracked && (gfDoughStock !== null && gfDoughStock <= 0)) outOfStock = true;
          // Always set data-item attribute with at least name and price for all menu cards
          const dataItemAttr = `data-item='${JSON.stringify({ name: item.name, price: item.price }).replace(/'/g, "&apos;")}'`;
          html += `<li class='menu-item-card' ${dataItemAttr}><b>${item.name}</b><br>${item.description ? item.description + '<br>' : ''}`;
          if(item.sizes && Array.isArray(item.sizes) && item.sizes.length) {
            html += '<ul class="menu-size-list">';
            item.sizes.forEach(size => {
              html += `<li class="menu-size-list-item">
                <button type="button" class="menu-size-option" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-size='${JSON.stringify(size).replace(/'/g, "&apos;")}' >
                  <span class="menu-size-name">${size.name}</span>: <span class='price'>Â£${parseFloat(size.price).toFixed(2)}</span>
                </button>`;
              if (item.allowMasterToppings && masterToppings.length > 0) {
                html += `<button type="button" class="show-master-toppings-popup add-toppings-btn" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-size='${JSON.stringify(size).replace(/'/g, "&apos;")}' >Add Toppings</button>`;
              }
              html += '</li>';
            });
            html += '</ul>';
          }
          if (typeof item.price === 'number' && (!item.sizes || !item.sizes.length)) {
            html += `<div class="menu-direct-price">Price: <span class='price'>Â£${item.price.toFixed(2)}</span></div>`;
            html += `<button type="button" class="menu-direct-add add-toppings-btn" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-price='${item.price.toFixed(2)}'>Add to Cart</button>`;
          }
          // Always show Add Toppings button for items with allowMasterToppings
          if (item.allowMasterToppings && masterToppings.length > 0 && (!item.sizes || !item.sizes.length)) {
            html += `<button type="button" class="show-master-toppings-popup add-toppings-btn" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' >Add Toppings</button>`;
          }
              // Add event listeners for direct price items
              document.querySelectorAll('.menu-direct-add').forEach(btn => {
                btn.addEventListener('click', function(e) {
                  const item = JSON.parse(btn.getAttribute('data-item').replace(/&apos;/g, "'"));
                  const price = parseFloat(btn.getAttribute('data-price'));
                  // Always ensure name is present for direct price items
                  if (!item.name || typeof item.name !== 'string' || !item.name.trim()) {
                    alert('Error: This menu item is missing a name and cannot be added.');
                    return;
                  }
                  addToOrder({ ...item, price, quantity: 1 });
                  btn.style.background = '#e9ece5';
                  setTimeout(() => { btn.style.background = ''; }, 300);
                  e.stopPropagation();
                });
              });
          // --- Toppings UI ---
          // Pizza-specific toppings (from admin)
          if (item.toppings && Array.isArray(item.toppings) && item.toppings.length) {
            html += `<form class='toppings-form' data-name='${item.name}'>`;
            html += `<small><b>Remove Toppings:</b></small><br>`;
            item.toppings.forEach(topping => {
              html += `<label class="topping-label"><input type='checkbox' class='pizza-topping' value='${topping}' checked> ${topping}</label>`;
            });
            html += `</form>`;
          }
          // (No duplicate Add Toppings button here)
          if (outOfStock) {
            html += `<div class='out-of-stock-label'>Out of stock</div>`;
            html += `<div class='out-of-stock-label'>Out of stock</div>`;
          }
          html += `</li>`;
        });
        html += '</ul>';
      }
    });
    // Render any sections not in DB (fallback)
    Object.keys(sectionMap).forEach(section => {
      if (!sectionsData.sections.find(sec => sec.name === section)) {
        html += `<h2>${section}</h2>`;
        html += `<ul class='menu-card-list'>`;
        sectionMap[section].forEach(item => {
          const isDoughTracked = !!item.doughTracked;
          const isGFDoughTracked = !!item.gfDoughTracked;
          let outOfStock = false;
          if (isDoughTracked && (doughStock !== null && doughStock <= 0)) outOfStock = true;
          if (isGFDoughTracked && (gfDoughStock !== null && gfDoughStock <= 0)) outOfStock = true;
          // Always set data-item attribute with at least name and price for fallback/other sections
          const dataItemAttr = `data-item='${JSON.stringify({ name: item.name, price: item.price }).replace(/'/g, "&apos;")}'`;
          html += `<li class='menu-item-card' ${dataItemAttr}><b>${item.name}</b><br>${item.description ? item.description + '<br>' : ''}`;
          if(item.sizes && Array.isArray(item.sizes) && item.sizes.length) {
            html += '<ul class="menu-size-list">';
            item.sizes.forEach(size => {
              html += `<li class="menu-size-list-item">
                <button type="button" class="menu-size-option" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-size='${JSON.stringify(size).replace(/'/g, "&apos;")}' >
                  <span class="menu-size-name">${size.name}</span>: <span class='price'>Â£${parseFloat(size.price).toFixed(2)}</span>
                </button>`;
              // Add toppings button for sizes in fallback sections
              if (item.allowMasterToppings && masterToppings.length > 0) {
                html += `<button type="button" class="show-master-toppings-popup" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-size='${JSON.stringify(size).replace(/'/g, "&apos;")}' >Add Toppings</button>`;
              }
              html += '</li>';
            });
            html += '</ul>';
          }
          // Section-based toppings assignment for fallback sections
          const assignedToppingIds = (sectionAssignmentsData.assignments && sectionAssignmentsData.assignments[section]) || [];
          const assignedToppings = masterToppings.filter(mt => assignedToppingIds.includes(mt._id));
          if (assignedToppings.length > 0) {
            html += `<form class='toppings-form' data-name='${item.name}'>`;
            html += `<small><b>Add Toppings:</b></small><br>`;
            assignedToppings.forEach(mt => {
              let price = '0.00';
              if (mt.category === 'Meat') price = masterToppingsData.settings.masterMeatPrice?.toFixed(2) || '0.00';
              else if (mt.category === 'Veg') price = masterToppingsData.settings.masterVegPrice?.toFixed(2) || '0.00';
              else if (typeof mt.price === 'number') price = mt.price.toFixed(2);
              html += `<label class="topping-label"><input type='checkbox' class='add-topping' value='${mt.name}' data-price='${price}'> ${mt.name}`;
              html += ` <span class="topping-meta">(${mt.category} â€¢ Â£${price})</span>`;
              html += `</label>`;
            });
            html += `</form>`;
          }
          if (outOfStock) {
            html += `<div class='out-of-stock-label'>Out of stock</div>`;
            html += `<div class='out-of-stock-label'>Out of stock</div>`;
          }
          html += `</li>`;
        });
        html += '</ul>';
      }
    });
    content.innerHTML = html;
    updateCartBadge();

    // --- Master Toppings Popup ---
    let masterToppingsPopupBg = document.getElementById('master-toppings-popup-bg');
    if (!masterToppingsPopupBg) {
      masterToppingsPopupBg = document.createElement('div');
      masterToppingsPopupBg.id = 'master-toppings-popup-bg';
      masterToppingsPopupBg.style.position = 'fixed';
      masterToppingsPopupBg.style.top = '0';
      masterToppingsPopupBg.style.left = '0';
      masterToppingsPopupBg.style.width = '100vw';
      masterToppingsPopupBg.style.height = '100vh';
      masterToppingsPopupBg.style.background = 'rgba(0,0,0,0.5)';
      masterToppingsPopupBg.style.display = 'none';
      masterToppingsPopupBg.style.justifyContent = 'center';
      masterToppingsPopupBg.style.alignItems = 'center';
      masterToppingsPopupBg.style.zIndex = '3000';
      document.body.appendChild(masterToppingsPopupBg);
    }
    let masterToppingsPopup = document.getElementById('master-toppings-popup');
    if (!masterToppingsPopup) {
      masterToppingsPopup = document.createElement('div');
      masterToppingsPopup.id = 'master-toppings-popup';
      masterToppingsPopup.style.background = '#fff';
      masterToppingsPopup.style.padding = '24px';
      masterToppingsPopup.style.borderRadius = '8px';
      masterToppingsPopup.style.boxShadow = '0 2px 16px rgba(0,0,0,0.2)';
      masterToppingsPopup.style.minWidth = '320px';
      masterToppingsPopup.style.border = '3px solid green';
      masterToppingsPopupBg.appendChild(masterToppingsPopup);
    }

    function showMasterToppingsPopup(item, selectedSize) {
      let popupHtml = `<h3>Add Master Toppings</h3>`;
      popupHtml += `<form id='master-toppings-popup-form'>`;
      masterToppings.forEach(mt => {
        let price = '0.00';
        if (mt.category === 'Meat') price = masterToppingsData.settings.masterMeatPrice?.toFixed(2) || '0.00';
        else if (mt.category === 'Veg') price = masterToppingsData.settings.masterVegPrice?.toFixed(2) || '0.00';
        else if (typeof mt.price === 'number') price = mt.price.toFixed(2);
        popupHtml += `<label style='display:block;margin-bottom:6px;'><input type='checkbox' class='popup-master-topping-cb' data-name='${mt.name}' data-category='${mt.category}' data-price='${price}'> ${mt.name} <span style='font-size:0.95em;color:#888;'>(${mt.category} â€¢ Â£${price})</span></label>`;
      });
      popupHtml += `</form>`;
      popupHtml += `<button id='master-toppings-popup-add'>Add Selected Toppings</button> <button id='master-toppings-popup-cancel'>Cancel</button>`;
      masterToppingsPopup.innerHTML = popupHtml;
      masterToppingsPopupBg.style.display = 'flex';

      document.getElementById('master-toppings-popup-cancel').onclick = function() {
        masterToppingsPopupBg.style.display = 'none';
      };
      document.getElementById('master-toppings-popup-add').onclick = function() {
        // Gather selected toppings and prices
        const selected = Array.from(masterToppingsPopup.querySelectorAll('.popup-master-topping-cb:checked'));
        const extraToppings = selected.map(cb => cb.getAttribute('data-name'));
        const extraToppingPrices = selected.map(cb => parseFloat(cb.getAttribute('data-price')) || 0);
        let totalPrice = 0;
        if (selectedSize && selectedSize.price) {
          totalPrice = parseFloat(selectedSize.price) || 0;
        } else {
          totalPrice = parseFloat(item.price) || 0;
        }
        extraToppingPrices.forEach(p => { totalPrice += p; });
        const orderObj = { ...item, price: totalPrice, quantity: 1, masterToppings: extraToppings };
        if (selectedSize) orderObj.selectedSize = selectedSize;
        addToOrder(orderObj);
        masterToppingsPopupBg.style.display = 'none';
      };
    }

    document.querySelectorAll('.show-master-toppings-popup').forEach(btn => {
      btn.addEventListener('click', function(e) {
        const item = JSON.parse(btn.getAttribute('data-item').replace(/&apos;/g, "'"));
        let size = null;
        if (btn.hasAttribute('data-size')) {
          try {
            size = JSON.parse(btn.getAttribute('data-size').replace(/&apos;/g, "'"));
          } catch (err) {
            size = btn.getAttribute('data-size');
          }
        }
        showMasterToppingsPopup(item, size);
        e.stopPropagation();
      });
    });

    // Add event listeners for menu actions (add to order, etc.)
    document.querySelectorAll('.menu-size-option').forEach(opt => {
      if (opt.style.pointerEvents === 'none') return;
      opt.addEventListener('click', function(e) {
        const item = JSON.parse(opt.getAttribute('data-item').replace(/&apos;/g, "'"));
        let size = null;
        try {
          size = JSON.parse(opt.getAttribute('data-size').replace(/&apos;/g, "'"));
        } catch (err) {
          size = opt.getAttribute('data-size');
        }
        // Find the toppings form for this item
        let extraToppings = [];
        let extraToppingPrices = [];
        let menuItemCard = opt.closest('.menu-item-card');
        const form = menuItemCard ? menuItemCard.querySelector('.toppings-form') : null;
        if (form) {
          const addToppingCbs = Array.from(form.querySelectorAll('.add-topping'));
          addToppingCbs.forEach(cb => {
            if (cb.checked && !cb.disabled) {
              extraToppings.push(cb.value);
              extraToppingPrices.push(parseFloat(cb.getAttribute('data-price')) || 0);
            }
          });
        }
        // Calculate total price (size + extra toppings)
        let totalPrice = parseFloat(size.price) || 0;
        extraToppingPrices.forEach(p => { totalPrice += p; });
        const orderObj = { ...item, selectedSize: size, price: totalPrice, quantity: 1, toppings: extraToppings };
        addToOrder(orderObj);
        // Reset add-topping checkboxes to unchecked
        if (form) {
          Array.from(form.querySelectorAll('.add-topping')).forEach(cb => { cb.checked = false; });
        }
        opt.style.background = '#e9ece5';
        setTimeout(() => { opt.style.background = ''; }, 300);
        e.stopPropagation();
      });
    });
    document.querySelectorAll('.menu-side-option').forEach(opt => {
      if (opt.style.pointerEvents === 'none') return;
      opt.addEventListener('click', function(e) {
        const item = JSON.parse(opt.getAttribute('data-item').replace(/&apos;/g, "'"));
        const side = JSON.parse(opt.getAttribute('data-side').replace(/&apos;/g, "'"));
        addToOrder({ ...item, selectedSide: side, price: side.price, quantity: 1 });
        opt.style.background = '#e9ece5';
        setTimeout(() => { opt.style.background = ''; }, 300);
        e.stopPropagation();
      });
    });
    // Make all other menu-item-cards clickable (desserts, drinks, etc.)
    document.querySelectorAll('.menu-item-card').forEach(card => {
      if (card.querySelector('.menu-size-option') || card.querySelector('.menu-side-option')) return;
      if (card.classList.contains('out-of-stock')) return;
      card.style.cursor = 'pointer';
      card.addEventListener('click', function(e) {
        const item = JSON.parse(card.getAttribute('data-item') ? card.getAttribute('data-item').replace(/&apos;/g, "'") : '{}');
        let price = parseFloat(item.price);
        if (isNaN(price)) price = 0;
        addToOrder({ ...item, price, quantity: 1 });
        card.style.background = '#e9ece5';
        setTimeout(() => { card.style.background = ''; }, 300);
        e.stopPropagation();
      });
    });
  }

  // --- End renderMenu function ---
  console.log("menu script loaded");
  document.addEventListener('DOMContentLoaded', async function() {
    console.log("DOMContentLoaded fired");
    console.log("Fetching menu data...");
    try {
      const [menuRes, sectionsRes, masterToppingsRes, sectionAssignmentsRes] = await Promise.all([
        fetch('/api/menu'),
        fetch('/api/sections'),
        fetch('/api/master-toppings'),
        fetch('/api/section-topping-assignments')
      ]);
      const menuData = await menuRes.json();
      const sectionsData = await sectionsRes.json();
      const masterToppingsData = await masterToppingsRes.json();
      const sectionAssignmentsData = await sectionAssignmentsRes.json();
      const doughStock = null;
      const gfDoughStock = null;
      console.log("Menu data:", menuData);
      renderMenu(menuData, sectionsData, masterToppingsData, sectionAssignmentsData, doughStock, gfDoughStock);
      const menuContent = document.getElementById('menu-content');
      if (menuContent) menuContent.classList.remove('d-none');
    } catch (err) {
      const menuContent = document.getElementById('menu-content');
      if (menuContent) {
        menuContent.innerHTML = '<span style="color:red">Failed to load menu. Please try again later.</span>';
        menuContent.classList.remove('d-none');
      }
      console.error('Menu load error:', err);
    }
  });
  </script>
</body>
</html>