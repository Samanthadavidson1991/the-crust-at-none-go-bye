<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>None Go Bye â€“ Menu</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body class="menu-page app-body" id="menu-page">
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <div id="cart-badge" class="cart-badge d-none">
    <button id="cart-badge-btn" class="cart-badge-btn no-style-btn" aria-label="View checkout cart" tabindex="0">
      ðŸ›’ <span id="cart-count">0</span> in checkout
    </button>
  </div>
  <header>
  <h1 class="main-heading underline">Inspired by Naples, perfected at None Go Bye.</h1>
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
      <a href="index.html">Home</a>
      <a href="menu.html">Menu</a>
      <a href="checkout.html">Checkout</a>
      <a href="allergens.html">Allergens</a>
    </nav>
  </header>
  <main>
    <main id="main-content">
    <div id="special-offers-banner" class="special-offers-banner"></div>
    <section id="dynamic-menu">
      <div id="menu-content" class="d-none"></div>
    </section>
</body>
<script>
      // TEST: Force a fetch to backend and log result
      fetch('https://the-crust-at-none-go-bye.onrender.com/api/menu')
        .then(res => {
          console.log('Test fetch to /api/menu status:', res.status);
          return res.text();
        })
        .then(text => {
          console.log('Test fetch to /api/menu response:', text);
        })
        .catch(err => {
          console.error('Test fetch to /api/menu failed:', err);
        });
    // TEST: Confirm JS is running
    console.log('JS test: menu.html script is running');
    document.body.insertAdjacentHTML('afterbegin', '<div id="js-test-message" style="color:green;font-weight:bold;">JS test: Script is running</div>');
    setTimeout(() => {
      const msg = document.getElementById('js-test-message');
      if (msg) msg.remove();
    }, 3000);
  // --- Dough Stock Logic ---
  let doughStock = null;
  let gfDoughStock = null;
  async function fetchDoughStocks() {
    try {
      const [doughRes, gfRes] = await Promise.all([
        fetch('https://the-crust-at-none-go-bye.onrender.com/api/dough-stock'),
        fetch('https://the-crust-at-none-go-bye.onrender.com/api/gf-dough-stock')
      ]);
      doughStock = (await doughRes.json()).stock;
      gfDoughStock = (await gfRes.json()).stock;
    } catch {
      doughStock = null;
      gfDoughStock = null;
    }
  }
  function updateCartBadge() {
    const order = JSON.parse(localStorage.getItem('order') || '[]');
    const count = order.reduce((sum, item) => sum + (item.quantity || 1), 0);
    const badge = document.getElementById('cart-badge');
    document.getElementById('cart-count').textContent = count;
    badge.style.display = count > 0 ? 'block' : 'none';
  }

  document.addEventListener('DOMContentLoaded', function() {
    updateCartBadge();
    const badgeBtn = document.getElementById('cart-badge-btn');
    if (badgeBtn) {
      badgeBtn.onclick = function() {
        window.location.href = 'checkout.html';
      };
      badgeBtn.onkeydown = function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          window.location.href = 'checkout.html';
        }
      };
    }
  });

  async function fetchSpecialOffers() {
    // Special offers endpoint not implemented; banner will remain hidden
    const banner = document.getElementById('special-offers-banner');
    banner.style.display = 'none';
    banner.innerHTML = '';
  }

      async function fetchMenu() {
        // Fetch menu, sections, master toppings, and section assignments in parallel
        fetchSpecialOffers();
        try {
          const [menuRes, sectionsRes, masterToppingsRes, sectionAssignRes] = await Promise.all([
            fetch('https://the-crust-at-none-go-bye.onrender.com/api/menu'),
            fetch('https://the-crust-at-none-go-bye.onrender.com/api/sections'),
            fetch('https://the-crust-at-none-go-bye.onrender.com/api/master-toppings'),
            fetch('https://the-crust-at-none-go-bye.onrender.com/api/section-topping-assignments')
          ]);
          if (!menuRes.ok) throw new Error('Menu fetch failed');
          if (!sectionsRes.ok) throw new Error('Sections fetch failed');
          if (!masterToppingsRes.ok) throw new Error('Master toppings fetch failed');
          if (!sectionAssignRes.ok) throw new Error('Section assignments fetch failed');
          const menuData = await menuRes.json();
          const sectionsData = await sectionsRes.json();
          const masterToppingsData = await masterToppingsRes.json();
          const sectionAssignmentsData = await sectionAssignRes.json();
          console.log('DEBUG: menuData', menuData);
          console.log('DEBUG: sectionsData', sectionsData);
          console.log('DEBUG: masterToppingsData', masterToppingsData);
          console.log('DEBUG: sectionAssignmentsData', sectionAssignmentsData);
          await fetchDoughStocks();
          renderMenu(menuData.items, masterToppingsData, sectionsData.sections, sectionAssignmentsData.assignments, masterToppingsData.settings);
        } catch (err) {
          console.error('DEBUG: fetchMenu error', err);
          const content = document.getElementById('menu-content');
          content.style.display = 'block';
          content.innerHTML = '<em style="color:red">Failed to load menu, sections, or toppings. Please try again later.</em>';
        }
      }

  function renderMenu(menu, masterToppingsData, dbSections, sectionAssignments, masterToppingSettings) {
    // masterToppingsData: { toppings: [...], settings: {...} }
    // sectionAssignments: { [sectionName]: [toppingId, ...] }
    // masterToppingSettings: { masterMeatPrice, masterVegPrice }
    const masterToppings = masterToppingsData.toppings || [];
    const content = document.getElementById('menu-content');
    if (!menu || !Array.isArray(menu) || menu.length === 0) {
      content.innerHTML = '<em>No menu items found.</em>';
      return;
    }
    content.style.display = 'block';
    // Group items by section name
    const sectionMap = {};
    menu.forEach(item => {
      const section = item.section || 'Other';
      if (!sectionMap[section]) sectionMap[section] = [];
      sectionMap[section].push(item);
    });
    let html = '';
    // Render sections in DB order, then any extra sections
    dbSections.forEach(sec => {
      const sectionName = sec.name;
      if (sectionMap[sectionName]) {
        html += `<h2>${sectionName}</h2><ul class='menu-card-list'>`;
        sectionMap[sectionName].forEach(item => {
          const isDoughTracked = !!item.doughTracked;
          const isGFDoughTracked = !!item.gfDoughTracked;
          let outOfStock = false;
          if (isDoughTracked && (doughStock !== null && doughStock <= 0)) outOfStock = true;
          if (isGFDoughTracked && (gfDoughStock !== null && gfDoughStock <= 0)) outOfStock = true;
          html += `<li class='menu-item-card'><b>${item.name}</b><br>${item.description ? item.description + '<br>' : ''}`;
          if(item.sizes && Array.isArray(item.sizes) && item.sizes.length) {
            html += '<ul style="list-style:none;padding:0;">';
            item.sizes.forEach(size => {
              html += `<li style="display:inline;margin-right:8px;margin-bottom:6px;">
                <button type="button" class="menu-size-option" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-size='${JSON.stringify(size).replace(/'/g, "&apos;")}' >
                  <span style="font-weight:600;">${size.name}</span>: <span class='price'>Â£${parseFloat(size.price).toFixed(2)}</span>
                </button>
              </li>`;
            });
            html += '</ul>';
          }
          // --- Toppings UI ---
          // Pizza-specific toppings (from admin)
          if (item.toppings && Array.isArray(item.toppings) && item.toppings.length) {
            html += `<form class='toppings-form' data-name='${item.name}'>`;
            html += `<small><b>Remove Toppings:</b></small><br>`;
            item.toppings.forEach(topping => {
              html += `<label style='margin-right:8px'><input type='checkbox' class='pizza-topping' value='${topping}' checked> ${topping}</label>`;
            });
            html += `</form>`;
          }
          // Master toppings (if allowed for this item)
          if (item.allowMasterToppings) {
            if (masterToppings.length > 0) {
              html += `<form class='toppings-form' data-name='${item.name}-master'>`;
              html += `<small><b>Add Master Toppings:</b></small><br>`;
              masterToppings.forEach(mt => {
                let price = '0.00';
                if (mt.category === 'Meat') price = masterToppingSettings.masterMeatPrice?.toFixed(2) || '0.00';
                else if (mt.category === 'Veg') price = masterToppingSettings.masterVegPrice?.toFixed(2) || '0.00';
                else if (typeof mt.price === 'number') price = mt.price.toFixed(2);
                html += `<label style='margin-right:8px'><input type='checkbox' class='add-topping' value='${mt.name}' data-price='${price}'> ${mt.name}`;
                html += ` <span style='font-size:0.9em;color:#888'>(${mt.category} â€¢ Â£${price})</span>`;
                html += `</label>`;
              });
              html += `</form>`;
            }
          }
          if (outOfStock) {
            html += `<div class='out-of-stock-label' style='color:#b9472e;font-weight:bold;margin-top:8px;'>Out of stock</div>`;
              html += `<div class='out-of-stock-label'>Out of stock</div>`;
          }
          html += `</li>`;
        });
        html += '</ul>';
      }
    });
    // Render any sections not in DB (fallback)
    Object.keys(sectionMap).forEach(section => {
      if (!dbSections.find(sec => sec.name === section)) {
        html += `<h2>${section}</h2><ul class='menu-card-list'>`;
        sectionMap[section].forEach(item => {
          const isDoughTracked = !!item.doughTracked;
          const isGFDoughTracked = !!item.gfDoughTracked;
          let outOfStock = false;
          if (isDoughTracked && (doughStock !== null && doughStock <= 0)) outOfStock = true;
          if (isGFDoughTracked && (gfDoughStock !== null && gfDoughStock <= 0)) outOfStock = true;
          html += `<li class='menu-item-card'><b>${item.name}</b><br>${item.description ? item.description + '<br>' : ''}`;
          if(item.sizes && Array.isArray(item.sizes) && item.sizes.length) {
            html += '<ul style="list-style:none;padding:0;">';
            item.sizes.forEach(size => {
              html += `<li style="display:inline;margin-right:8px;margin-bottom:6px;">
                <button type="button" class="menu-size-option" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-size='${JSON.stringify(size).replace(/'/g, "&apos;")}' >
                  <span style="font-weight:600;">${size.name}</span>: <span class='price'>Â£${parseFloat(size.price).toFixed(2)}</span>
                    <span class="menu-size-label">${size.name}</span>: <span class='price'>Â£${parseFloat(size.price).toFixed(2)}</span>
                </button>
              </li>`;
            });
            html += '</ul>';
          }
          // Section-based toppings assignment for fallback sections
          const assignedToppingIds = (sectionAssignments && sectionAssignments[section]) || [];
          const assignedToppings = masterToppings.filter(mt => assignedToppingIds.includes(mt._id));
          if (assignedToppings.length > 0) {
            html += `<form class='toppings-form' data-name='${item.name}'>`;
            html += `<small><b>Add Toppings:</b></small><br>`;
            assignedToppings.forEach(mt => {
              let price = '0.00';
              if (mt.category === 'Meat') price = masterToppingSettings.masterMeatPrice?.toFixed(2) || '0.00';
              else if (mt.category === 'Veg') price = masterToppingSettings.masterVegPrice?.toFixed(2) || '0.00';
              else if (typeof mt.price === 'number') price = mt.price.toFixed(2);
              html += `<label style='margin-right:8px'><input type='checkbox' class='add-topping' value='${mt.name}' data-price='${price}'> ${mt.name}`;
              html += ` <span style='font-size:0.9em;color:#888'>(${mt.category} â€¢ Â£${price})</span>`;
              html += `</label>`;
            });
            html += `</form>`;
          }
          if (outOfStock) {
            html += `<div class='out-of-stock-label' style='color:#b9472e;font-weight:bold;margin-top:8px;'>Out of stock</div>`;
              html += `<div class='out-of-stock-label'>Out of stock</div>`;
          }
          html += `</li>`;
        });
        html += '</ul>';
      }
    });
    content.innerHTML = html;

    updateCartBadge();

    // Only allow add-to-order via size/side/gluten free options, but skip if out of stock
    document.querySelectorAll('.menu-size-option').forEach(opt => {
      if (opt.style.pointerEvents === 'none') return;
      opt.addEventListener('click', function(e) {
        const item = JSON.parse(opt.getAttribute('data-item').replace(/&apos;/g, "'"));
        const size = JSON.parse(opt.getAttribute('data-size').replace(/&apos;/g, "'"));
        // Find the toppings form for this item
        let extraToppings = [];
        let extraToppingPrices = [];
        let menuItemCard = opt.closest('.menu-item-card');
        const form = menuItemCard ? menuItemCard.querySelector('.toppings-form') : null;
        if (form) {
          const addToppingCbs = Array.from(form.querySelectorAll('.add-topping'));
          addToppingCbs.forEach(cb => {
            if (cb.checked && !cb.disabled) {
              extraToppings.push(cb.value);
              extraToppingPrices.push(parseFloat(cb.getAttribute('data-price')) || 0);
            }
          });
        }
        // Calculate total price (size + extra toppings)
        let totalPrice = parseFloat(size.price) || 0;
        extraToppingPrices.forEach(p => { totalPrice += p; });
        const orderObj = { ...item, selectedSize: size, price: totalPrice, quantity: 1, toppings: extraToppings };
        addToOrder(orderObj);
        // Reset add-topping checkboxes to unchecked
        if (form) {
          Array.from(form.querySelectorAll('.add-topping')).forEach(cb => { cb.checked = false; });
        }
        opt.style.background = '#e9ece5';
        setTimeout(() => { opt.style.background = ''; }, 300);
        e.stopPropagation();
      });
    });
    document.querySelectorAll('.menu-side-option').forEach(opt => {
      if (opt.style.pointerEvents === 'none') return;
      opt.addEventListener('click', function(e) {
        const item = JSON.parse(opt.getAttribute('data-item').replace(/&apos;/g, "'"));
        const side = JSON.parse(opt.getAttribute('data-side').replace(/&apos;/g, "'"));
        addToOrder({ ...item, selectedSide: side, price: side.price, quantity: 1 });
        opt.style.background = '#e9ece5';
        setTimeout(() => { opt.style.background = ''; }, 300);
        e.stopPropagation();
      });
    });
    // Make all other menu-item-cards clickable (desserts, drinks, etc.)
    document.querySelectorAll('.menu-item-card').forEach(card => {
      if (card.querySelector('.menu-size-option') || card.querySelector('.menu-side-option')) return;
      if (card.classList.contains('out-of-stock')) return;
      card.style.cursor = 'pointer';
      card.addEventListener('click', function(e) {
        const item = JSON.parse(card.getAttribute('data-item').replace(/&apos;/g, "'"));
        addToOrder({ ...item, price: parseFloat(item.price), quantity: 1 });
        card.style.background = '#e9ece5';
        setTimeout(() => { card.style.background = ''; }, 300);
        e.stopPropagation();
      });
    });
  }

  function addToOrder(item) {
    let order = JSON.parse(localStorage.getItem('order') || '[]');
    // Try to merge with existing (same name/size/side)
    const matchIdx = order.findIndex(i => i.name === item.name && JSON.stringify(i.selectedSize) === JSON.stringify(item.selectedSize) && JSON.stringify(i.selectedSide) === JSON.stringify(item.selectedSide));
    if (matchIdx > -1) {
      order[matchIdx].quantity += 1;
    } else {
      order.push(item);
    }
    localStorage.setItem('order', JSON.stringify(order));
    updateCartBadge();
  }
  fetchMenu();
  // Add out-of-stock style
  const style = document.createElement('style');
  style.textContent = `.menu-item-card.out-of-stock { opacity: 0.5; pointer-events: none; position: relative; } .out-of-stock-label { color: #b9472e; font-weight: bold; font-size: 1.1em; }`;
  document.head.appendChild(style);
</script>
</body>
</html>