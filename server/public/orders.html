<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Orders | None Go Bye</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="orders-calendar.css">
  <link rel="stylesheet" href="flatpickr.min.css">
  <style>
    .order-table { width: 100%; border-collapse: collapse; margin-top: 24px; }
    .order-table th, .order-table td { padding: 12px; border-bottom: 1px solid #ccc; text-align: left; }
    .order-table th { background: #e9ece5; }
    .order-table tr:last-child td { border-bottom: none; }
    .order-status { font-weight: bold; }
    .distance-info { color: #888; font-size: 0.95em; }
  </style>
  <!-- Moved styles to styles.css -->
</head>
<body class="admin-page">
    <!-- Removed duplicate nav -->
    <div id="calendar-error" style="display:none;color:#b9472e;font-weight:bold;margin:12px 0;"></div>
    <!-- Login redirect removed for dashboard access -->
    <script src="/admin-order-toast.js"></script>
    <script src="flatpickr.min.js"></script>
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <header>
    <h1 class="main-heading underline">Admin Orders</h1>
    <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
      <a href="admin-menu.html">Menu Editor</a>
      <a href="stock-management.html">Stock Management</a>
      <a href="timeslots.html">Time Slots</a>
      <a href="orders.html">Orders</a>
      <a href="running-orders.html">Running Orders</a>
      <a href="takings.html">Takings</a>
      <a href="pos.html">POS Manual Order</a>
      <a href="offers.html">Special Offers</a>
    </nav>
  </header>
  <main>
    <main id="main-content">
    <section class="admin-section">
      <h2>All Orders</h2>
      <div class="mb-16 flex align-center gap-12">
        <input type="text" id="order-date-picker" placeholder="Select date" readonly>
      </div>
      <div class="dough-counters">
        <div><b>Dough Used:</b> <span id="dough-count">0</span></div>
        <div><b>Gluten Free Used:</b> <span id="gf-count">0</span></div>
        <div>
          <label><b>Dough Available:</b> <input type="number" id="dough-available" min="0" value="0" class="dough-input"></label>
        </div>
        <div>
          <label><b>Gluten Free Available:</b> <input type="number" id="gf-available" min="0" value="0" class="dough-input" title="Gluten free dough available" placeholder="Amount"></label>
        </div>
      </div>
      <table class="order-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Name</th>
            <th>Type</th>
            <th>Time Slot</th>
            <th>Address</th>
            <th>Items Ordered</th>
            <th>Allergens</th>
            <th>Total (£)</th>
            <th>Payment</th>
            <th>Change Needed</th>
            <th>Distance (miles)</th>
            <th>Est. Travel Time</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="orders-tbody">
          <tr><td colspan="12">Loading orders...</td></tr>
        </tbody>
      </table>
    </section>
  </main>
  <script>
    // Login/session check
    fetch('/api/admin/check', { credentials: 'include' })
      .then(r => {
        if (!r.ok) window.location.href = 'login.html';
      });

    // Minimal Flatpickr calendar setup
    document.addEventListener('DOMContentLoaded', function() {
      flatpickr('#order-date-picker', {
        dateFormat: 'Y-m-d',
        defaultDate: new Date(),
        disableMobile: true
      });
    });
    // --- Lock Page Logic ---
    function lockAdminPage() {
      fetch('/api/admin/lock', { method: 'POST', credentials: 'include' })
        .then(r => {
          if (r.ok) {
            alert('Page locked. You will not be logged out automatically.');
          } else {
            alert('Failed to lock page.');
          }
        });
    }
    // Store order counts by name (lowercase)
    let orderCountsByName = {};
    // Helper: get distance and duration from postcodes.io
    async function getDistanceAndDuration(from, to) {
      const url = 'https://api.postcodes.io/postcodes';
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ postcodes: [from, to] })
        });
        const data = await res.json();
        if (!data.result || !Array.isArray(data.result) || data.result.length < 2) {
          console.error('[DISTANCE DEBUG] Invalid API result:', data);
          return { miles: '?', duration: '?' };
        }
        const [fromRes, toRes] = data.result;
        if (!fromRes.result || !toRes.result) {
          console.error('[DISTANCE DEBUG] Missing result for postcode:', from, to, data);
          return { miles: '?', duration: '?' };
        }
        const lat1 = fromRes.result.latitude, lon1 = fromRes.result.longitude;
        const lat2 = toRes.result.latitude, lon2 = toRes.result.longitude;
        // Haversine formula
        const R = 3958.8; // miles
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const roadFactor = 1.8; // More balanced distance estimate
        const miles = R * c * roadFactor;
        // Assume 25 mph average delivery speed
        const duration = miles !== '?' ? Math.round((miles / 25) * 60) : '?';
        return { miles: miles.toFixed(2), duration: duration + ' min' };
      } catch (err) {
        console.error('[DISTANCE DEBUG] API error:', err);
        return { miles: '?', duration: '?' };
      }
      }
    }

    function formatDateInput(date) {
      // Returns YYYY-MM-DD for input[type=date]
      return date.toISOString().slice(0, 10);
    }

    async function fetchOrders(selectedDate) {
      // selectedDate: string YYYY-MM-DD
      // Fetch order counts by name (removed: /api/order-counts endpoint does not exist)
      orderCountsByName = {};
      // Check if selectedDate is today
      const todayStr = formatDateInput(new Date());
      const isToday = selectedDate === todayStr;
      const tbody = document.getElementById('orders-tbody');
      if (!isToday) {
        // Clear table and counters for non-today dates
        tbody.innerHTML = '<tr><td colspan="13">No orders for this day.</td></tr>';
        document.getElementById('dough-count').textContent = '0';
        document.getElementById('gf-count').textContent = '0';
        return;
      }
      // Fetch delivery distance limit
      let deliveryLimit = 5;
      try {
        const distRes = await fetch('/api/delivery-distance', { credentials: 'include' });
        const distData = await distRes.json();
        if (distData && typeof distData.miles === 'number') deliveryLimit = distData.miles;
      } catch {}
      tbody.innerHTML = '<tr><td colspan="12">Loading orders...</td></tr>';
      let doughCount = 0;
      let gfCount = 0;
      // Fetch menu to get gluten free items
      let glutenFreeNames = [];
      try {
        const menuRes = await fetch('/api/menu', { credentials: 'include' });
        const menu = await menuRes.json();
        glutenFreeNames = menu.filter(item => item.glutenFree).map(item => item.name.toLowerCase());
      } catch {}
      try {
        let url = '/api/orders';
        if (selectedDate) url += `?date=${selectedDate}`;
        const res = await fetch(url, { credentials: 'include' });
        const orders = await res.json();
        console.log('[ORDERS DEBUG] Orders data received:', orders);
        // Removed invalid block that referenced 'order' before it was defined
        tbody.innerHTML = '';
        // Count dough/gluten free for all orders
        for (const order of orders) {
          // --- Per-order rendering ---
          // Refund status display
          let refundInfo = '';
          if (order.refundAmount && order.refundAmount > 0) {
            refundInfo = `<div class='refund-info'><b>Refunded:</b> £${order.refundAmount.toFixed(2)}<br><span class='refund-date'>${order.refundDate ? new Date(order.refundDate).toLocaleString() : ''}</span><br>${order.refundReason ? `<span class='refund-reason'><b>Reason:</b> ${order.refundReason}</span>` : ''}</div>`;
          }
          // Order count for this name
          let nameDisplay = order.name || '';
          if (order.name) {
            const count = orderCountsByName[order.name.toLowerCase()];
            if (count > 1) nameDisplay += ` <span class='item-count'>(x${count})</span>`;
          }
          let distanceInfo = '<span class="distance-info">?</span>';
          let durationInfo = '<span class="distance-info">?</span>';
          let highlightDistance = false;
          if (order.address && order.address.postcode) {
            try {
              const { miles, duration } = await getDistanceAndDuration('LS18 5HZ', order.address.postcode);
              if (miles !== '?' && parseFloat(miles) > deliveryLimit) highlightDistance = true;
              distanceInfo = `<span class="distance-info${highlightDistance ? ' highlight-distance' : ''}">${miles}</span>`;
              durationInfo = `<span class="distance-info">${duration}</span>`;
            } catch {}
          }
          // Add highlight style for distance over limit (only once)
          if (!document.getElementById('highlight-distance-style')) {
            const style = document.createElement('style');
            style.id = 'highlight-distance-style';
            style.textContent = `.highlight-distance { background: #ffb4b4; color: #a10000; font-weight: bold; padding: 2px 6px; border-radius: 6px; }`;
            document.head.appendChild(style);
          }
          let itemsHtml = '';
          if (Array.isArray(order.items) && order.items.length) {
            itemsHtml = '<ul class="order-items-list">' + order.items.map(item => {
              console.log('[ORDER ITEM DEBUG]', item.name, 'price:', item.price, 'type:', typeof item.price);
              let details = '';
              if (item.toppings && Array.isArray(item.toppings) && item.toppings.length) {
                details += '<br><span class="order-ingredients">Ingredients: ' + item.toppings.join(', ') + '</span>';
              }
              if (item.removed && Array.isArray(item.removed) && item.removed.length) {
                details += `<br><span class='order-removed'>Removed: ${item.removed.join(', ')}</span>`;
              }
              if (item.notes) {
                details += `<br><em class='order-notes'>(${item.notes})</em>`;
              }
              return `<li>${item.quantity || 1} × ${item.name}${item.size ? ' (' + item.size + ')' : ''} - £${item.price ? Number(item.price).toFixed(2) : '0.00'}${details}</li>`;
            }).join('') + '</ul>';
          } else {
            itemsHtml = '<span class="muted">None</span>';
          }
          // Calculate 'Start By' time (same as running orders)
          let slotDisplay = order.timeSlot || '';
          let startBy = '';
          // Count doughs for this order
          let orderDoughCount = 0;
          if (Array.isArray(order.items)) {
            for (const item of order.items) {
              orderDoughCount += Number(item.quantity) || 1;
            }
          }
          // Estimate travel time (sync call for UI, fallback to '?')
          let travelTime = '?';
          if (order.address && order.address.postcode) {
            try {
              const { miles } = await getDistanceAndDuration('LS18 5HZ', order.address.postcode);
              if (miles !== '?') {
                travelTime = Math.round((parseFloat(miles) / 25) * 60); // 25 mph
              }
            } catch {}
          } else {
            console.warn('[DISTANCE DEBUG] Missing address or postcode for order (travelTime):', order);
            travelTime = '?';
          }
          // 3 min to find house + 4 min per dough + 10 min buffer for finishing/packing
          const prepTime = 3 + (4 * orderDoughCount) + 10;
          if (order.timeSlot) {
            const match = /^([0-9]{1,2}):([0-9]{2})/.exec(order.timeSlot);
            if (match) {
              let hour = parseInt(match[1], 10);
              let min = parseInt(match[2], 10);
              let totalMins = hour * 60 + min;
              if (travelTime !== '?') totalMins -= travelTime;
              totalMins -= prepTime;
              if (totalMins < 0) totalMins += 24 * 60;
              const startHour = Math.floor(totalMins / 60);
              const startMin = totalMins % 60;
              startBy = `${startHour.toString().padStart(2, '0')}:${startMin.toString().padStart(2, '0')}`;
              slotDisplay += ` <span class='muted'>(Start: ${startBy})</span>`;
            }
          }
          // Show customer notes if present
          let customerNotes = '';
          if (order.customerNotes && order.customerNotes.trim()) {
            customerNotes = `<div class='customer-notes'><b>Customer notes:</b> ${order.customerNotes}</div>`;
          } else if (order.address && order.address.comments) {
            customerNotes = `<div class='customer-notes'><b>Customer notes:</b> ${order.address.comments}</div>`;
          }
          // Allergens display
          let allergensHtml = '';
          if (order.allergens && order.allergens.trim()) {
            allergensHtml = `<div class='order-allergens'>${order.allergens}</div>`;
          } else {
            allergensHtml = `<span class="muted">None</span>`;
          }
          const highlight = order.status === 'Pending Manual Approval' ? ' highlight-pending' : '';
          let actionBtns = '';
          // Show Accept/Decline for any order not yet accepted or declined
          if (order.status !== 'Accepted' && order.status !== 'Declined') {
            actionBtns = `<button onclick="updateOrderStatus('${order._id}','Accepted')">Accept</button> <button onclick="updateOrderStatus('${order._id}','Declined')">Decline</button>`;
          }
          // Calculate total if missing (for legacy orders)
          let total = (typeof order.total === 'number' && !isNaN(order.total)) ? order.total : 0;
          if ((!total || total === 0) && Array.isArray(order.items)) {
            order.items.forEach(item => {
              total += (parseFloat(item.price) || 0) * (item.quantity || 1);
            });
          }
          // Payment type (robust, always lowercased for comparison)
          let paymentType = 'Card';
          if (order.paymentType && typeof order.paymentType === 'string') {
            const pt = order.paymentType.trim().toLowerCase();
            if (pt === 'cash') paymentType = 'Cash';
            else if (pt === 'card') paymentType = 'Card';
            else paymentType = order.paymentType;
          } else if (order.type && typeof order.type === 'string' && order.type.toLowerCase().includes('cash')) {
            paymentType = 'Cash';
          }
          // Change calculation
          let changeHtml = '<span class="muted">N/A</span>';
          if (paymentType === 'Cash') {
            if (total > 0) {
              let paid = 0;
              if (total <= 5) paid = 5;
              else if (total <= 10) paid = 10;
              else if (total <= 20) paid = 20;
              else if (total <= 40) paid = 40;
              else if (total <= 60) paid = 60;
              else if (total <= 80) paid = 80;
              else if (total <= 100) paid = 100;
              else paid = Math.ceil(total / 20) * 20;
              let change = paid - total;
              changeHtml = `£${change.toFixed(2)} (Paid: £${paid.toFixed(2)})`;
            } else {
              changeHtml = '<span style="color:#b9472e">Total missing</span>';
            }
          }
          // Print button for manual printing
          let printBtn = `<button onclick=\"printOrder('${order._id}')\">Print</button>`;
          tbody.innerHTML += `
            <tr${highlight}>
              <td>${nameDisplay}</td>
              <td>${order.type || ''}</td>
              <td>${slotDisplay}</td>
              <td>${order.address ? order.address.full : ''}${customerNotes}</td>
              <td>${itemsHtml}</td>
              <td>${allergensHtml}</td>
              <td>£${total.toFixed(2)}</td>
              <td>${paymentType}</td>
              <td>${changeHtml}</td>
              <td>${distanceInfo}</td>
              <td>${durationInfo}</td>
              <td class="order-status">${order.status || 'Pending'}<br>${actionBtns}<br>${printBtn}${refundInfo}<br><button class="edit-order-btn" data-id="${order._id}">Edit</button></td>
              <td><button class="refund-btn" data-id="${order._id}" data-total="${total}">Refund</button></td>
            </tr>
          `;
              // Refund modal logic
              if (!document.getElementById('refund-modal')) {
                const modal = document.createElement('div');
                modal.id = 'refund-modal';
                modal.style = 'display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;z-index:1000;align-items:center;justify-content:center;';
                                modal.className = 'modal-bg';
                // Date column value
                let dateCol = order.createdAt ? formatDateInput(new Date(order.createdAt)) : '';
                tbody.innerHTML += `
                  <tr${highlight}>
                    <td>${dateCol}</td>
                    <td>${nameDisplay}</td>
                    <td>${order.type || ''}</td>
                    <td>${slotDisplay}</td>
                    <td>${order.address ? order.address.full : ''}${customerNotes}</td>
                    <td>${itemsHtml}</td>
                    <td>${allergensHtml}</td>
                    <td>£${total.toFixed(2)}</td>
                    <td>${paymentType}</td>
                    <td>${changeHtml}</td>
                    <td>${distanceInfo}</td>
                    <td>${durationInfo}</td>
                    <td><span class="order-status">${order.status || ''}</span>${actionBtns}</td>
                  </tr>
                `;
              // --- Edit Order Modal Logic ---
              if (!document.getElementById('edit-order-modal')) {
                const modal = document.createElement('div');
                modal.id = 'edit-order-modal';
                modal.style = 'display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;z-index:1001;align-items:center;justify-content:center;';
                                modal.className = 'modal-bg';
                modal.innerHTML = `
                  <div class="modal-content modal-large">
                    <button id="close-edit-order-modal" class="modal-close-btn">&times;</button>
                    <h3>Edit Order</h3>
                    <form id="edit-order-form">
                      <label>Name:<br><input type="text" id="edit-order-name" style="width:98%"></label><br>
                                            <label>Name:<br><input type="text" id="edit-order-name" class="modal-input"></label><br>
                      <label>Type:<br><select id="edit-order-type" style="width:98%"><option value="Delivery">Delivery</option><option value="Collection">Collection</option></select></label><br>
                                            <label>Type:<br><select id="edit-order-type" class="modal-input"><option value="Delivery">Delivery</option><option value="Collection">Collection</option></select></label><br>
                      <label>Time Slot:<br><input type="text" id="edit-order-timeslot" style="width:98%"></label><br>
                                            <label>Time Slot:<br><input type="text" id="edit-order-timeslot" class="modal-input"></label><br>
                      <label>Address:<br><input type="text" id="edit-order-address" style="width:98%"></label><br>
                                            <label>Address:<br><input type="text" id="edit-order-address" class="modal-input"></label><br>
                      <label>Postcode:<br><input type="text" id="edit-order-postcode" style="width:98%"></label><br>
                                            <label>Postcode:<br><input type="text" id="edit-order-postcode" class="modal-input"></label><br>
                      <label>Email:<br><input type="email" id="edit-order-email" style="width:98%"></label><br>
                                            <label>Email:<br><input type="email" id="edit-order-email" class="modal-input"></label><br>
                      <label>Phone:<br><input type="text" id="edit-order-phone" style="width:98%"></label><br>
                                            <label>Phone:<br><input type="text" id="edit-order-phone" class="modal-input"></label><br>
                      <label>Customer Notes:<br><input type="text" id="edit-order-notes" style="width:98%"></label><br>
                                            <label>Customer Notes:<br><input type="text" id="edit-order-notes" class="modal-input"></label><br>
                      <label>Allergens:<br><input type="text" id="edit-order-allergens" style="width:98%"></label><br>
                                            <label>Allergens:<br><input type="text" id="edit-order-allergens" class="modal-input"></label><br>
                      <label>Payment Type:<br><select id="edit-order-payment" style="width:98%"><option value="card">Card</option><option value="cash">Cash</option></select></label><br>
                                            <label>Payment Type:<br><select id="edit-order-payment" class="modal-input"><option value="card">Card</option><option value="cash">Cash</option></select></label><br>
                      <div id="edit-order-items-section" style="margin:18px 0 8px 0;padding:8px 0;border-top:1px solid #eee;">
                        <b>Order Items:</b>
                        <div id="edit-order-items-list"></div>
                        <button type="button" id="add-edit-order-item-btn" style="margin-top:8px;">Add Item</button>
                      </div>
                      <button type="submit" style="margin-top:12px;">Save Changes</button>
                      <div id="edit-order-error" style="color:#b9472e;margin-top:8px;"></div>
                    </form>
                  </div>
                `;
                document.body.appendChild(modal);
              }
              document.querySelectorAll('.edit-order-btn').forEach(btn => {
                btn.onclick = async function() {
                  const orderId = btn.getAttribute('data-id');
                  // Fetch order details (from already loaded orders)
                  let order = null;
                  try {
                    const orders = await (await fetch('/api/orders', { credentials: 'include' })).json();
                    order = orders.find(o => o._id === orderId);
                  } catch {}
                  if (!order) return;
                  // Populate modal fields
                  document.getElementById('edit-order-name').value = order.name || '';
                  document.getElementById('edit-order-type').value = order.type || 'Delivery';
                  document.getElementById('edit-order-timeslot').value = order.timeSlot || '';
                  document.getElementById('edit-order-address').value = order.address && order.address.full ? order.address.full : '';
                  document.getElementById('edit-order-postcode').value = order.address && order.address.postcode ? order.address.postcode : '';
                  document.getElementById('edit-order-email').value = order.address && order.address.email ? order.address.email : '';
                  document.getElementById('edit-order-phone').value = order.address && order.address.phone ? order.address.phone : '';
                  document.getElementById('edit-order-notes').value = order.customerNotes || '';
                  document.getElementById('edit-order-allergens').value = order.allergens || '';
                  document.getElementById('edit-order-payment').value = (order.paymentType || 'card').toLowerCase();
                  document.getElementById('edit-order-modal').style.display = 'flex';
                  document.getElementById('edit-order-error').textContent = '';
                  // --- Order Items Editing ---
                  let editOrderItems = Array.isArray(order.items) ? JSON.parse(JSON.stringify(order.items)) : [];
                  function renderEditOrderItems() {
                    const listDiv = document.getElementById('edit-order-items-list');
                    if (!editOrderItems.length) {
                      listDiv.innerHTML = '<em>No items in order.</em>';
                      return;
                    }
                    listDiv.innerHTML = editOrderItems.map((item, idx) => `
                      <div style='border:1px solid #eee;padding:8px 6px;margin-bottom:8px;border-radius:8px;'>
                        <label>Name: <input type='text' value='${item.name || ''}' data-idx='${idx}' class='edit-item-name' style='width:120px;'></label>
                        <label>Size: <input type='text' value='${item.size || ''}' data-idx='${idx}' class='edit-item-size' style='width:70px;'></label>
                        <label>Qty: <input type='number' value='${item.quantity || 1}' min='1' data-idx='${idx}' class='edit-item-qty' style='width:40px;'></label>
                        <label>Price: <input type='number' value='${item.price || 0}' min='0' step='0.01' data-idx='${idx}' class='edit-item-price' style='width:60px;'></label><br>
                        <label>Toppings: <input type='text' value='${Array.isArray(item.toppings) ? item.toppings.join(", ") : ''}' data-idx='${idx}' class='edit-item-toppings' style='width:180px;'></label>
                        <label>Removed: <input type='text' value='${Array.isArray(item.removed) ? item.removed.join(", ") : ''}' data-idx='${idx}' class='edit-item-removed' style='width:120px;'></label>
                        <label>Notes: <input type='text' value='${item.notes || ''}' data-idx='${idx}' class='edit-item-notes' style='width:120px;'></label>
                        <button type='button' class='remove-edit-order-item-btn' data-idx='${idx}' style='margin-left:8px;'>Remove</button>
                      </div>
                    `).join('');
                    // Add listeners
                    listDiv.querySelectorAll('.edit-item-name').forEach(inp => {
                      inp.oninput = e => { editOrderItems[inp.dataset.idx].name = inp.value; };
                    });
                    listDiv.querySelectorAll('.edit-item-size').forEach(inp => {
                      inp.oninput = e => { editOrderItems[inp.dataset.idx].size = inp.value; };
                    });
                    listDiv.querySelectorAll('.edit-item-qty').forEach(inp => {
                      inp.oninput = e => { editOrderItems[inp.dataset.idx].quantity = Math.max(1, parseInt(inp.value) || 1); };
                    });
                    listDiv.querySelectorAll('.edit-item-price').forEach(inp => {
                      inp.oninput = e => { editOrderItems[inp.dataset.idx].price = parseFloat(inp.value) || 0; };
                    });
                    listDiv.querySelectorAll('.edit-item-toppings').forEach(inp => {
                      inp.oninput = e => { editOrderItems[inp.dataset.idx].toppings = inp.value.split(',').map(t => t.trim()).filter(Boolean); };
                    });
                    listDiv.querySelectorAll('.edit-item-removed').forEach(inp => {
                      inp.oninput = e => { editOrderItems[inp.dataset.idx].removed = inp.value.split(',').map(t => t.trim()).filter(Boolean); };
                    });
                    listDiv.querySelectorAll('.edit-item-notes').forEach(inp => {
                      inp.oninput = e => { editOrderItems[inp.dataset.idx].notes = inp.value; };
                    });
                    listDiv.querySelectorAll('.remove-edit-order-item-btn').forEach(btn => {
                      btn.onclick = () => {
                        editOrderItems.splice(btn.dataset.idx, 1);
                        renderEditOrderItems();
                      };
                    });
                  }
                  renderEditOrderItems();
                  document.getElementById('add-edit-order-item-btn').onclick = function() {
                    editOrderItems.push({ name: '', size: '', quantity: 1, price: 0, toppings: [], removed: [], notes: '' });
                    renderEditOrderItems();
                  };
                  // Save handler
                  document.getElementById('edit-order-form').onsubmit = async function(e) {
                    e.preventDefault();
                    const name = document.getElementById('edit-order-name').value.trim();
                    const type = document.getElementById('edit-order-type').value;
                    const timeSlot = document.getElementById('edit-order-timeslot').value.trim();
                    const address = document.getElementById('edit-order-address').value.trim();
                    let postcode = document.getElementById('edit-order-postcode').value.trim();
                    // Normalize postcode: uppercase, single space
                    postcode = postcode.toUpperCase().replace(/\s+/g, ' ');
                    const email = document.getElementById('edit-order-email').value.trim();
                    const phone = document.getElementById('edit-order-phone').value.trim();
                    const notes = document.getElementById('edit-order-notes').value.trim();
                    const allergens = document.getElementById('edit-order-allergens').value.trim();
                    const paymentType = document.getElementById('edit-order-payment').value;
                    if (!name || !timeSlot || !address || !postcode) {
                      document.getElementById('edit-order-error').textContent = 'Name, time slot, address, and postcode are required.';
                      return;
                    }
                    // UK postcode regex (simple, covers most cases)
                    // UK postcode regex (strict, covers all valid cases)
                    const postcodeRegex = /^(GIR ?0AA|[A-PR-UWYZ][A-HK-Y]?[0-9][0-9ABEHMNPRV-Y]? ?[0-9][ABD-HJLNP-UW-Z]{2})$/i;
                    if (!postcodeRegex.test(postcode)) {
                      document.getElementById('edit-order-error').textContent = 'Please enter a valid UK postcode (e.g. LS18 5HZ).';
                      return;
                    }
                    // PATCH request
                    try {
                      const res = await fetch(`/api/orders/${orderId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                          name,
                          type,
                          timeSlot,
                          address: { full: address, postcode, email, phone },
                          customerNotes: notes,
                          allergens,
                          paymentType,
                          items: editOrderItems
                        })
                      });
                      if (!res.ok) {
                        const err = await res.text();
                        document.getElementById('edit-order-error').textContent = 'Update failed: ' + err;
                        return;
                      }
                      document.getElementById('edit-order-modal').style.display = 'none';
                      await fetchOrders(dateInput.value);
                    } catch (err) {
                      document.getElementById('edit-order-error').textContent = 'Update failed: ' + (err.message || err);
                    }
                  };
                  document.getElementById('close-edit-order-modal').onclick = function() {
                    document.getElementById('edit-order-modal').style.display = 'none';
                  };
                };
              });
              function showRefundModal(total) {
                const modal = document.getElementById('refund-modal');
                const content = document.getElementById('refund-modal-content');
                let refundReason = '';
                content.innerHTML = `
                  <label>Refund Percentage:<br><input type="number" id="refund-percent" min="1" max="100" value="100" style="width:80px;"> %</label><br><br>
                  <label>Or Custom Amount:<br><input type="number" id="refund-amount" min="0" max="${total}" step="0.01" style="width:100px;"></label><br><br>
                  <label>Reason (optional):<br><input type="text" id="refund-reason" maxlength="100" style="width:98%;"></label><br><br>
                  <div><b>Order Total:</b> £${total.toFixed(2)}</div>
                  <div id="refund-final-amount" style="margin:8px 0 0 0;"></div>
                  <button id="confirm-refund-btn" style="margin-top:12px;">Confirm Refund</button>
                  <div id="refund-error" style="color:#b9472e;margin-top:8px;"></div>
                `;
                modal.style.display = 'flex';
                function updateFinal() {
                  const percent = parseFloat(document.getElementById('refund-percent').value);
                  const custom = parseFloat(document.getElementById('refund-amount').value);
                  let refund = custom > 0 ? custom : (percent > 0 ? (total * percent / 100) : 0);
                  if (refund > total) refund = total;
                  document.getElementById('refund-final-amount').innerHTML = `<b>Refund Amount:</b> £${refund.toFixed(2)}`;
                }
                document.getElementById('refund-percent').oninput = function() {
                  document.getElementById('refund-amount').value = '';
                  updateFinal();
                };
                document.getElementById('refund-amount').oninput = function() {
                  if (this.value) document.getElementById('refund-percent').value = '';
                  updateFinal();
                };
                updateFinal();
                document.getElementById('confirm-refund-btn').onclick = async function() {
                  const percent = parseFloat(document.getElementById('refund-percent').value);
                  const custom = parseFloat(document.getElementById('refund-amount').value);
                  const reason = document.getElementById('refund-reason').value;
                  let refund = custom > 0 ? custom : (percent > 0 ? (total * percent / 100) : 0);
                  if (refund > total) refund = total;
                  if (refund <= 0) {
                    document.getElementById('refund-error').textContent = 'Refund amount must be greater than 0.';
                    return;
                  }
                  try {
                    const res = await fetch(`/api/orders/${orderId}/refund`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      credentials: 'include',
                      body: JSON.stringify({ refundAmount: refund, refundReason: reason })
                    });
                    if (!res.ok) {
                      const err = await res.text();
                      document.getElementById('refund-error').textContent = 'Refund failed: ' + err;
                      return;
                    }
                    modal.style.display = 'none';
                    await fetchOrders();
                  } catch (e) {
                    document.getElementById('refund-error').textContent = 'Refund failed: ' + (e.message || e);
                  }
                };
                document.getElementById('close-refund-modal').onclick = function() {
                  modal.style.display = 'none';
                };
              }
        }
        // Accept/Decline order status
        window.updateOrderStatus = async function(orderId, newStatus) {
          try {
            const res = await fetch(`/api/orders/${orderId}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ status: newStatus })
            });
            if (!res.ok) throw new Error('Failed to update order');
            // If accepted, auto-print two copies
            if (newStatus === 'Accepted') {
              // Find the order in the current orders list
              const order = (await (await fetch('/api/orders')).json()).find(o => o._id === orderId);
              if (order) {
                printOrder(orderId, order, 2);
              }
            }
            await fetchOrders();
          } catch (err) {
            // alert removed for production
          }
        }

        // Print order function
        window.printOrder = async function(orderId, orderObj, copies = 1) {
          // If orderObj not provided, fetch it
          let order = orderObj;
          if (!order) {
            try {
              const orders = await (await fetch('/api/orders', { credentials: 'include' })).json();
              order = orders.find(o => o._id === orderId);
            } catch { return; }
          }
          if (!order) return;
          // Prepare printable HTML
          let itemsHtml = '';
          if (Array.isArray(order.items) && order.items.length) {
            itemsHtml = '<ul>' + order.items.map(item => {
              let details = '';
              if (item.toppings && Array.isArray(item.toppings) && item.toppings.length) {
                details += '<br><span>Ingredients: ' + item.toppings.join(', ') + '</span>';
              }
              if (item.removed && Array.isArray(item.removed) && item.removed.length) {
                details += `<br><span>Removed: ${item.removed.join(', ')}</span>`;
              }
              if (item.notes) {
                details += `<br><em>(${item.notes})</em>`;
              }
              return `<li>${item.quantity || 1} × ${item.name}${item.size ? ' (' + item.size + ')' : ''}${details}</li>`;
            }).join('') + '</ul>';
          } else {
            itemsHtml = '<span>None</span>';
          }
          let allergensHtml = order.allergens ? `<div><b>Allergens:</b> ${order.allergens}</div>` : '';
          let notesHtml = order.customerNotes ? `<div><b>Customer notes:</b> ${order.customerNotes}</div>` : '';
          let addressHtml = order.address && order.address.full ? `<div><b>Address:</b> ${order.address.full}</div>` : '';
          let html = `
            <div style='font-family:sans-serif;max-width:400px;'>
              <h2>Order for ${order.name || ''}</h2>
              ${addressHtml}
              <div><b>Type:</b> ${order.type || 'Delivery'}</div>
              <div><b>Time Slot:</b> ${order.timeSlot || ''}</div>
              ${itemsHtml}
              ${allergensHtml}
              ${notesHtml}
            </div>
          `;
          for (let i = 0; i < copies; i++) {
            let printWindow = window.open('', '', 'width=500,height=700');
            if (printWindow && printWindow.document) {
              printWindow.document.write('<html><head><title>Order Print</title></head><body>' + html + '</body></html>');
              printWindow.document.close();
              printWindow.focus();
              printWindow.print();
              // Optionally, close after print
              printWindow.close();
            } else {
              alert('Unable to open print window. Please check your popup blocker settings.');
            }
          }
        }
      }
    } catch (err) {
      tbody.innerHTML = '<tr><td colspan="12">Error loading orders.</td></tr>';
    }

    // Date navigation logic (prev/next buttons)
    const dateInput = document.getElementById('order-date-picker');
    const prevBtn = document.getElementById('prev-day-btn');
    const nextBtn = document.getElementById('next-day-btn');

    function setDateAndFetch(dateObj) {
      const dateStr = formatDateInput(dateObj);
      if (window.flatpickrInstance) {
        window.flatpickrInstance.setDate(dateStr, true);
      } else {
        dateInput.value = dateStr;
        fetchOrders(dateStr);
      }
    }

    // Set default to today after flatpickr is ready
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        setDateAndFetch(new Date());
      }, 300);
    });

    prevBtn.addEventListener('click', () => {
      const d = new Date(dateInput.value);
      d.setDate(d.getDate() - 1);
      setDateAndFetch(d);
    });
    nextBtn.addEventListener('click', () => {
      const d = new Date(dateInput.value);
      d.setDate(d.getDate() + 1);
      setDateAndFetch(d);
    });

    // Auto-refresh orders every 30 seconds
    setInterval(() => {
      fetchOrders(dateInput.value);
    }, 30000);
  }
  </script>
  <button id="lock-page-btn" class="float-right mt-8" onclick="lockAdminPage()">Lock this page</button>
</body>
</html>