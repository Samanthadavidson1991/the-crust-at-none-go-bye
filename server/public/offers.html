<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Special Offers | None Go Bye</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Moved styles to styles.css -->
</head>
<body class="admin-page">
    <nav class="main-nav" style="margin-bottom: 24px;">
      <a href="index.html">Home</a>
      <a href="menu.html">Menu</a>
      <a href="checkout.html">Checkout</a>
      <a href="offers.html">Special Offers</a>
    </nav>
  <!-- Login redirect removed for dashboard access -->
    <script>
      // --- Populate Offer Dropdowns with Live Menu Data ---
      async function populateOfferDropdowns() {
        // Fetch sections and menu items
        const [menuRes, sectionsRes] = await Promise.all([
          fetch('/api/menu'),
          fetch('/api/sections')
        ]);
        const menuData = await menuRes.json();
        const sectionsData = await sectionsRes.json();
        const menuItems = menuData.items || [];
        const sections = sectionsData.sections || [];
        for (let i = 1; i <= 4; i++) {
          const sectionDropdown = document.getElementById(`section-dropdown-${i}`);
          const menuItemDropdown = document.getElementById(`menu-item-dropdown-${i}`);
          const sizeDropdown = document.getElementById(`size-dropdown-${i}`);
          // Populate sections
          sectionDropdown.innerHTML = '<option value="">(None)</option>';
          sections.forEach(sec => {
            const opt = document.createElement('option');
            opt.value = sec.name;
            opt.textContent = sec.name;
            sectionDropdown.appendChild(opt);
          });
          // Populate menu items and sizes on section change
          sectionDropdown.onchange = function() {
            const selectedSection = sectionDropdown.value;
            const items = menuItems.filter(item => item.section === selectedSection);
            menuItemDropdown.innerHTML = '<option value="">(None)</option>';
            items.forEach(item => {
              const opt = document.createElement('option');
              opt.value = item._id;
              opt.textContent = item.name;
              menuItemDropdown.appendChild(opt);
            });
            sizeDropdown.innerHTML = '<option value="">(None)</option>';
          };
          // Populate sizes on menu item change
          menuItemDropdown.onchange = function() {
            const item = menuItems.find(i => i._id === menuItemDropdown.value);
            sizeDropdown.innerHTML = '<option value="">(None)</option>';
            if (item && item.sizes && Array.isArray(item.sizes)) {
              item.sizes.forEach(sizeObj => {
                const opt = document.createElement('option');
                opt.value = sizeObj.name;
                opt.textContent = `${sizeObj.name} (£${parseFloat(sizeObj.price).toFixed(2)})`;
                sizeDropdown.appendChild(opt);
              });
            }
          };
        }
      }
      document.addEventListener('DOMContentLoaded', populateOfferDropdowns);
      // Login/session check
      fetch('/api/admin/check', { credentials: 'include' })
        .then(r => {
          if (!r.ok) window.location.href = 'login.html';
        });
    </script>
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <header>
    <h1 class="main-heading underline">Admin  Special Offers</h1>
    <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
      <a href="admin-menu.html">Menu Editor</a>
      <a href="stock-management.html">Stock Management</a>
      <a href="timeslots.html">Time Slots</a>
      <a href="orders.html">Orders</a>
      <a href="running-orders.html">Running Orders</a>
      <a href="takings.html">Takings</a>
      <a href="pos.html">POS Manual Order</a>
      <a href="offers.html">Special Offers</a>
      
    </nav>
  </header>
  <main>
          <section class="special-pizza-section" style="margin-bottom:32px;">
            <h2>Special Pizza (Menu Banner)</h2>
            <form id="special-pizza-form" style="margin-bottom:12px;">
              <label for="specialPizzaName"><b>Name:</b></label>
              <input type="text" id="specialPizzaName" maxlength="64" style="margin-bottom:8px;width:100%" required><br>
              <label for="specialPizzaDesc"><b>Description:</b></label>
              <input type="text" id="specialPizzaDesc" maxlength="128" style="margin-bottom:8px;width:100%"><br>
              <label for="specialPizzaPrice"><b>Price (£):</b></label>
              <input type="number" id="specialPizzaPrice" step="0.01" min="0" style="margin-bottom:8px;width:100px"><br>
              <button type="submit" class="action-btn">Save Special Pizza</button>
              <span id="special-pizza-status" class="ml-12 text-muted"></span>
            </form>
          </section>

        <script>
          // --- Special Pizza Save Logic ---
          document.getElementById('special-pizza-form').onsubmit = async function(e) {
            e.preventDefault();
            const name = document.getElementById('specialPizzaName').value.trim();
            const desc = document.getElementById('specialPizzaDesc').value.trim();
            const price = parseFloat(document.getElementById('specialPizzaPrice').value);
            const status = document.getElementById('special-pizza-status');
            if (!name) { status.textContent = 'Name required.'; return; }
            try {
              const res = await fetch('/api/special-pizza', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, desc, price })
              });
              if (!res.ok) throw new Error('Failed to save');
              status.textContent = 'Saved!';
            } catch (err) {
              status.textContent = 'Error saving.';
            }
          };
        </script>
      <script>
      // --- Lock Page Logic ---
      function lockAdminPage() {
        fetch('/api/admin/lock', { method: 'POST', credentials: 'include' })
          .then(r => {
            if (r.ok) {
              alert('Page locked. You will not be logged out automatically.');
            } else {
              alert('Failed to lock page.');
            }
          });
      }
      </script>
    <main id="main-content">
    <section class="offers-section">
        <h2>Add New Special Offer</h2>
        <form id="add-offer-form" style="margin-bottom:24px;">
          <label for="offerTitle"><b>Title:</b></label>
          <input type="text" id="offerTitle" required style="margin-bottom:8px;width:100%"><br>
          <label for="offerDesc"><b>Description:</b></label>
          <input type="text" id="offerDesc" required style="margin-bottom:8px;width:100%"><br>
          <label for="offerPrice"><b>Price (£):</b></label>
          <input type="number" id="offerPrice" step="0.01" min="0" style="margin-bottom:8px;width:100px"><br>
          <label for="offerStart"><b>Start Date:</b></label>
          <input type="date" id="offerStart" style="margin-bottom:8px;">
          <label for="offerEnd" style="margin-left:12px;"><b>End Date:</b></label>
          <input type="date" id="offerEnd" style="margin-bottom:8px;"><br>
          <h3>Menu Item(s) for Offer</h3>
          <div class="dropdown-set" id="dropdown-set-1">
            <label for="section-dropdown-1"><b>Section 1:</b></label>
            <select id="section-dropdown-1" style="margin-bottom:8px;"></select><br>
            <label for="menu-item-dropdown-1"><b>Menu Item 1:</b></label>
            <select id="menu-item-dropdown-1" style="margin-bottom:8px;"></select><br>
            <label for="size-dropdown-1"><b>Size 1:</b></label>
            <select id="size-dropdown-1" style="margin-bottom:8px;"></select><br>
          </div>
          <div class="dropdown-set" id="dropdown-set-2">
            <label for="section-dropdown-2"><b>Section 2:</b></label>
            <select id="section-dropdown-2" style="margin-bottom:8px;"></select><br>
            <label for="menu-item-dropdown-2"><b>Menu Item 2:</b></label>
            <select id="menu-item-dropdown-2" style="margin-bottom:8px;"></select><br>
            <label for="size-dropdown-2"><b>Size 2:</b></label>
            <select id="size-dropdown-2" style="margin-bottom:8px;"></select><br>
          </div>
          <div class="dropdown-set" id="dropdown-set-3">
            <label for="section-dropdown-3"><b>Section 3:</b></label>
            <select id="section-dropdown-3" style="margin-bottom:8px;"></select><br>
            <label for="menu-item-dropdown-3"><b>Menu Item 3:</b></label>
            <select id="menu-item-dropdown-3" style="margin-bottom:8px;"></select><br>
            <label for="size-dropdown-3"><b>Size 3:</b></label>
            <select id="size-dropdown-3" style="margin-bottom:8px;"></select><br>
          </div>
          <div class="dropdown-set" id="dropdown-set-4">
            <label for="section-dropdown-4"><b>Section 4:</b></label>
            <select id="section-dropdown-4" style="margin-bottom:8px;"></select><br>
            <label for="menu-item-dropdown-4"><b>Menu Item 4:</b></label>
            <select id="menu-item-dropdown-4" style="margin-bottom:8px;"></select><br>
            <label for="size-dropdown-4"><b>Size 4:</b></label>
            <select id="size-dropdown-4" style="margin-bottom:8px;"></select><br>
          </div>
          <button type="submit" class="action-btn">Add Offer</button>
        </form>
        <h2>Current Special Offers</h2>
        <div class="offer-list" id="offer-list"></div>
        <h2>Generate Voucher Codes</h2>
        <form id="voucher-form" style="margin-bottom:24px;">
          <label for="voucher-offer-select"><b>Offer (optional):</b></label>
          <select id="voucher-offer-select" style="margin-bottom:8px;"><option value="">(None)</option></select><br>
          <label for="voucher-name"><b>Name:</b></label>
          <input type="text" id="voucher-name" maxlength="64" style="margin-bottom:8px;width:200px;"><br>
          <label for="voucher-start-date"><b>Start Date (optional):</b></label>
          <input type="date" id="voucher-start-date" style="margin-bottom:8px;width:140px;"><br>
          <label for="voucher-expiry-date"><b>Expiry Date (optional):</b></label>
          <input type="date" id="voucher-expiry-date" style="margin-bottom:8px;width:140px;"><br>
          <label for="voucher-price"><b>Voucher Price (£):</b></label>
          <input type="number" id="voucher-price" step="0.01" min="0" style="margin-bottom:8px;width:100px"><br>
          <button type="button" id="generate-voucher-btn" class="action-btn">Generate Voucher</button>
        </form>
        <form id="voucher-name-form" style="margin-bottom:24px;">
          <label for="voucher-name-only"><b>Voucher Name:</b></label>
          <input type="text" id="voucher-name-only" maxlength="64" style="margin-bottom:8px;width:200px;" required>
          <button type="button" id="generate-voucher-name-btn" class="action-btn">Generate Voucher (Name Only)</button>
        </form>
        <h2>Voucher Codes</h2>
        <div id="voucher-list"></div>
  <script>
    let offers = [];

    let vouchers = [];

    // Fetch and show offers on page load
    document.addEventListener('DOMContentLoaded', fetchOffers);

    async function fetchOffers() {
      const res = await fetch('/api/offers', { credentials: 'include' });
      offers = await res.json();
      renderOffers();
      renderVoucherOfferSelect();
      fetchVouchers();
    }

    function renderOffers() {
      const list = document.getElementById('offer-list');
      if (!offers.length) {
        list.innerHTML = '<em>No special offers set.</em>';
        return;
      }
      list.innerHTML = offers.map((offer, idx) => {
        let sections = (offer.sections || []).filter(Boolean).join(', ');
        let price = offer.price ? `£${parseFloat(offer.price).toFixed(2)}` : '';
        let dateStr = '';
        if (offer.startDate || offer.endDate) {
          dateStr = `${offer.startDate ? 'From ' + new Date(offer.startDate).toLocaleDateString() : ''}${offer.endDate ? ' to ' + new Date(offer.endDate).toLocaleDateString() : ''}`;
        }
        return `
          <div class='offer-item'>
            <span><b>${offer.title}</b> - ${offer.desc}${sections ? ' <span style=\'color:#2e7d32\'>['+sections+']</span>' : ''}${price ? ' <b>'+price+'</b>' : ''} ${dateStr}</span>
            <button onclick='removeOffer("${offer._id}")'>Remove</button>
          </div>
        `;
      }).join('');
    }

    async function removeOffer(id) {
      await fetch('/api/offers/' + id, { method: 'DELETE', credentials: 'include' });
      fetchOffers();
    }

    document.getElementById('add-offer-form').onsubmit = async function(e) {
      e.preventDefault();
      const title = document.getElementById('offerTitle').value.trim();
      const desc = document.getElementById('offerDesc').value.trim();
      const sectionInputs = Array.from(document.querySelectorAll('.offer-section'));
      const sections = sectionInputs.map(i => i.value.trim()).filter(Boolean);
      const price = document.getElementById('offerPrice').value;
      const startDate = document.getElementById('offerStart').value;
      const endDate = document.getElementById('offerEnd').value;
      if (!title || !desc) return;
      await fetch('/api/offers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ title, desc, sections, price, startDate, endDate })
      });
      fetchOffers();
      this.reset();
      sectionInputs.forEach(i => i.value = '');
    };

    // --- Voucher Code Management ---
    async function fetchVouchers() {
      const res = await fetch('/api/vouchers', { credentials: 'include' });
      vouchers = await res.json();
      renderVouchers();
    }

    function renderVoucherOfferSelect() {
      const sel = document.getElementById('voucher-offer-select');
      if (!sel) {
        console.error("Element 'voucher-offer-select' not found.");
        return;
      }
      sel.innerHTML = '<option value="">(None)</option>' + offers.map(o => `<option value="${o._id}">${o.title}</option>`).join('');
    }

    const generateBtn = document.getElementById('generate-voucher-btn');
    if (generateBtn) {
      generateBtn.onclick = async function() {
        const sel = document.getElementById('voucher-offer-select');
        const offerId = sel.value;
        const startDate = document.getElementById('voucher-start-date').value;
        const expiryDate = document.getElementById('voucher-expiry-date').value;
        const price = document.getElementById('voucher-price').value;
        const name = document.getElementById('voucher-name').value.trim();
        await fetch('/api/vouchers/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ offerId: offerId || undefined, startDate, expiryDate, price, name })
        });
        fetchVouchers();
      };
    }

    const generateNameBtn = document.getElementById('generate-voucher-name-btn');
    if (generateNameBtn) {
      generateNameBtn.onclick = async function() {
        const name = document.getElementById('voucher-name-only').value.trim();
        if (!name) {
          alert('Please enter a name for the voucher.');
          return;
        }
        await fetch('/api/vouchers/generate-name', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ name })
        });
        fetchVouchers();
      };
    }

    function renderVouchers() {
      const list = document.getElementById('voucher-list');
      if (!vouchers.length) {
        list.innerHTML = '<em>No voucher codes generated yet.</em>';
        return;
      }
      list.innerHTML = `<table style='width:100%;border-collapse:collapse'><thead><tr><th>Code</th><th>Offer</th><th>Name</th><th>Voucher Price</th><th>Expires</th><th>Status</th><th>Action</th></tr></thead><tbody>` +
        vouchers.map(v => {
          let exp = v.expiresAt ? new Date(v.expiresAt).toLocaleDateString() : '-';
          let status = v.used ? `<span style='color:#b9472e'>Used</span>` : `<span style='color:#2e7d32'>Live</span>`;
          let price = v.price !== undefined && v.price !== null ? `£${parseFloat(v.price).toFixed(2)}` : '-';
          return `<tr><td><b>${v.code}</b></td><td>${v.offer ? v.offer.title : ''}</td><td>${v.name ? v.name : ''}</td><td>${price}</td><td>${exp}</td><td>${status}</td><td><button class='delete-voucher-btn' data-id='${v._id || v.code}' style='color:#b9472e'>Delete</button></td></tr>`;
        }).join('') + '</tbody></table>';
      // Add event listeners for delete buttons
      list.querySelectorAll('.delete-voucher-btn').forEach(btn => {
        btn.onclick = async function() {
          if (!confirm('Delete this voucher code?')) return;
          const id = btn.getAttribute('data-id');
          await fetch(`/api/vouchers/${id}`, { method: 'DELETE', credentials: 'include' });
          fetchVouchers();
        };
      });
    }

    // (fetchOffers now runs on DOMContentLoaded only)
  </script>
</body>
</html>