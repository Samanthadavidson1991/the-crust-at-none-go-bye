<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Special Offers | None Go Bye</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Moved styles to styles.css -->
</head>
<body class="admin-page">
    <nav class="main-nav" style="margin-bottom: 24px;">
      <a href="index.html">Home</a>
      <a href="menu.html">Menu</a>
      <a href="checkout.html">Checkout</a>
      <a href="offers.html">Special Offers</a>
    </nav>
  <!-- Login redirect removed for dashboard access -->
    <script>
      // Login/session check
      fetch('/api/admin/check', { credentials: 'include' })
        .then(r => {
          if (!r.ok) window.location.href = 'login.html';
        });
    </script>
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <header>
    <h1 class="main-heading underline">Admin  Special Offers</h1>
    <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
      <a href="admin-menu.html">Menu Editor</a>
      <a href="stock-management.html">Stock Management</a>
      <a href="timeslots.html">Time Slots</a>
      <a href="orders.html">Orders</a>
      <a href="running-orders.html">Running Orders</a>
      <a href="takings.html">Takings</a>
      <a href="pos.html">POS Manual Order</a>
      <a href="offers.html">Special Offers</a>
      
    </nav>
  </header>
  <main>
      <script>
      // --- Lock Page Logic ---
      function lockAdminPage() {
        fetch('/api/admin/lock', { method: 'POST', credentials: 'include' })
          .then(r => {
            if (r.ok) {
              alert('Page locked. You will not be logged out automatically.');
            } else {
              alert('Failed to lock page.');
            }
          });
      }
      </script>
    <main id="main-content">
    <section class="offers-section">
        <h2>Add New Special Offer</h2>
        <form id="add-offer-form" style="margin-bottom:24px;">
          <label for="offerTitle"><b>Title:</b></label>
          <input type="text" id="offerTitle" required style="margin-bottom:8px;width:100%"><br>
          <label for="offerDesc"><b>Description:</b></label>
          <input type="text" id="offerDesc" required style="margin-bottom:8px;width:100%"><br>
          <label for="offerPrice"><b>Price (£):</b></label>
          <input type="number" id="offerPrice" step="0.01" min="0" style="margin-bottom:8px;width:100px"><br>
          <label for="offerStart"><b>Start Date:</b></label>
          <input type="date" id="offerStart" style="margin-bottom:8px;">
          <label for="offerEnd" style="margin-left:12px;"><b>End Date:</b></label>
          <input type="date" id="offerEnd" style="margin-bottom:8px;"><br>
          <label><b>Sections (comma separated):</b></label>
          <input type="text" class="offer-section" placeholder="e.g. Pizzas, Sides" style="margin-bottom:8px;width:100%"><br>
          <button type="submit" class="action-btn">Add Offer</button>
        </form>
        <h2>Current Special Offers</h2>
        <div class="offer-list" id="offer-list"></div>
  <script>
    let offers = [];
    let vouchers = [];

    async function fetchOffers() {
      const res = await fetch('/api/offers', { credentials: 'include' });
      offers = await res.json();
      renderOffers();
      renderVoucherOfferSelect();
      fetchVouchers();
    }

    function renderOffers() {
      const list = document.getElementById('offer-list');
      if (!offers.length) {
        list.innerHTML = '<em>No special offers set.</em>';
        return;
      }
      list.innerHTML = offers.map((offer, idx) => {
        let sections = (offer.sections || []).filter(Boolean).join(', ');
        let price = offer.price ? `£${parseFloat(offer.price).toFixed(2)}` : '';
        let dateStr = '';
        if (offer.startDate || offer.endDate) {
          dateStr = `<span style='color:#888;font-size:0.95em'>${offer.startDate ? 'From ' + new Date(offer.startDate).toLocaleDateString() : ''}${offer.endDate ? ' to ' + new Date(offer.endDate).toLocaleDateString() : ''}</span>`;
        }
        return `
          <div class='offer-item'>
            <span><b>${offer.title}</b> - ${offer.desc}${sections ? ' <span style=\'color:#2e7d32\'>['+sections+']</span>' : ''}${price ? ' <b>'+price+'</b>' : ''} ${dateStr}</span>
            <button onclick='removeOffer("${offer._id}")'>Remove</button>
          </div>
        `;
      }).join('');
    }

    async function removeOffer(id) {
      await fetch('/api/offers/' + id, { method: 'DELETE', credentials: 'include' });
      fetchOffers();
    }

    document.getElementById('add-offer-form').onsubmit = async function(e) {
      e.preventDefault();
      const title = document.getElementById('offerTitle').value.trim();
      const desc = document.getElementById('offerDesc').value.trim();
      const sectionInputs = Array.from(document.querySelectorAll('.offer-section'));
      const sections = sectionInputs.map(i => i.value.trim()).filter(Boolean);
      const price = document.getElementById('offerPrice').value;
      const startDate = document.getElementById('offerStart').value;
      const endDate = document.getElementById('offerEnd').value;
      if (!title || !desc) return;
      await fetch('/api/offers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ title, desc, sections, price, startDate, endDate })
      });
      fetchOffers();
      this.reset();
      sectionInputs.forEach(i => i.value = '');
    };

    // --- Voucher Code Management ---
    async function fetchVouchers() {
      const res = await fetch('/api/vouchers', { credentials: 'include' });
      vouchers = await res.json();
      renderVouchers();
    }

    function renderVoucherOfferSelect() {
      const sel = document.getElementById('voucher-offer-select');
      sel.innerHTML = offers.map(o => `<option value="${o._id}">${o.title}</option>`).join('');
    }

    document.getElementById('generate-voucher-btn').onclick = async function() {
      const offerId = document.getElementById('voucher-offer-select').value;
      const days = parseInt(document.getElementById('voucher-days').value, 10);
      const price = document.getElementById('voucher-price').value;
      if (!offerId || !days) return; // alert removed for production
      await fetch('/api/vouchers/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ offerId, expiresInDays: days, price })
      });
      fetchVouchers();
    };

    function renderVouchers() {
      const list = document.getElementById('voucher-list');
      if (!vouchers.length) {
        list.innerHTML = '<em>No voucher codes generated yet.</em>';
        return;
      }
      list.innerHTML = `<table style='width:100%;border-collapse:collapse'><thead><tr><th>Code</th><th>Offer</th><th>Voucher Price</th><th>Expires</th><th>Status</th></tr></thead><tbody>` +
        vouchers.map(v => {
          let exp = v.expiresAt ? new Date(v.expiresAt).toLocaleDateString() : '-';
          let status = v.used ? `<span style='color:#b9472e'>Used</span>` : `<span style='color:#2e7d32'>Live</span>`;
          let price = v.price !== undefined && v.price !== null ? `£${parseFloat(v.price).toFixed(2)}` : '-';
          return `<tr><td><b>${v.code}</b></td><td>${v.offer ? v.offer.title : ''}</td><td>${price}</td><td>${exp}</td><td>${status}</td></tr>`;
        }).join('') + '</tbody></table>';
    }

    fetchOffers();
  </script>
</body>
</html>