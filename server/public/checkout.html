<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>None Go Bye – Checkout</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="checkout-page app-body" id="checkout-page">
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <header>
  <h1 class="main-heading underline">Inspired by Naples, perfected at None Go Bye.</h1>
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
      <a href="index.html">Home</a>
      <a href="menu.html">Menu</a>
      <a href="checkout.html">Checkout</a>
      <a href="offers-customer.html">Special Offers</a>
      <a href="allergens.html">Allergens</a>
    </nav>
  </header>
  <main>
    <main id="main-content">
      <div id="selected-offer-checkout" class="selected-offer-banner"></div>
    <section class="container">
      <h2>Order Summary</h2>
  <div class="flex-between">
        <div class="order-summary" id="order-summary">
          <p>Loading order...</p>
        </div>
  <button id="clear-checkout-btn" class="btn-clear">Clear Checkout</button>
      </div>
      <h2>Customer Details</h2>
      <form class="checkout-form">
        <label for="name">Name:</label><br>
        <input type="text" id="name" name="name" required><br><br>
        <label for="email">Email:</label><br>
        <input type="email" id="email" name="email" required><br><br>
        <label for="phone">Phone:</label><br>
        <input type="tel" id="phone" name="phone" required><br><br>
        <label for="address">Address:</label><br>
  <textarea id="address" name="address" rows="3" required></textarea><br><br>
  <label for="postcode">Postcode:</label><br>
  <input type="text" id="postcode" name="postcode" required pattern="[A-Za-z0-9 ]{5,8}" placeholder="e.g. LS18 5HZ"><br><br>
        <label for="comments">Comments or Special Requests:</label><br>
        <textarea id="comments" name="comments" rows="3" placeholder="Let us know about delivery notes or anything else..."></textarea><br><br>
        <label for="allergens">Allergens (please list any allergies):</label><br>
        <textarea id="allergens" name="allergens" rows="2" placeholder="e.g. Gluten, Nuts, Dairy"></textarea><br><br>
        <label for="voucher">Voucher Code:</label><br>
        <input type="text" id="voucher" name="voucher" placeholder="Enter voucher code"><br>
        <button type="button" id="check-voucher-btn">Check Voucher</button>
        <span id="voucher-balance" class="voucher-balance"></span>
        <span id="voucher-error" class="text-error"></span><br><br>
        <label for="date">Preferred Date:</label><br>
        <input type="date" id="date" name="date" required><br><br>
        <label for="time">Preferred Time Slot:</label><br>
        <select id="time" name="time" required>
          <option value="">Select a time slot</option>
          <option value="17:30-18:00">17:30 - 18:00</option>
          <option value="18:00-18:30">18:00 - 18:30</option>
          <option value="18:30-19:00">18:30 - 19:00</option>
          <option value="19:00-19:30">19:00 - 19:30</option>
          <option value="19:30-20:00">19:30 - 20:00</option>
          <option value="20:00-20:30">20:00 - 20:30</option>
          <option value="20:30-21:00">20:30 - 21:00</option>
          <option value="21:00-21:30">21:00 - 21:30</option>
          <option value="21:30-22:00">21:30 - 22:00</option>
        </select><br><br>
        <div class="payment-buttons">
          <button type="button" class="pay-card" id="pay-card-btn">Pay with Card</button>
          <button type="button" class="pay-cash" id="pay-cash-btn">Pay with Cash</button>
          <span id="payment-method-error" class="payment-method-error"></span>
        </div>
        <div id="card-element-container" class="card-element-container">
          <label for="card-element">Card Details:</label>
          <div id="card-element"></div>
          <div id="card-errors" class="text-error"></div>
        </div>
        <button type="submit">Place Order</button>
      </form>
    </section>
  </main>
</main>
  <footer class="delivery-footer">
    <p><b>Delivery only within a 5 mile radius of LS18 5HZ.</b></p>
  <div id="postcode-error" class="text-error"></div>
    <script>
            // --- VOUCHER LOGIC ---
            let voucherData = null;
            document.getElementById('check-voucher-btn').onclick = async function() {
              const code = document.getElementById('voucher').value.trim();
              document.getElementById('voucher-error').textContent = '';
              document.getElementById('voucher-balance').style.display = 'none';
              if (!code) {
                document.getElementById('voucher-error').textContent = 'Please enter a voucher code.';
                return;
              }
              try {
                const res = await fetch('/api/vouchers?code=' + encodeURIComponent(code));
                const vouchers = await res.json();
                const voucher = Array.isArray(vouchers) ? vouchers.find(v => v.code === code) : null;
                if (!voucher) {
                  document.getElementById('voucher-error').textContent = 'Voucher not found.';
                  return;
                }
                if (voucher.used) {
                  document.getElementById('voucher-error').textContent = 'Voucher already used.';
                  return;
                }
                voucherData = voucher;
                document.getElementById('voucher-balance').textContent = voucher.price ? `Voucher balance: £${voucher.price.toFixed(2)}` : 'Voucher valid.';
                document.getElementById('voucher-balance').style.display = 'inline';
              } catch (err) {
                document.getElementById('voucher-error').textContent = 'Error checking voucher.';
              }
            };
        // Show selected offer in checkout
        async function showSelectedOfferCheckout() {
          const selectedId = localStorage.getItem('selectedOffer');
          if (!selectedId) {
            document.getElementById('selected-offer-checkout').style.display = 'none';
            return;
          }
          const res = await fetch('/api/offers');
          const offers = await res.json();
          const offer = offers.find(o => o._id === selectedId);
          if (offer) {
            document.getElementById('selected-offer-checkout').style.display = 'block';
            // Show selected item, size, and extra price if set
            const selectedItemId = localStorage.getItem('selectedOfferItem');
            const selectedSize = localStorage.getItem('selectedOfferItemSize');
            const extra = localStorage.getItem('selectedOfferItemExtra');
            let itemName = '';
            if (selectedItemId && window.globalMenu) {
              const item = window.globalMenu.find(i => i._id === selectedItemId);
              if (item) itemName = item.name;
            }
            let sizeText = '';
            if (selectedSize) sizeText = ` <span class='selected-size'>[${selectedSize}]</span>`;
            let extraText = '';
            if (extra && !isNaN(extra) && Number(extra) > 0) {
              extraText = ` <span style='color:#b9472e'>(+£${Number(extra).toFixed(2)} extra)</span>`;
            }
            // Make banner clickable
            document.getElementById('selected-offer-checkout').innerHTML = `<a href="#" id="edit-offer-banner" style="text-decoration:none;color:inherit;cursor:pointer;"><b>Selected Offer:</b> ${offer.title} - ${offer.desc} ${offer.price ? '£'+parseFloat(offer.price).toFixed(2) : ''}${itemName ? '<br><b>Item:</b> ' + itemName : ''}${sizeText}${extraText}<br><span style='font-size:0.95em;color:#b9472e;text-decoration:underline;'>Click to change</span></a>`;
            document.getElementById('edit-offer-banner').onclick = function(e) {
              e.preventDefault();
              // Open offer selection modal (reuse logic from offers-customer.html)
              chooseOfferById(offer._id);
            };
          } else {
            document.getElementById('selected-offer-checkout').style.display = 'none';
          }
        }
// Helper to open offer selection modal by offerId (copied from offers-customer.html logic)
function chooseOfferById(offerId) {
  fetch('/api/offers').then(r => r.json()).then(offers => {
    const offer = offers.find(o => o._id === offerId);
    if (!offer || !offer.offerItems || !offer.offerItems.length) {
      alert('No eligible items for this offer.');
      return;
    }
    fetch('/api/menu').then(r => r.json()).then(menuData => {
      const globalMenu = menuData.items || [];
      let itemList = offer.offerItems.map((oi, i) => {
        const menuItem = globalMenu.find(m => m._id === oi.itemId);
        let extra = oi.extra && !isNaN(oi.extra) ? ` (+£${parseFloat(oi.extra).toFixed(2)})` : '';
        return `<option value='${i}'>${menuItem ? menuItem.name : oi.itemId}${extra}</option>`;
      }).join('');
      let html = `<div style='padding:18px;'>
        <b>Choose your item for this offer:</b><br>
        <select id='offer-item-select'>${itemList}</select>
        <div id='offer-size-select-div' style='margin-top:12px;'></div>
        <button id='confirm-offer-item-btn'>Confirm</button>
      </div>`;
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.3)';
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = '9999';
      modal.innerHTML = `<div style='background:#fff;padding:32px;border-radius:10px;box-shadow:0 2px 12px #0002;'>${html}</div>`;
      document.body.appendChild(modal);
      // Size selection logic
      function renderSizes(idx) {
        const oi = offer.offerItems[idx];
        if (!oi || !oi.sizes || !oi.sizes.length) {
          document.getElementById('offer-size-select-div').innerHTML = '';
          return;
        }
        let sizeList = oi.sizes.map((sz, j) => {
          let extra = sz.extra && !isNaN(sz.extra) ? ` (+£${parseFloat(sz.extra).toFixed(2)})` : '';
          return `<option value='${j}'>${sz.name}${extra}</option>`;
        }).join('');
        document.getElementById('offer-size-select-div').innerHTML = `<b>Choose size:</b><br><select id='offer-size-select'>${sizeList}</select>`;
      }
      // Initial render
      renderSizes(0);
      modal.querySelector('#offer-item-select').onchange = function() {
        renderSizes(this.value);
      };
      modal.querySelector('#confirm-offer-item-btn').onclick = function() {
        const itemIdx = modal.querySelector('#offer-item-select').value;
        const oi = offer.offerItems[itemIdx];
        let extra = oi.extra && !isNaN(oi.extra) ? parseFloat(oi.extra) : 0;
        let selectedSize = null;
        let sizeExtra = 0;
        if (oi.sizes && oi.sizes.length) {
          const sizeIdx = modal.querySelector('#offer-size-select').value;
          if (sizeIdx !== undefined && oi.sizes[sizeIdx]) {
            selectedSize = oi.sizes[sizeIdx].name;
            if (oi.sizes[sizeIdx].extra && !isNaN(oi.sizes[sizeIdx].extra)) {
              sizeExtra = parseFloat(oi.sizes[sizeIdx].extra);
            }
          }
        }
        localStorage.setItem('selectedOffer', offer._id);
        localStorage.setItem('selectedOfferItem', oi.itemId);
        if (selectedSize) localStorage.setItem('selectedOfferItemSize', selectedSize);
        else localStorage.removeItem('selectedOfferItemSize');
        const totalExtra = (extra || 0) + (sizeExtra || 0);
        if (totalExtra > 0) {
          localStorage.setItem('selectedOfferItemExtra', totalExtra);
        } else {
          localStorage.removeItem('selectedOfferItemExtra');
        }
        document.body.removeChild(modal);
        showSelectedOfferCheckout();
        renderOrderSummary();
        alert('Offer and item selected! You can now use it at checkout.');
      };
    });
  });
}
          // Fetch menu for item name lookup in offer banner
          window.globalMenu = [];
          (async function() {
            try {
              const res = await fetch('/api/menu');
              const menuData = await res.json();
              window.globalMenu = menuData.items || [];
            } catch {}
          })();
        }
        showSelectedOfferCheckout();
      // --- POSTCODE DISTANCE CHECK ---
      async function getDeliveryDistanceLimit() {
        try {
          const res = await fetch('https://admin.thecrustatngb.co.uk/api/delivery-distance');
          if (!res.ok) throw new Error('Failed');
          const data = await res.json();
          return data.miles || 5;
        } catch {
          return 5;
        }
      }
      // Use postcodes.io for distance calculation (POST, not GET)
      async function getDistanceMiles(from, to) {
        // Validate both postcodes are non-empty and look like UK postcodes
        const postcodeRegex = /^[A-Z]{1,2}[0-9][0-9A-Z]? ?[0-9][A-Z]{2}$/;
        if (!from || !to) {
          return { error: 'Both shop and customer postcodes are required.' };
        }
        if (!postcodeRegex.test(from) || !postcodeRegex.test(to)) {
          return { error: 'Please enter valid UK postcodes for both shop and customer.' };
        }
        async function fetchDistance(postcodes) {
          const url = 'https://api.postcodes.io/postcodes';
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ postcodes })
          });
          const data = await res.json();
          if (!data.result || !Array.isArray(data.result) || data.result.length < 2) throw new Error('API error');
          const [fromRes, toRes] = data.result;
          if (!fromRes.result) throw new Error('Shop postcode not found');
          if (!toRes.result) throw new Error('Customer postcode not found');
          const lat1 = fromRes.result.latitude, lon1 = fromRes.result.longitude;
          const lat2 = toRes.result.latitude, lon2 = toRes.result.longitude;
          // Haversine formula
          const R = 3958.8; // miles
          const dLat = (lat2-lat1) * Math.PI/180;
          const dLon = (lon2-lon1) * Math.PI/180;
          const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          return R * c;
        }
        try {
          return await fetchDistance([from, to]);
        } catch (err) {
          console.error('Postcodes.io API error (first attempt):', err);
          // Try once more after cleaning postcode
          const cleanTo = to.replace(/\s+/g, '').toUpperCase();
          const cleanFrom = from.replace(/\s+/g, '').toUpperCase();
          if (!postcodeRegex.test(cleanFrom) || !postcodeRegex.test(cleanTo)) {
            return { error: 'Please enter valid UK postcodes for both shop and customer.' };
          }
          try {
            return await fetchDistance([cleanFrom, cleanTo]);
          } catch (err2) {
            console.error('Postcodes.io API error (second attempt):', err2);
            return { error: err2.message || 'Could not verify postcode. Please check and try again.' };
          }
        }
      }
      function renderOrderSummary() {
        const order = JSON.parse(localStorage.getItem('order') || '[]');
        const summaryDiv = document.getElementById('order-summary');
        // Offer selection
        const selectedOfferId = localStorage.getItem('selectedOffer');
        const selectedOfferItemId = localStorage.getItem('selectedOfferItem');
        const selectedOfferItemSize = localStorage.getItem('selectedOfferItemSize');
        const selectedOfferItemExtra = localStorage.getItem('selectedOfferItemExtra');
        let offerHtml = '';
        if (selectedOfferId && selectedOfferItemId) {
          let itemName = '';
          if (window.globalMenu) {
            const item = window.globalMenu.find(i => i._id === selectedOfferItemId);
            if (item) itemName = item.name;
          }
          let sizeText = selectedOfferItemSize ? ` <span class='selected-size'>[${selectedOfferItemSize}]</span>` : '';
          let extraText = '';
          if (selectedOfferItemExtra && !isNaN(selectedOfferItemExtra) && Number(selectedOfferItemExtra) > 0) {
            extraText = ` <span style='color:#b9472e'>(+£${Number(selectedOfferItemExtra).toFixed(2)} extra)</span>`;
          }
          offerHtml = `<li><b>Special Offer Item:</b> ${itemName}${sizeText}${extraText}</li>`;
        }
        if (!order.length && !offerHtml) {
          summaryDiv.innerHTML = '<p>Your order is currently empty.</p>';
          return;
        }
        let html = '<ul class="unstyled-list">';
        if (offerHtml) html += offerHtml;
        order.forEach((item, idx) => {
          let line = `<b>${item.name}</b>`;
          if (item.selectedSize) line += ` <span class='selected-size'>[${item.selectedSize.name}]</span>`;
          if (item.selectedSide) line += ` <span class='selected-size'>[${item.selectedSide.name}]</span>`;
          if (item.toppings && Array.isArray(item.toppings) && item.toppings.length) line += ` <span class='toppings-list-inline'>Toppings: ${item.toppings.join(', ')}</span>`;
          if (item.masterToppings && Array.isArray(item.masterToppings) && item.masterToppings.length) line += ` <span class='toppings-list-inline'>Added: ${item.masterToppings.join(', ')}</span>`;
          if (item.removed && Array.isArray(item.removed) && item.removed.length) line += ` <span class='removed-list'>Removed: ${item.removed.join(', ')}</span>`;
          line += ` x${item.quantity} - £${(parseFloat(item.price) * item.quantity).toFixed(2)}`;
          line += ` <button class='remove-item-btn'>Remove</button>`;
          html += `<li>${line}</li>`;
        });
        html += '</ul>';
        summaryDiv.innerHTML = html;
        document.querySelectorAll('.remove-item-btn').forEach(btn => {
          btn.onclick = function() {
            const idx = parseInt(this.getAttribute('data-idx'), 10);
            let order = JSON.parse(localStorage.getItem('order') || '[]');
            order.splice(idx, 1);
            localStorage.setItem('order', JSON.stringify(order));
            renderOrderSummary();
          };
        });
      }
      document.addEventListener('DOMContentLoaded', function() {
                // --- STRIPE JS INTEGRATION ---
                let stripe, elements, cardElement;
                async function setupStripe() {
                  if (!stripe) {
                    stripe = Stripe('pk_live_51Rw3qTGYjsS5ePNSGGE1xAaSInE9YDZwbPaGaqu7g1Cdj2yG1t7Cp7civr7PAjg7RC22flAaDwx0PAJj40hQe8JC001sS83TsB');
                    elements = stripe.elements();
                    const cardStyle = {
                      style: {
                        base: {
                          color: '#111',
                          fontFamily: 'Quicksand, Arial, sans-serif',
                          fontSize: '1.2rem',
                          fontWeight: '600',
                          '::placeholder': {
                            color: '#b9472e',
                            fontWeight: '400',
                            fontSize: '1.1rem',
                          },
                          iconColor: '#b9472e',
                          backgroundColor: '#fffbe6',
                          padding: '10px 0',
                        },
                        invalid: {
                          color: '#b9472e',
                          iconColor: '#b9472e',
                        }
                      }
                    };
                    cardElement = elements.create('card', cardStyle);
                    cardElement.mount('#card-element');
                    cardElement.on('change', function(event) {
                      document.getElementById('card-errors').textContent = event.error ? event.error.message : '';
                    });
                  }
                }
        // Restrict date picker to Friday, Saturday, Sunday only
        const dateInput = document.getElementById('date');
        dateInput.addEventListener('input', function() {
          const d = new Date(this.value);
          // 5 = Friday, 6 = Saturday, 0 = Sunday
          if (![5,6,0].includes(d.getDay())) {
            this.setCustomValidity('Orders can only be placed for Friday, Saturday, or Sunday.');
          } else {
            this.setCustomValidity('');
          }
        });
        // Optionally, set min date to next Friday if today is not Fri/Sat/Sun
        function getNextAllowedDate(from) {
          const d = new Date(from);
          for (let i = 0; i < 7; i++) {
            const day = d.getDay();
            if ([5,6,0].includes(day)) return d;
            d.setDate(d.getDate() + 1);
          }
          return d;
        }
        const today = new Date();
        const nextAllowed = getNextAllowedDate(today);
        dateInput.min = nextAllowed.toISOString().slice(0,10);
        renderOrderSummary();
        document.getElementById('clear-checkout-btn').onclick = function() {
          localStorage.removeItem('order');
          renderOrderSummary();
        };
        // Payment button highlight logic
        window.selectedPayment = null;
        const cashBtn = document.getElementById('pay-cash-btn');
        const cardBtn = document.getElementById('pay-card-btn');
        function updatePaymentButtons() {
          cashBtn.classList.toggle('selected', window.selectedPayment === 'cash');
          cardBtn.classList.toggle('selected', window.selectedPayment === 'card');
        }
        cashBtn.addEventListener('click', function() {
          window.selectedPayment = 'cash';
          updatePaymentButtons();
          document.getElementById('card-element-container').style.display = 'none';
        });
        cardBtn.addEventListener('click', function() {
          window.selectedPayment = 'card';
          updatePaymentButtons();
          document.getElementById('card-element-container').style.display = 'block';
          setupStripe();
        });
        // Optionally, you can require a payment method before submitting the order
        // Intercept form submit for postcode check
        document.querySelector('.checkout-form').onsubmit = async function(e) {
          // If special offer is selected, add to orderData
          const selectedOfferId = localStorage.getItem('selectedOffer');
          const selectedOfferItemId = localStorage.getItem('selectedOfferItem');
          const selectedOfferItemSize = localStorage.getItem('selectedOfferItemSize');
          const selectedOfferItemExtra = localStorage.getItem('selectedOfferItemExtra');
          if (selectedOfferId && selectedOfferItemId) {
            orderData.specialOffer = {
              offerId: selectedOfferId,
              itemId: selectedOfferItemId,
              size: selectedOfferItemSize || '',
              extra: selectedOfferItemExtra ? Number(selectedOfferItemExtra) : 0
            };
            orderData.total += orderData.specialOffer.extra || 0;
          }
          // If voucher is present, check and apply
          if (voucherData && voucherData.price) {
            // Deduct voucher value from total
            orderData.voucherCode = voucherData.code;
            orderData.voucherAmount = voucherData.price;
            orderData.total = Math.max(0, orderData.total - voucherData.price);
          }
          e.preventDefault();
          document.getElementById('postcode-error').textContent = '';
          // Require payment method
          if (!window.selectedPayment) {
            document.getElementById('payment-method-error').textContent = 'Please select a payment method (cash or card).';
            document.getElementById('payment-method-error').style.display = 'inline';
            return false;
          } else {
            document.getElementById('payment-method-error').textContent = '';
            document.getElementById('payment-method-error').style.display = 'none';
          }
          window.manualApproval = false;
          let postcode = document.getElementById('postcode').value.trim().toUpperCase();
          // Auto-insert space if missing and length is 6 or 7
          if (!postcode.includes(' ') && postcode.length >= 6 && postcode.length <= 8) {
            postcode = postcode.slice(0, postcode.length - 3) + ' ' + postcode.slice(-3);
          }
          // Validate postcode format (UK postcode regex)
          const postcodeRegex = /^[A-Z]{1,2}[0-9][0-9A-Z]? ?[0-9][A-Z]{2}$/;
          if (!postcode) {
            document.getElementById('postcode-error').textContent = 'Please enter your postcode.';
            return false;
          }
          if (!postcodeRegex.test(postcode)) {
            document.getElementById('postcode-error').textContent = 'Please enter a valid UK postcode (e.g. LS18 5HZ).';
            return false;
          }
          document.getElementById('postcode').value = postcode;
          const limit = await getDeliveryDistanceLimit();
          const milesResult = await getDistanceMiles('LS18 5HZ', postcode);
          if (typeof milesResult === 'object' && milesResult && milesResult.error) {
            document.getElementById('postcode-error').textContent = '⚠️ We could not verify your postcode automatically. Your order will be submitted for manual approval. We will contact you soon.';
            window.manualApproval = true;
          } else if (milesResult === null) {
            document.getElementById('postcode-error').textContent = 'Could not verify postcode. Please check and try again.';
            return false;
          } else if (milesResult > limit) {
            document.getElementById('postcode-error').textContent = `Sorry, you are ${milesResult.toFixed(2)} miles away. We only deliver within ${limit} miles of LS18 5HZ.`;
            return false;
          }
          // Gather order details
          const orderItems = JSON.parse(localStorage.getItem('order') || '[]');
          if (!orderItems.length) {
            document.getElementById('postcode-error').textContent = 'Your order is empty.';
            return false;
          }
          const name = document.getElementById('name').value.trim();
          const email = document.getElementById('email').value.trim();
          const phone = document.getElementById('phone').value.trim();
          const address = document.getElementById('address').value.trim();
          const comments = document.getElementById('comments').value.trim();
          const allergens = document.getElementById('allergens').value.trim();
          const timeSlot = document.getElementById('time').value;
          let total = 0;
          orderItems.forEach(item => {
            total += (parseFloat(item.price) || 0) * (item.quantity || 1);
          });
          const paymentType = window.selectedPayment ? window.selectedPayment.toLowerCase() : 'card';
          const orderData = {
            slotId: timeSlot,
            name,
            type: 'Delivery',
            address: { full: address, postcode, email },
            items: orderItems.map(item => ({
              name: item.name,
              size: item.selectedSize ? item.selectedSize.name : '',
              quantity: item.quantity,
              price: item.price,
              notes: item.notes || ''
            })),
            timeSlot,
            status: window.manualApproval ? 'Pending Manual Approval' : undefined,
            customerNotes: comments,
            allergens: allergens,
            total: parseFloat(total.toFixed(2)),
            paymentType,
            source: 'web'
          };
          if (paymentType === 'card') {
            // Stripe payment flow
            try {
              // 1. Create payment intent
              const piRes = await fetch('/api/create-payment-intent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: orderData.total, currency: 'gbp' })
              });
              const piData = await piRes.json();
              if (!piRes.ok || !piData.clientSecret) {
                document.getElementById('card-errors').textContent = piData.error || 'Payment failed.';
                return false;
              }
              // 2. Confirm card payment
              const { error, paymentIntent } = await stripe.confirmCardPayment(piData.clientSecret, {
                payment_method: {
                  card: cardElement,
                  billing_details: { name, email }
                }
              });
              if (error) {
                document.getElementById('card-errors').textContent = error.message;
                return false;
              }
              if (paymentIntent && paymentIntent.status === 'succeeded') {
                // 3. Submit order to backend
                const res = await fetch('https://admin.thecrustatngb.co.uk/api/orders', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(orderData)
                });
                if (!res.ok) {
                  const err = await res.json();
                  document.getElementById('postcode-error').textContent = err.error || 'Order failed.';
                  return false;
                }
                localStorage.removeItem('order');
                renderOrderSummary();
                this.reset();
                document.getElementById('card-element-container').style.display = 'none';
                document.getElementById('card-errors').textContent = '';
              }
            } catch (err) {
              document.getElementById('card-errors').textContent = 'Payment failed. Please try again.';
              return false;
            }
          } else {
            // Cash payment flow (original)
            try {
              const res = await fetch('https://admin.thecrustatngb.co.uk/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
              });
              if (!res.ok) {
                const err = await res.json();
                document.getElementById('postcode-error').textContent = err.error || 'Order failed.';
                return false;
              }
              localStorage.removeItem('order');
              renderOrderSummary();
              this.reset();
            } catch (err) {
              document.getElementById('postcode-error').textContent = 'Order failed. Please try again.';
            }
          }
        };
      });
    </script>
  </footer>
  <script src="https://js.stripe.com/v3/"></script>
</body>
</html>