<!-- copilot-test-2026 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Time Slot Management | None Go Bye</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .admin-section { max-width: 700px; margin: 40px auto; background: #f3f7ef; border-radius: 16px; padding: 32px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
    .admin-section h2 { margin-top: 0; }
    .timeslot-table { width: 100%; border-collapse: collapse; margin-top: 24px; }
    .timeslot-table th, .timeslot-table td { padding: 12px; border-bottom: 1px solid #ccc; text-align: left; }
    .timeslot-table th { background: #e9ece5; }
    .timeslot-table tr:last-child td { border-bottom: none; }
    .action-btn { background: #b9472e; color: #fff; border: none; border-radius: 8px; padding: 6px 16px; font-weight: bold; cursor: pointer; }
    .input { padding: 6px; border-radius: 6px; border: 1px solid #ccc; }
  </style>
</head>
<body class="admin-page">
    <!-- Removed duplicate nav/header -->
    <div class="tab-nav" style="display: flex; gap: 12px; justify-content: center; margin-bottom: 24px;">
      <button class="tab-btn" id="tab-delivery" onclick="showTab('delivery')">Delivery Distance</button>
      <button class="tab-btn" id="tab-timeslots" onclick="showTab('timeslots')">Time Slots</button>
      <button class="tab-btn" id="tab-opening" onclick="showTab('opening')">Opening Times</button>
    </div>
    <style>
      .tab-btn { padding: 8px 18px; border: none; border-radius: 8px 8px 0 0; background: #e9ece5; color: #333; font-weight: bold; cursor: pointer; }
      .tab-btn.active { background: #b9472e; color: #fff; }
      .tab-content { display: none; }
      .tab-content.active { display: block; }
    </style>
    <script>
      // Login/session check
      fetch('/api/admin/check', { credentials: 'include' })
        .then(r => {
          if (!r.ok) window.location.href = 'login.html';
        });
      // --- Lock Page Logic ---
      function lockAdminPage() {
        fetch('/api/admin/lock', { method: 'POST', credentials: 'include' })
          .then(r => {
            if (r.ok) {
              alert('Page locked. You will not be logged out automatically.');
            } else {
              alert('Failed to lock page.');
            }
          });
      }
    </script>
    <script src="/admin-order-toast.js"></script>
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <header>
    <h1 class="main-heading underline">Admin  Time Slot Management</h1>
    <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
      <a href="admin-menu.html">Menu Editor</a>
      <a href="stock-management.html">Stock Management</a>
      <a href="timeslots.html">Time Slots</a>
      <a href="orders.html">Orders</a>
      <a href="running-orders.html">Running Orders</a>
      <a href="takings.html">Takings</a>
      <a href="pos.html">POS Manual Order</a>
      <a href="offers.html">Special Offers</a>
      <a href="#" class="nav-disabled">Dashboard (coming soon)</a>
    </nav>
    <main id="main-content">
    <section class="admin-section">
      <div id="tab-content-delivery" class="tab-content">
        <h2>Delivery Distance Limit</h2>
        <form id="delivery-distance-form" class="mb-24">
          <label for="delivery-distance">Max Delivery Distance (miles) from LS18 5HZ:</label>
          <input type="number" id="delivery-distance" class="input" min="1" max="20" value="5" step="0.1" required>
          <button type="submit" class="action-btn">Save Distance</button>
          <span id="delivery-distance-status" class="ml-12 text-muted"></span>
        </form>
      </div>
      <div id="tab-content-timeslots" class="tab-content">
        <h2>Manage Time Slots</h2>
        <h3>Auto-Generate Time Slots</h3>
        <form id="generate-slots-form" class="mb-24">
          <label for="slot-day">Day:</label>
          <select id="slot-day" class="input">
            <option value="friday">Friday</option>
            <option value="saturday">Saturday</option>
            <option value="sunday">Sunday</option>
          </select>
          <label for="slot-duration" class="ml-12">Duration (minutes):</label>
          <input type="number" id="slot-duration" class="input" min="5" max="120" value="30" required>
          <label for="slot-dough-limit" class="ml-12">Dough per slot:</label>
          <input type="number" id="slot-dough-limit" class="input" min="0" max="99" value="0" required>
          <button type="submit" class="action-btn">Generate Slots</button>
          <span id="generate-slots-status" class="ml-12 text-muted"></span>
        </form>
        <form id="add-timeslot-form" class="mb-24">
          <input type="text" id="timeslot-input" class="input" placeholder="e.g. 17:00-17:30" required>
          <button type="submit" class="action-btn">Add Time Slot</button>
        </form>
        <div id="timeslot-list">Loading...</div>
      </div>
      <div id="tab-content-opening" class="tab-content">
        <h2>Set Opening Times</h2>
        <form id="opening-times-form" class="mb-24">
          <div>
            <label>Friday:</label>
            <input type="time" id="friday-open" class="input" required title="Friday opening time" placeholder="Open"> -
            <input type="time" id="friday-close" class="input" required title="Friday closing time" placeholder="Close">
          </div>
          <div>
            <label>Saturday:</label>
            <input type="time" id="saturday-open" class="input" required title="Saturday opening time" placeholder="Open"> -
            <input type="time" id="saturday-close" class="input" required title="Saturday closing time" placeholder="Close">
          </div>
          <div>
            <label>Sunday:</label>
            <input type="time" id="sunday-open" class="input" required title="Sunday opening time" placeholder="Open"> -
            <input type="time" id="sunday-close" class="input" required title="Sunday closing time" placeholder="Close">
          </div>
          <button type="submit" class="action-btn">Save Opening Times</button>
          <span id="opening-times-status" class="ml-12 text-muted"></span>
        </form>
      </div>
    </section>

  <!-- ...existing section code... -->
  <script>
    // --- DELIVERY DISTANCE ---
    async function loadDeliveryDistance() {
      try {
          const res = await fetch('/api/delivery-distance');
        if (!res.ok) throw new Error('Failed to load');
        const data = await res.json();
        document.getElementById('delivery-distance').value = data.miles || 5;
      } catch (e) {
        document.getElementById('delivery-distance-status').textContent = 'Could not load distance.';
      }
    }
    document.getElementById('delivery-distance-form').onsubmit = async function(e) {
      e.preventDefault();
      const miles = parseFloat(document.getElementById('delivery-distance').value);
      try {
          const res = await fetch('/api/delivery-distance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ miles })
        });
        if (!res.ok) throw new Error('Failed to save');
        document.getElementById('delivery-distance-status').textContent = 'Saved!';
      } catch (e) {
        document.getElementById('delivery-distance-status').textContent = 'Error saving.';
      }
    };
    // --- FUNCTIONS ---
    async function generateSlots() {
      const day = document.getElementById('slot-day').value;
      const duration = parseInt(document.getElementById('slot-duration').value, 10);
      if (!day || isNaN(duration) || duration < 5) return;
      // Get opening/closing times for the selected day
      let times;
      try {
          const res = await fetch('/api/opening-times');
        times = await res.json();
      } catch (err) {
        document.getElementById('generate-slots-status').textContent = 'Error loading opening times.';
        return;
      }
      const open = times[day]?.open;
      const close = times[day]?.close;
      if (!open || !close) {
        document.getElementById('generate-slots-status').textContent = 'Set opening/closing times first.';
        return;
      }
      // Generate slots
      const doughLimit = parseInt(document.getElementById('slot-dough-limit').value, 10) || 0;
      const slots = [];
      let start = toMinutes(open);
      const end = toMinutes(close);
      while (start + duration <= end) {
        const slotStart = fromMinutes(start);
        const slotEnd = fromMinutes(start + duration);
        slots.push({ time: `${slotStart}-${slotEnd}`, doughLimit });
        start += duration;
      }
      // Send to backend
      await fetch('/api/timeslots/batch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slots })
      });
      document.getElementById('generate-slots-status').textContent = 'Slots generated!';
      fetchTimeSlots();
    }

    function toMinutes(timeStr) {
      const [h, m] = timeStr.split(':').map(Number);
      return h * 60 + m;
    }

    function fromMinutes(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }

    async function fetchOpeningTimes() {
      try {
          const res = await fetch('/api/opening-times');
        const times = await res.json();
        // Helper to ensure valid time string
        function safeTime(val) {
          return (typeof val === 'string' && /^\d{2}:\d{2}$/.test(val)) ? val : '00:00';
        }
        if (times.friday) {
          document.getElementById('friday-open').value = safeTime(times.friday.open);
          document.getElementById('friday-close').value = safeTime(times.friday.close);
        }
        if (times.saturday) {
          document.getElementById('saturday-open').value = safeTime(times.saturday.open);
          document.getElementById('saturday-close').value = safeTime(times.saturday.close);
        }
        if (times.sunday) {
          document.getElementById('sunday-open').value = safeTime(times.sunday.open);
          document.getElementById('sunday-close').value = safeTime(times.sunday.close);
        }
      } catch (err) {
        document.getElementById('opening-times-status').textContent = 'Error loading opening times.';
      }
    }

    async function saveOpeningTimes() {
      const friday = {
        open: document.getElementById('friday-open').value,
        close: document.getElementById('friday-close').value
      };
      const saturday = {
        open: document.getElementById('saturday-open').value,
        close: document.getElementById('saturday-close').value
      };
      const sunday = {
        open: document.getElementById('sunday-open').value,
        close: document.getElementById('sunday-close').value
      };
      await fetch('/api/opening-times', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ friday, saturday, sunday })
      });
      document.getElementById('opening-times-status').textContent = 'Saved!';
      // Prompt user to regenerate slots for each updated day
      setTimeout(() => {
        if (confirm('Opening times updated! Would you like to auto-generate time slots for each day now?')) {
          autoGenerateAllDays([friday, saturday, sunday]);
        }
      }, 500);
    }

    async function autoGenerateAllDays(daysArr) {
      const dayNames = ['friday', 'saturday', 'sunday'];
      const duration = parseInt(document.getElementById('slot-duration').value, 10) || 30;
      const doughLimit = parseInt(document.getElementById('slot-dough-limit').value, 10) || 0;
      for (let i = 0; i < daysArr.length; i++) {
        const open = daysArr[i].open;
        const close = daysArr[i].close;
        if (!open || !close) continue;
        const slots = [];
        let start = toMinutes(open);
        const end = toMinutes(close);
        while (start + duration <= end) {
          const slotStart = fromMinutes(start);
          const slotEnd = fromMinutes(start + duration);
          slots.push({ time: `${slotStart}-${slotEnd}`, doughLimit });
          start += duration;
        }
        await fetch('/api/timeslots/batch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slots })
        });
      }
      fetchTimeSlots();
    }

    async function fetchTimeSlots() {
      const listDiv = document.getElementById('timeslot-list');
      listDiv.textContent = 'Loading...';
      try {
        const res = await fetch('/api/timeslots');
        const slots = await res.json();
        if (!Array.isArray(slots) || slots.length === 0) {
          listDiv.textContent = 'No time slots yet.';
          return;
        }
        listDiv.innerHTML = `<table class="timeslot-table">
          <thead><tr><th>Time Slot</th><th>Delivery Amount</th><th>Action</th></tr></thead>
          <tbody>
            ${slots.map(slot => `
              <tr>
                <td>${slot.time}</td>
                <td><input type="number" min="0" max="99" value="${typeof slot.deliveryAmount === 'number' ? slot.deliveryAmount : 0}" data-slot-id="${slot._id}" class="delivery-input" style="width:60px;" /></td>
                <td><button class="action-btn" onclick="deleteTimeSlot('${slot._id}')">Delete</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;
        // Add event listeners for delivery amount inputs
        document.querySelectorAll('.delivery-input').forEach(input => {
          input.addEventListener('change', async function() {
            const id = this.getAttribute('data-slot-id');
            const newVal = parseInt(this.value, 10) || 0;
            await fetch(`/api/timeslots/${id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ deliveryAmount: newVal })
            });
          });
        });
      } catch (err) {
        listDiv.textContent = 'Error loading time slots.';
      }
    }

    async function addTimeSlot() {
      const input = document.getElementById('timeslot-input');
      const doughLimitInput = document.getElementById('slot-dough-limit');
      const time = input.value.trim();
      const doughLimit = parseInt(doughLimitInput.value, 10) || 0;
      if (!time) return;
      await fetch('/api/timeslots', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ time, doughLimit })
      });
      input.value = '';
      fetchTimeSlots();
    }

    async function deleteTimeSlot(id) {
      await fetch(`/api/timeslots/${id}`, {
        method: 'DELETE'
      });
      fetchTimeSlots();
    }

    window.deleteTimeSlot = deleteTimeSlot;

    // --- DOMContentLoaded ---
    document.addEventListener('DOMContentLoaded', function() {
  loadDeliveryDistance();
      fetchTimeSlots();
      fetchOpeningTimes();
      document.getElementById('add-timeslot-form').onsubmit = function(e) {
        e.preventDefault();
        addTimeSlot();
      };
      document.getElementById('opening-times-form').onsubmit = function(e) {
        e.preventDefault();
        saveOpeningTimes();
      };
      document.getElementById('generate-slots-form').onsubmit = function(e) {
        e.preventDefault();
        generateSlots();
      };
    });
  </script>
  <button id="lock-page-btn" class="float-right mt-8" onclick="lockAdminPage()">Lock this page</button>

<script>
function showTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
  if (tab === 'delivery') {
    document.getElementById('tab-delivery').classList.add('active');
    document.getElementById('tab-content-delivery').classList.add('active');
  } else if (tab === 'timeslots') {
    document.getElementById('tab-timeslots').classList.add('active');
    document.getElementById('tab-content-timeslots').classList.add('active');
  } else if (tab === 'opening') {
    document.getElementById('tab-opening').classList.add('active');
    document.getElementById('tab-content-opening').classList.add('active');
  }
}
// Set default tab on load
document.addEventListener('DOMContentLoaded', function() {
  showTab('delivery');
});
</script>
</body>
</html>
