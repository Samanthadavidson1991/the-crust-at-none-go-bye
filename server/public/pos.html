<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POS Manual Order | None Go Bye</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body { background: #f3f7ef; }
    .pos3col-container { max-width: 1200px; margin: 32px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px #0001; padding: 32px; }
    .pos3col-title { grid-column: 1 / span 3; text-align: center; margin-bottom: 24px; }
    .pos3col-grid { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 32px; }
    .pos3col-left, .pos3col-center, .pos3col-right { background: #f8faf7; border-radius: 8px; padding: 18px; min-height: 600px; }
    .pos3col-left label, .pos3col-right label { font-weight: bold; margin-top: 12px; display: block; }
    .pos3col-left input, .pos3col-left select, .pos3col-left textarea,
    .pos3col-right input, .pos3col-right select, .pos3col-right textarea {
      width: 100%; margin-bottom: 12px; padding: 8px; border-radius: 4px; border: 1px solid #ccc;
    }
    .pos3col-right button { background: #2e7d32; color: #fff; border: none; padding: 12px 24px; border-radius: 6px; font-size: 1.1em; cursor: pointer; width: 100%; margin-top: 18px; }
    .pos3col-right button:disabled { background: #aaa; }
    .order-summary { margin: 18px 0; }
    .order-summary ul { margin: 0; padding-left: 18px; }
    .order-summary li { margin-bottom: 4px; }
    .success-message { color: #2e7d32; font-weight: bold; margin-top: 16px; display: none; }
    .error-message { color: #b9472e; font-weight: bold; margin-top: 16px; display: none; }
    .pos3col-center { overflow-y: auto; }
  </style>
</head>
<body>
  <script>
    // Redirect to login if not authenticated
    fetch('/api/admin/check', { credentials: 'include' })
      .then(r => {
        if (!r.ok) window.location.href = 'login.html';
      });
  </script>
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <header>
    <h1 class="main-heading underline">POS Manual Order</h1>
    <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
      <a href="admin-menu.html">Menu Editor</a>
      <a href="stock-management.html">Stock Management</a>
      <a href="timeslots.html">Time Slots</a>
      <a href="orders.html">Orders</a>
      <a href="running-orders.html">Running Orders</a>
      <a href="takings.html">Takings</a>
      <a href="pos.html">POS Manual Order</a>
      <a href="offers.html">Special Offers</a>
      <a href="#" class="nav-disabled">Dashboard (coming soon)</a>
    </nav>
  </header>
  <div class="pos3col-container">
    <main id="main-content">
    <h1 class="pos3col-title">Manual POS Order Entry</h1>
    <div class="pos3col-grid">
      <!-- Left: Customer Details -->
      <div class="pos3col-left">
        <form id="customer-form">
          <label for="name">Customer Name:</label>
          <input type="text" id="name" name="name" required>
          <label for="type">Order Type:</label>
          <select id="type" name="type" required>
            <option value="Delivery">Delivery</option>
            <option value="Collection">Collection</option>
          </select>
          <label for="address">Address (if delivery):</label>
          <textarea id="address" name="address" rows="2"></textarea>
          <label for="postcode">Postcode (if delivery):</label>
          <input type="text" id="postcode" name="postcode">
          <label for="email">Email (optional):</label>
          <input type="email" id="email" name="email">
          <label for="phone">Phone (optional):</label>
          <input type="tel" id="phone" name="phone">
          <label for="orderDate">Order Date:</label>
          <input type="date" id="orderDate" name="orderDate" required>
          <label for="timeSlot">Time Slot:</label>
          <select id="timeSlot" name="timeSlot" required></select>
          <label for="notes">Customer Notes:</label>
          <textarea id="notes" name="notes" rows="2"></textarea>
          <label for="allergens">Allergens:</label>
          <textarea id="allergens" name="allergens" rows="2"></textarea>
        </form>
      </div>
      <!-- Center: Menu/Order Builder -->
      <div class="pos3col-center">
        <div id="pos-menu-content"></div>
      </div>
      <!-- Right: Payment & Summary -->
      <div class="pos3col-right">
        <form id="payment-form">
          <label for="paymentType">Payment Type:</label>
          <select id="paymentType" name="paymentType" required>
            <option value="card">Card</option>
            <option value="cash">Cash</option>
          </select>
          <div class="order-summary" id="order-summary"></div>
          <button type="button" id="submit-order-btn">Submit Order</button>
          <div class="success-message" id="success-message"></div>
          <div class="error-message" id="error-message"></div>
        </form>
      </div>
    </div>
  </div>
  <script>
    async function fetchTimeSlots() {
      const select = document.getElementById('timeSlot');
      select.innerHTML = '<option value="">Loading...</option>';
      try {
        const res = await fetch('http://localhost:8081/api/timeslots');
        const slots = await res.json();
        select.innerHTML = '<option value="">Select a time slot</option>' +
          slots.map(slot => `<option value="${slot.time}">${slot.time}</option>`).join('');
      } catch {
        select.innerHTML = '<option value="">Error loading slots</option>';
      }
    }
    fetchTimeSlots();
    // --- POS Menu Logic ---
    let posMenu = [];
    let posToppings = [];
    let posOrderItems = [];
    async function fetchPosMenu() {
      try {
        const [menuRes, toppingsRes] = await Promise.all([
          fetch('http://localhost:8081/api/menu'),
          fetch('http://localhost:8081/api/pizza-topping-stock')
        ]);
        posMenu = await menuRes.json();
        posToppings = await toppingsRes.json();
      } catch {}
    }

    function renderPosMenu(menu, masterToppings) {
      const content = document.getElementById('pos-menu-content');
      if (!menu || !Array.isArray(menu) || menu.length === 0) {
        content.innerHTML = '<em>No menu items found.</em>';
        return;
      }
      content.style.display = 'block';
      // Group by category/section
      const categories = {};
      menu.forEach(item => {
        const cat = item.section || item.category || 'Other';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(item);
      });
      let html = '';
      Object.keys(categories).forEach(cat => {
        html += `<h2>${cat}</h2><ul class='menu-card-list'>`;
        categories[cat].forEach(item => {
          html += `<li class='menu-item-card' data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}'><b>${item.name}</b><br>${item.description ? item.description + '<br>' : ''}`;
          // Pizza: show sizes/prices
          if((cat === 'Pizza' || cat === 'pizza') && item.sizes && Array.isArray(item.sizes) && item.sizes.length) {
            html += '<ul style="list-style:none;padding:0;">';
            item.sizes.forEach(size => {
              html += `<li class='menu-size-option' style="cursor:pointer;" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-size='${JSON.stringify(size).replace(/'/g, "&apos;")}'><span>${size.name}: <span class='price'>£${parseFloat(size.price).toFixed(2)}</span></span></li>`;
            });
            html += '</ul>';
            // Toppings UI
            html += `<form class='toppings-form' data-name='${item.name}'>`;
            if(item.toppings && Array.isArray(item.toppings) && item.toppings.length) {
              html += `<small><b>Remove Toppings:</b></small><br>`;
              item.toppings.forEach(topping => {
                html += `<label style='margin-right:8px'><input type='checkbox' class='remove-topping' value='${topping}' checked> ${topping}</label>`;
              });
            }
            // Add Extra Toppings: all master toppings (not already on pizza)
            html += `<br><small><b>Add Extra Toppings:</b></small><br>`;
            masterToppings.forEach(mt => {
              let price = mt.price !== undefined ? parseFloat(mt.price).toFixed(2) : '0.00';
              const alreadyOnPizza = item.toppings && item.toppings.includes(mt.topping);
              html += `<label style='margin-right:8px'><input type='checkbox' class='add-topping' value='${mt.topping}' data-price='${price}'` + (alreadyOnPizza ? ' disabled' : '') + `> ${mt.topping}`;
              html += ` <span style='font-size:0.9em;color:#888'>(${mt.type ? mt.type.charAt(0).toUpperCase() + mt.type.slice(1) : 'Other'} • £${price})</span>`;
              html += `</label>`;
            });
            html += `</form>`;
          } else {
            html += `<span class='price'>£${parseFloat(item.price).toFixed(2)}</span>`;
          }
          // No add button; clicking the card will add the item if not a pizza with sizes
          html += `</li>`;
        });
        html += '</ul>';
      });
      content.innerHTML = html;

      // Add to order logic for size/topping
      document.querySelectorAll('.menu-size-option').forEach(opt => {
        opt.addEventListener('click', function(e) {
          const item = JSON.parse(opt.getAttribute('data-item').replace(/&apos;/g, "'"));
          const size = JSON.parse(opt.getAttribute('data-size').replace(/&apos;/g, "'"));
          let removed = [];
          let extraToppings = [];
          let extraToppingPrices = [];
          let menuItemCard = opt.closest('.menu-item-card');
          const form = menuItemCard ? menuItemCard.querySelector('.toppings-form') : null;
          if (form) {
            const addToppingCbs = Array.from(form.querySelectorAll('.add-topping'));
            removed = Array.from(form.querySelectorAll('.remove-topping')).filter(cb => !cb.checked).map(cb => cb.value);
            addToppingCbs.forEach(cb => {
              if (cb.checked && !cb.disabled) {
                extraToppings.push(cb.value);
                extraToppingPrices.push(parseFloat(cb.getAttribute('data-price')) || 0);
              }
            });
          }
          let baseToppings = Array.isArray(item.toppings) ? item.toppings.filter(t => !removed.includes(t)) : [];
          let allToppings = baseToppings.concat(extraToppings);
          if (!Array.isArray(item.toppings) || item.toppings.length === 0) {
            allToppings = extraToppings;
          }
          let totalPrice = parseFloat(size.price) || 0;
          extraToppingPrices.forEach(p => { totalPrice += p; });
          const orderObj = { ...item, selectedSize: size, price: totalPrice, quantity: 1, toppings: allToppings, removed };
          addToOrder(orderObj);
          if (form) {
            Array.from(form.querySelectorAll('.remove-topping')).forEach(cb => { cb.checked = true; });
            Array.from(form.querySelectorAll('.add-topping')).forEach(cb => { cb.checked = false; });
          }
          opt.style.background = '#e9ece5';
          setTimeout(() => { opt.style.background = ''; }, 300);
          e.stopPropagation();
        });
      });
      // Make non-pizza or non-size items clickable to add
      document.querySelectorAll('.menu-item-card').forEach(card => {
        // If it has .menu-size-option, skip (handled above)
        if (card.querySelector('.menu-size-option')) return;
        card.style.cursor = 'pointer';
        card.addEventListener('click', function(e) {
          const item = JSON.parse(card.getAttribute('data-item').replace(/&apos;/g, "'"));
          addToOrder({ ...item, price: parseFloat(item.price), quantity: 1 });
          card.style.background = '#e9ece5';
          setTimeout(() => { card.style.background = ''; }, 300);
          e.stopPropagation();
        });
      });
    }

    function addToOrder(item) {
      const matchIdx = posOrderItems.findIndex(i => i.name === item.name && JSON.stringify(i.selectedSize) === JSON.stringify(item.selectedSize));
      if (matchIdx > -1) {
        posOrderItems[matchIdx].quantity += 1;
      } else {
        posOrderItems.push(item);
      }
      renderOrderSummary();
    }
    function renderPosItems() {
      const section = document.getElementById('pos-items-section');
      if (!posOrderItems.length) {
        section.innerHTML = '<em>No items added.</em>';
        return;
      }
      section.innerHTML = '<ul>' + posOrderItems.map((item, idx) =>
        `<li>${item.quantity} × ${item.name}${item.selectedSize ? ' ('+item.selectedSize.name+')' : ''} - £${item.price.toFixed(2)} <button type='button' onclick='window.removePosItem(${idx})'>Remove</button></li>`
      ).join('') + '</ul>';
    }
    window.removePosItem = function(idx) {
      posOrderItems.splice(idx, 1);
      renderPosItems();
      renderOrderSummary();
    }
    function renderOrderSummary() {
      const total = posOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      document.getElementById('order-summary').innerHTML =
        `<b>Order Total:</b> £${total.toFixed(2)}<br><ul>` +
        posOrderItems.map(i => `<li>${i.quantity} × ${i.name}${i.selectedSize ? ' ('+i.selectedSize.name+')' : ''} - £${i.price.toFixed(2)}</li>`).join('') +
        '</ul>';
    }
    // Fetch menu/toppings and initialize
    fetchPosMenu().then(() => {
      renderPosMenu(posMenu, posToppings);
      renderOrderSummary();
    });
    // --- POS Order Submission ---
    // Restrict orderDate to Friday, Saturday, Sunday only
    const orderDateInput = document.getElementById('orderDate');
    orderDateInput.addEventListener('input', function() {
      const d = new Date(this.value);
      if (![5,6,0].includes(d.getDay())) {
        this.setCustomValidity('Orders can only be placed for Friday, Saturday, or Sunday.');
      } else {
        this.setCustomValidity('');
      }
    });
    // Set min date to next allowed day
    function getNextAllowedDate(from) {
      const d = new Date(from);
      for (let i = 0; i < 7; i++) {
        const day = d.getDay();
        if ([5,6,0].includes(day)) return d;
        d.setDate(d.getDate() + 1);
      }
      return d;
    }
    const today = new Date();
    const nextAllowed = getNextAllowedDate(today);
    orderDateInput.min = nextAllowed.toISOString().slice(0,10);

    document.getElementById('pos-form').onsubmit = async function(e) {
      e.preventDefault();
      document.getElementById('success-message').style.display = 'none';
      document.getElementById('error-message').style.display = 'none';
      const name = document.getElementById('name').value.trim();
      const type = document.getElementById('type').value;
      const address = document.getElementById('address').value.trim();
      const postcode = document.getElementById('postcode').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const orderDate = document.getElementById('orderDate').value;
      const timeSlot = document.getElementById('timeSlot').value;
      const notes = document.getElementById('notes').value.trim();
      const allergens = document.getElementById('allergens').value.trim();
      const paymentType = document.getElementById('paymentType').value;
      if (!name || !type || !orderDate || !timeSlot || !paymentType) {
        document.getElementById('error-message').textContent = 'Please fill in all required fields.';
        document.getElementById('error-message').style.display = 'block';
        return;
      }
      // Block if not Fri/Sat/Sun
      const d = new Date(orderDate);
      if (![5,6,0].includes(d.getDay())) {
        document.getElementById('error-message').textContent = 'Orders can only be placed for Friday, Saturday, or Sunday.';
        document.getElementById('error-message').style.display = 'block';
        return;
      }
      if (!posOrderItems.length) {
        document.getElementById('error-message').textContent = 'Please add at least one item.';
        document.getElementById('error-message').style.display = 'block';
        return;
      }
      const total = posOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const orderData = {
        name,
        type,
        address: { full: address, postcode, email, phone },
        orderDate,
        timeSlot,
        slotId: timeSlot,
        items: posOrderItems,
        customerNotes: notes,
        allergens,
        paymentType,
        total
      };
      try {
        const res = await fetch('http://localhost:8081/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });
        if (!res.ok) {
          const err = await res.json();
          document.getElementById('error-message').textContent = err.error || 'Order failed.';
          document.getElementById('error-message').style.display = 'block';
          return;
        }
        document.getElementById('success-message').textContent = 'Order placed successfully!';
        document.getElementById('success-message').style.display = 'block';
        document.getElementById('customer-form').reset();
        posOrderItems = [];
        renderOrderSummary();
      } catch (err) {
        document.getElementById('error-message').textContent = 'Order failed. Please try again.';
        document.getElementById('error-message').style.display = 'block';
      }
    };
  </script>
</body>
</html>