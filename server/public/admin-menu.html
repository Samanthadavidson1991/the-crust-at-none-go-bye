<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Menu Editor | None Go Bye</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="admin-page">
  <script>
    // Login/session check
    fetch('/api/admin/check', { credentials: 'include' })
      .then(r => {
        if (!r.ok) window.location.href = 'login.html';
      });
  </script>
  <script src="/admin-order-toast.js"></script>
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <header>
    <h1 class="main-heading underline">Admin Menu Editor <button id="lock-page-btn" class="lock-page-btn" onclick="lockAdminPage()">Lock this page</button></h1>
    <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
      <a href="admin-menu.html">Menu Editor</a>
      <a href="stock-management.html">Stock Management</a>
      <a href="timeslots.html">Time Slots</a>
      <a href="orders.html">Orders</a>
      <a href="running-orders.html">Running Orders</a>
      <a href="takings.html">Takings</a>
      <a href="pos.html">POS Manual Order</a>
      <a href="offers.html">Special Offers</a>
    </nav>
  </header>
  <main id="main-content">
    <section class="admin-section">
      <div class="menu-section-controls">
        <label for="menuSectionSelect">Select Section:</label>
        <select id="menuSectionSelect" title="Select menu section">
          <!-- Sections will be populated dynamically -->
        </select>
        <label for="newSectionInput" class="newSectionLabel">Add New Section:</label>
        <input type="text" id="newSectionInput" placeholder="New section name">
        <button id="addSectionBtn">Add Section</button>
      </div>
      <div class="master-toppings">
        <h2>Master Toppings</h2>
        <div class="toppings-group">
          <div class="toppings-category">
            <h3>Pizza Toppings</h3>
            <ul id="pizzaMasterToppingsList" class="toppings-list"></ul>
            <div class="default-prices">
              <label>Vegetable Price (£): <input type="number" id="pizzaVegDefaultPrice" step="0.01" min="0" value="0.60"></label>
              <label>Meat Price (£): <input type="number" id="pizzaMeatDefaultPrice" step="0.01" min="0" value="1.00"></label>
              <label>Other Price (£): <input type="number" id="pizzaOtherDefaultPrice" step="0.01" min="0" value="0.50"></label>
            </div>
            <form id="addPizzaMasterToppingForm" class="topping-form">
              <input type="text" id="pizzaMasterToppingInput" placeholder="Topping name" required>
              <select id="pizzaMasterToppingType" required title="Select topping type">
                <option value="">Type</option>
                <option value="meat">Meat</option>
                <option value="vegetable">Vegetable</option>
                <option value="other">Other</option>
              </select>
              <button type="submit">Add Topping</button>
            </form>
          </div>
          <div class="toppings-category">
            <h3>Salad Toppings</h3>
            <ul id="saladMasterToppingsList" class="toppings-list"></ul>
            <div class="default-prices">
              <label>Vegetable Price (£): <input type="number" id="saladVegDefaultPrice" step="0.01" min="0" value="0.60"></label>
              <label>Meat Price (£): <input type="number" id="saladMeatDefaultPrice" step="0.01" min="0" value="1.00"></label>
              <label>Other Price (£): <input type="number" id="saladOtherDefaultPrice" step="0.01" min="0" value="0.50"></label>
            </div>
            <form id="addSaladMasterToppingForm" class="topping-form">
              <input type="text" id="saladMasterToppingInput" placeholder="Topping name" required>
              <select id="saladMasterToppingType" required title="Select topping type">
                <option value="">Type</option>
                <option value="meat">Meat</option>
                <option value="vegetable">Vegetable</option>
                <option value="other">Other</option>
              </select>
              <button type="submit">Add Topping</button>
            </form>
          </div>
          <div class="toppings-category">
            <h3>Other Toppings</h3>
            <ul id="otherMasterToppingsList" class="toppings-list"></ul>
            <div class="default-prices">
              <label>Vegetable Price (£): <input type="number" id="otherVegDefaultPrice" step="0.01" min="0" value="0.60"></label>
              <label>Meat Price (£): <input type="number" id="otherMeatDefaultPrice" step="0.01" min="0" value="1.00"></label>
              <label>Other Price (£): <input type="number" id="otherOtherDefaultPrice" step="0.01" min="0" value="0.50"></label>
            </div>
            <form id="addOtherMasterToppingForm" class="topping-form">
              <input type="text" id="otherMasterToppingInput" placeholder="Topping name" required>
              <select id="otherMasterToppingType" required title="Select topping type">
                <option value="">Type</option>
                <option value="meat">Meat</option>
                <option value="vegetable">Vegetable</option>
                <option value="other">Other</option>
              </select>
              <button type="submit">Add Topping</button>
            </form>
          </div>
        </div>
      </div>
    </section>
  </main>
  <script>
    // --- Global State ---
    let masterToppings = {
      pizza: [],
      salad: [],
      other: []
    };
    let menuSections = [];

    // --- Lock Page Logic ---
    function lockAdminPage() {
      fetch('/api/admin/lock', { method: 'POST', credentials: 'include' })
        .then(r => {
          if (r.ok) {
            alert('Page locked. You will not be logged out automatically.');
          } else {
            alert('Failed to lock page.');
          }
        });
    }

    // --- Load Menu Sections ---
    async function loadMenuSections() {
      try {
        const response = await fetch('/api/menu', { credentials: 'include' });
        const data = await response.json();
        
        // Extract unique sections from menu items
        const sections = new Set();
        if (data.items && Array.isArray(data.items)) {
          data.items.forEach(item => {
            if (item.section) sections.add(item.section);
          });
        }
        
        menuSections = Array.from(sections);
        updateSectionDropdown();
      } catch (error) {
        console.error('Failed to load menu sections:', error);
        alert('Failed to load menu sections');
      }
    }

    // --- Update Section Dropdown ---
    function updateSectionDropdown() {
      const select = document.getElementById('menuSectionSelect');
      if (!select) return;
      
      select.innerHTML = '<option value="">-- Select Section --</option>';
      menuSections.forEach(section => {
        const option = document.createElement('option');
        option.value = section;
        option.textContent = section;
        select.appendChild(option);
      });
    }

    // --- Add New Section ---
    document.addEventListener('DOMContentLoaded', function() {
      const addSectionBtn = document.getElementById('addSectionBtn');
      const newSectionInput = document.getElementById('newSectionInput');
      
      if (addSectionBtn && newSectionInput) {
        addSectionBtn.addEventListener('click', function() {
          const sectionName = newSectionInput.value.trim();
          if (!sectionName) {
            alert('Please enter a section name');
            return;
          }
          
          if (menuSections.includes(sectionName)) {
            alert('This section already exists');
            return;
          }
          
          menuSections.push(sectionName);
          updateSectionDropdown();
          newSectionInput.value = '';
          alert(`Section "${sectionName}" added successfully`);
        });
      }

      // --- Load Master Toppings ---
      loadMasterToppings();
      loadMenuSections();

      // --- Pizza Master Toppings Form ---
      const pizzaForm = document.getElementById('addPizzaMasterToppingForm');
      if (pizzaForm) {
        pizzaForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const name = document.getElementById('pizzaMasterToppingInput').value.trim();
          const type = document.getElementById('pizzaMasterToppingType').value;
          
          if (!name || !type) {
            alert('Please fill in all fields');
            return;
          }
          
          const price = getPriceForType('pizza', type);
          const topping = { name, type, price };
          masterToppings.pizza.push(topping);
          saveMasterToppings();
          renderMasterToppings('pizza');
          pizzaForm.reset();
        });
      }

      // --- Salad Master Toppings Form ---
      const saladForm = document.getElementById('addSaladMasterToppingForm');
      if (saladForm) {
        saladForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const name = document.getElementById('saladMasterToppingInput').value.trim();
          const type = document.getElementById('saladMasterToppingType').value;
          
          if (!name || !type) {
            alert('Please fill in all fields');
            return;
          }
          
          const price = getPriceForType('salad', type);
          const topping = { name, type, price };
          masterToppings.salad.push(topping);
          saveMasterToppings();
          renderMasterToppings('salad');
          saladForm.reset();
        });
      }

      // --- Other Master Toppings Form ---
      const otherForm = document.getElementById('addOtherMasterToppingForm');
      if (otherForm) {
        otherForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const name = document.getElementById('otherMasterToppingInput').value.trim();
          const type = document.getElementById('otherMasterToppingType').value;
          
          if (!name || !type) {
            alert('Please fill in all fields');
            return;
          }
          
          const price = getPriceForType('other', type);
          const topping = { name, type, price };
          masterToppings.other.push(topping);
          saveMasterToppings();
          renderMasterToppings('other');
          otherForm.reset();
        });
      }
    });

    // --- Get Price for Type ---
    function getPriceForType(category, type) {
      const vegPrice = document.getElementById(`${category}VegDefaultPrice`);
      const meatPrice = document.getElementById(`${category}MeatDefaultPrice`);
      const otherPrice = document.getElementById(`${category}OtherDefaultPrice`);
      
      if (type === 'vegetable' && vegPrice) return parseFloat(vegPrice.value);
      if (type === 'meat' && meatPrice) return parseFloat(meatPrice.value);
      if (type === 'other' && otherPrice) return parseFloat(otherPrice.value);
      return 0.50;
    }

    // --- Load Master Toppings from LocalStorage ---
    function loadMasterToppings() {
      const saved = localStorage.getItem('masterToppings');
      if (saved) {
        masterToppings = JSON.parse(saved);
      }
      renderMasterToppings('pizza');
      renderMasterToppings('salad');
      renderMasterToppings('other');
    }

    // --- Save Master Toppings to LocalStorage ---
    function saveMasterToppings() {
      localStorage.setItem('masterToppings', JSON.stringify(masterToppings));
    }

    // --- Render Master Toppings ---
    function renderMasterToppings(category) {
      const list = document.getElementById(`${category}MasterToppingsList`);
      if (!list) return;
      
      list.innerHTML = '';
      const toppings = masterToppings[category] || [];
      
      toppings.forEach((topping, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${topping.name} (${topping.type}) - £${topping.price.toFixed(2)}</span>
          <button onclick="deleteMasterTopping('${category}', ${index})">Delete</button>
        `;
        list.appendChild(li);
      });
    }

    // --- Delete Master Topping ---
    function deleteMasterTopping(category, index) {
      if (confirm('Are you sure you want to delete this topping?')) {
        masterToppings[category].splice(index, 1);
        saveMasterToppings();
        renderMasterToppings(category);
      }
    }
  </script>
</body>
</html>