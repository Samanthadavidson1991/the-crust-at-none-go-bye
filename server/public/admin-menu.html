<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Menu Editor | None Go Bye</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="admin-page">
  <script>
    // Login/session check
    fetch('/api/admin/check', { credentials: 'include' })
      .then(r => {
        if (!r.ok) window.location.href = 'login.html';
      });
  </script>
  <script src="/admin-order-toast.js"></script>
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <header>
    <h1 class="main-heading underline">Admin Menu Editor <button id="lock-page-btn" class="lock-page-btn" onclick="lockAdminPage()">Lock this page</button></h1>
    <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
      <a href="admin-menu.html">Menu Editor</a>
      <a href="stock-management.html">Stock Management</a>
      <a href="timeslots.html">Time Slots</a>
      <a href="orders.html">Orders</a>
      <a href="running-orders.html">Running Orders</a>
      <a href="takings.html">Takings</a>
      <a href="pos.html">POS Manual Order</a>
      <a href="offers.html">Special Offers</a>
    </nav>
  </header>
  <main id="main-content">
    <div class="master-toppings card">
      <h2>Master Toppings</h2>
      <div class="toppings-group">
        <div class="toppings-category">
          <h3>Pizza Toppings</h3>
          <ul id="pizzaMasterToppingsList" class="toppings-list"></ul>
          <div class="default-prices">
            <label>Vegetable Price (£): <input type="number" id="pizzaVegDefaultPrice" step="0.01" min="0" value="0.60"></label>
            <label>Meat Price (£): <input type="number" id="pizzaMeatDefaultPrice" step="0.01" min="0" value="1.00"></label>
            <label>Other Price (£): <input type="number" id="pizzaOtherDefaultPrice" step="0.01" min="0" value="0.50"></label>
          </div>
          <form id="addPizzaMasterToppingForm" class="topping-form">
            <input type="text" id="pizzaMasterToppingInput" placeholder="Topping name" required>
            <button type="submit">Add Topping</button>
          </form>
        </div>
        <div class="toppings-category">
          <h3>Salad Toppings</h3>
          <ul id="saladMasterToppingsList" class="toppings-list"></ul>
          <div class="default-prices">
            <label>Vegetable Price (£): <input type="number" id="saladVegDefaultPrice" step="0.01" min="0" value="0.60"></label>
            <label>Meat Price (£): <input type="number" id="saladMeatDefaultPrice" step="0.01" min="0" value="1.00"></label>
            <label>Other Price (£): <input type="number" id="saladOtherDefaultPrice" step="0.01" min="0" value="0.50"></label>
          </div>
          <form id="addSaladMasterToppingForm" class="topping-form">
            <input type="text" id="saladMasterToppingInput" placeholder="Topping name" required>
            <button type="submit">Add Topping</button>
          </form>
        </div>
        <div class="toppings-category">
          <h3>Other Toppings</h3>
          <ul id="otherMasterToppingsList" class="toppings-list"></ul>
          <div class="default-prices">
            <label>Vegetable Price (£): <input type="number" id="otherVegDefaultPrice" step="0.01" min="0" value="0.60"></label>
            <label>Meat Price (£): <input type="number" id="otherMeatDefaultPrice" step="0.01" min="0" value="1.00"></label>
            <label>Other Price (£): <input type="number" id="otherOtherDefaultPrice" step="0.01" min="0" value="0.50"></label>
          </div>
          <form id="addOtherMasterToppingForm" class="topping-form">
            <input type="text" id="otherMasterToppingInput" placeholder="Topping name" required>
            <button type="submit">Add Topping</button>
          </form>
        </div>
      </div>
    </div>
    <section class="admin-section">
      <div class="menu-section-controls card">
        <h2>Menu Sections</h2>
        <div class="form-row">
          <label for="menuSectionSelect">Select Section:</label>
          <select id="menuSectionSelect" title="Select menu section"></select>
        </div>
        <div class="form-row">
          <label for="newSectionInput" class="newSectionLabel">Add New Section:</label>
          <input type="text" id="newSectionInput" placeholder="New section name">
          <button id="addSectionBtn">Add Section</button>
        </div>
        <small class="help-text">Select a section to edit or add a new one.</small>
      </div>
      <div id="sectionDetails" class="sectionDetails card">
        <h3>Section Details</h3>
        <div class="form-row">
          <label for="sectionItemName">Menu Item Name:</label>
          <input type="text" id="sectionItemName" placeholder="Menu item name">
        </div>
        <div class="form-row">
          <label for="sectionDescription">Description:</label>
          <input type="text" id="sectionDescription" placeholder="Section description">
        </div>
        <div class="type-subsections">
          <h4>Sizes/Types & Prices</h4>
          <form id="addSizeTypeForm" class="size-type-form">
            <input type="text" id="sizeTypeInput" placeholder="Size/Type name" required>
            <input type="number" id="sizeTypePriceInput" placeholder="Price (£)" step="0.01" min="0" required>
            <button type="submit">Add Size/Type</button>
          </form>
          <ul id="sizeTypeList" class="size-type-list"></ul>
          <small class="help-text">Add custom sizes/types and set prices for each.</small>
        </div>
        <button id="addMenuItemBtn" class="primary-btn">Add Item</button>
      </div>
      <div id="stagedMenuItems" class="staged-menu-items card">
        <h3>Staged Menu Items</h3>
        <div id="stagedMenuItemsList"></div>
        <button id="saveAllMenuItemsBtn" class="primary-btn">Save All</button>
      </div>
      <div id="sectionToppings" class="sectionToppings card">
        <h3>Section Toppings</h3>
        <form id="addSectionToppingForm" class="topping-form">
          <input type="text" id="sectionToppingInput" placeholder="Topping name" required>
          <input type="number" id="sectionToppingPriceInput" placeholder="Price (£)" step="0.01" min="0" required>
          <button type="submit">Add Topping</button>
        </form>
        <ul id="sectionToppingsList" class="toppings-list"></ul>
        <small class="help-text">Add toppings for this menu item and set their prices.</small>
      </div>
    </section>
    <section class="menu-preview card">
      <h2>Menu Preview</h2>
      <div id="menuPreviewContent"></div>
    </section>
  </main>
  <script>
    // --- Global State ---
    let masterToppings = {
      pizza: [],
      salad: [],
      other: []
    };
    let menuSections = [];
    let sectionDetails = {};
    let currentSection = '';
    let stagedMenuItems = [];

    // --- Lock Page Logic ---
    function lockAdminPage() {
      fetch('/api/admin/lock', { method: 'POST', credentials: 'include' })
        .then(r => {
          if (r.ok) {
            alert('Page locked. You will not be logged out automatically.');
          } else {
            alert('Failed to lock page.');
          }
        });
    }

    // --- Load menu from server ---
    async function loadMenuFromServer() {
      try {
        const response = await fetch('/api/menu', { credentials: 'include' });
        const data = await response.json();
        sectionDetails = {};
        if (data.items && Array.isArray(data.items)) {
          data.items.forEach(item => {
            sectionDetails[item.section || item.name] = {
              itemName: item.name || '',
              description: item.description || '',
              sizeTypes: item.sizes || [],
              toppings: (item.toppings || []).map(tp => typeof tp === 'string' ? { name: tp, price: 0 } : tp)
            };
          });
        }
        updateAllUI();
      } catch (error) {
        console.error('Failed to load menu from server:', error);
      }
    }

    // --- Save menu to server ---
    async function saveMenuToServer() {
      try {
        // Convert sectionDetails to array of menu items
        const items = Object.values(sectionDetails).map(details => ({
          name: details.itemName,
          description: details.description,
          sizes: details.sizeTypes || [],
          toppings: (details.toppings || []).map(tp => ({ name: tp.name, price: tp.price })),
          section: details.itemName // Use itemName as section for now
        }));
        await fetch('/api/menu', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(items)
        });
        alert('Menu saved to server!');
      } catch (error) {
        console.error('Failed to save menu to server:', error);
        alert('Failed to save menu to server');
      }
    }

    // --- Load Menu Sections ---
    async function loadMenuSections() {
      try {
        const response = await fetch('/api/menu', { credentials: 'include' });
        const data = await response.json();
        const sections = new Set();
        if (data.items && Array.isArray(data.items)) {
          data.items.forEach(item => {
            if (item.section) sections.add(item.section);
            // Load section details if present
            if (item.section && !sectionDetails[item.section]) {
              sectionDetails[item.section] = {
                description: item.description || '',
                meatPrice: item.meatPrice || '',
                vegPrice: item.vegPrice || '',
                otherPrice: item.otherPrice || '',
                toppings: item.toppings || []
              };
            }
          });
        }
        menuSections = Array.from(sections);
        updateSectionDropdown();
      } catch (error) {
        console.error('Failed to load menu sections:', error);
        alert('Failed to load menu sections');
      }
    }

    // --- Update Section Dropdown ---
    function updateSectionDropdown() {
      const select = document.getElementById('menuSectionSelect');
      if (!select) return;
      select.innerHTML = '<option value="">-- Select Section --</option>';
      menuSections.forEach(section => {
        const option = document.createElement('option');
        option.value = section;
        option.textContent = section;
        select.appendChild(option);
      });
    }

    // --- Show Section Details ---
    function showSectionDetails(section) {
      currentSection = section;
      const detailsDiv = document.getElementById('sectionDetails');
      const toppingsDiv = document.getElementById('sectionToppings');
      if (!detailsDiv || !toppingsDiv) return;
      if (!section) {
        detailsDiv.style.display = 'none';
        toppingsDiv.style.display = 'none';
        return;
      }
      detailsDiv.style.display = '';
      toppingsDiv.style.display = '';
      // Populate details
      const details = sectionDetails[section] || {};
      document.getElementById('sectionItemName').value = details.itemName || '';
      document.getElementById('sectionDescription').value = details.description || '';
      renderSizeTypeList(section);
      renderSectionToppings(section);
    }

    // --- Save Section Details ---
    function saveSectionDetails() {
      if (!currentSection) return;
      sectionDetails[currentSection] = sectionDetails[currentSection] || {};
      sectionDetails[currentSection].itemName = document.getElementById('sectionItemName').value;
      sectionDetails[currentSection].description = document.getElementById('sectionDescription').value;
      saveSectionDetailsToStorage();
      alert('Section details saved!');
    }

    // --- Add New Section ---
    document.addEventListener('DOMContentLoaded', function() {
      const addSectionBtn = document.getElementById('addSectionBtn');
      const newSectionInput = document.getElementById('newSectionInput');
      const sectionSelect = document.getElementById('menuSectionSelect');
      const saveSectionDetailsBtn = document.getElementById('saveSectionDetailsBtn');
      if (addSectionBtn && newSectionInput) {
        addSectionBtn.addEventListener('click', function() {
          const sectionName = newSectionInput.value.trim();
          if (!sectionName) {
            alert('Please enter a section name');
            return;
          }
          if (menuSections.includes(sectionName)) {
            alert('This section already exists');
            return;
          }
          menuSections.push(sectionName);
          sectionDetails[sectionName] = { description: '', meatPrice: '', vegPrice: '', otherPrice: '', toppings: [] };
          updateSectionDropdown();
          newSectionInput.value = '';
          sectionSelect.value = sectionName;
          showSectionDetails(sectionName);
          alert(`Section "${sectionName}" added successfully`);
        });
      }
      if (sectionSelect) {
        sectionSelect.addEventListener('change', function() {
          showSectionDetails(this.value);
        });
      }
      if (saveSectionDetailsBtn) {
        saveSectionDetailsBtn.addEventListener('click', saveSectionDetails);
      }
      // --- Section Toppings Form ---
      const addSectionToppingForm = document.getElementById('addSectionToppingForm');
      if (addSectionToppingForm) {
        addSectionToppingForm.addEventListener('submit', function(e) {
          e.preventDefault();
          if (!currentSection) return;
          const toppingName = document.getElementById('sectionToppingInput').value.trim();
          const toppingPrice = parseFloat(document.getElementById('sectionToppingPriceInput').value);
          if (!toppingName || isNaN(toppingPrice)) {
            alert('Please enter a topping name and price');
            return;
          }
          sectionDetails[currentSection].toppings = sectionDetails[currentSection].toppings || [];
          sectionDetails[currentSection].toppings.push({ name: toppingName, price: toppingPrice });
          saveSectionDetailsToStorage();
          renderSectionToppings(currentSection);
          addSectionToppingForm.reset();
        });
      }
      // --- Size/Type Form ---
      const addSizeTypeForm = document.getElementById('addSizeTypeForm');
      if (addSizeTypeForm) {
        addSizeTypeForm.addEventListener('submit', function(e) {
          e.preventDefault();
          if (!currentSection) return;
          const sizeType = document.getElementById('sizeTypeInput').value.trim();
          const price = parseFloat(document.getElementById('sizeTypePriceInput').value);
          if (!sizeType || isNaN(price)) {
            alert('Please enter a size/type name and price');
            return;
          }
          sectionDetails[currentSection].sizeTypes = sectionDetails[currentSection].sizeTypes || [];
          sectionDetails[currentSection].sizeTypes.push({ type: sizeType, price });
          saveSectionDetailsToStorage();
          renderSizeTypeList(currentSection);
          addSizeTypeForm.reset();
        });
      }
      loadMasterToppings();
      loadMenuSections();
      updateAllUI();
    });

    // --- Render Section Toppings ---
    function renderSectionToppings(section) {
      const list = document.getElementById('sectionToppingsList');
      if (!list || !sectionDetails[section]) return;
      list.innerHTML = '';
      (sectionDetails[section].toppings || []).forEach((topping, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${topping.name} - £${topping.price.toFixed(2)}</span> <button onclick="deleteSectionTopping('${section}', ${idx})">Delete</button>`;
        list.appendChild(li);
      });
    }
    // --- Render Size/Type List ---
    function renderSizeTypeList(section) {
      const list = document.getElementById('sizeTypeList');
      if (!list || !sectionDetails[section]) return;
      list.innerHTML = '';
      (sectionDetails[section].sizeTypes || []).forEach((item, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${item.type} - £${item.price.toFixed(2)}</span> <button onclick="deleteSizeType('${section}', ${idx})">Delete</button>`;
        list.appendChild(li);
      });
    }
    // --- Delete Section Topping ---
    function deleteSectionTopping(section, idx) {
      if (!sectionDetails[section]) return;
      if (confirm('Are you sure you want to delete this topping?')) {
        sectionDetails[section].toppings.splice(idx, 1);
        saveSectionDetailsToStorage();
        renderSectionToppings(section);
      }
    }
    // --- Delete Size/Type ---
    function deleteSizeType(section, idx) {
      if (!sectionDetails[section]) return;
      if (confirm('Are you sure you want to delete this size/type?')) {
        sectionDetails[section].sizeTypes.splice(idx, 1);
        saveSectionDetailsToStorage();
        renderSizeTypeList(section);
      }
    }
    // --- Save Section Details to LocalStorage ---
    function saveSectionDetailsToStorage() {
      localStorage.setItem('sectionDetails', JSON.stringify(sectionDetails));
    }
    // --- Load Section Details from LocalStorage ---
    function loadSectionDetailsFromStorage() {
      const saved = localStorage.getItem('sectionDetails');
      if (saved) {
        sectionDetails = JSON.parse(saved);
      }
    }
    // --- Master Toppings Logic (unchanged) ---
    function getPriceForType(category, type) {
      const vegPrice = document.getElementById(`${category}VegDefaultPrice`);
      const meatPrice = document.getElementById(`${category}MeatDefaultPrice`);
      const otherPrice = document.getElementById(`${category}OtherDefaultPrice`);
      if (type === 'vegetable' && vegPrice) return parseFloat(vegPrice.value);
      if (type === 'meat' && meatPrice) return parseFloat(meatPrice.value);
      if (type === 'other' && otherPrice) return parseFloat(otherPrice.value);
      return 0.50;
    }
    function loadMasterToppings() {
      const saved = localStorage.getItem('masterToppings');
      if (saved) {
        masterToppings = JSON.parse(saved);
      }
      renderMasterToppings('pizza');
      renderMasterToppings('salad');
      renderMasterToppings('other');
    }
    function saveMasterToppings() {
      localStorage.setItem('masterToppings', JSON.stringify(masterToppings));
    }
    function renderMasterToppings(category) {
      const list = document.getElementById(`${category}MasterToppingsList`);
      if (!list) return;
      list.innerHTML = '';
      const toppings = masterToppings[category] || [];
      toppings.forEach((topping, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${topping.name} (${topping.type}) - £${topping.price.toFixed(2)}</span>
          <button onclick="deleteMasterTopping('${category}', ${index})">Delete</button>
        `;
        list.appendChild(li);
      });
    }
    function deleteMasterTopping(category, index) {
      if (confirm('Are you sure you want to delete this topping?')) {
        masterToppings[category].splice(index, 1);
        saveMasterToppings();
        renderMasterToppings(category);
      }
    }
    // --- Render Menu Preview ---
    function renderMenuPreview() {
      const preview = document.getElementById('menuPreviewContent');
      if (!preview) return;
      let html = '';
      Object.entries(sectionDetails).forEach(([section, details]) => {
        if (!details.itemName && !details.description && (!details.sizeTypes || details.sizeTypes.length === 0) && (!details.toppings || details.toppings.length === 0)) return;
        html += `<div class="menu-preview-section">
          <h3>${details.itemName || section}</h3>
          <p class="text-muted">${details.description || ''}</p>`;
        if (details.sizeTypes && details.sizeTypes.length) {
          html += '<ul class="menu-preview-sizes">';
          details.sizeTypes.forEach(st => {
            html += `<li>${st.type} - £${st.price.toFixed(2)}</li>`;
          });
          html += '</ul>';
        }
        if (details.toppings && details.toppings.length) {
          html += '<ul class="menu-preview-toppings">';
          details.toppings.forEach(tp => {
            html += `<li>${tp.name} - £${tp.price.toFixed(2)}</li>`;
          });
          html += '</ul>';
        }
        html += '</div><hr>';
      });
      preview.innerHTML = html || '<p class="text-muted">No menu items yet. Add sections and details above.</p>';
    }
    // Update preview after any change
    function updateAllUI() {
      renderMasterToppings('pizza');
      renderMasterToppings('salad');
      renderMasterToppings('other');
      renderMenuPreview();
    }
    // Call updateAllUI after changes
    document.addEventListener('DOMContentLoaded', function() {
      // ...existing code...
      loadMasterToppings();
      loadMenuSections();
      updateAllUI();
    });
    // After saving section details, adding/removing size/type/topping, call saveMenuToServer
    // Example:
    // saveMenuToServer();
    // --- Add Menu Item to Staged List ---
    document.addEventListener('DOMContentLoaded', function() {
      const addMenuItemBtn = document.getElementById('addMenuItemBtn');
      if (addMenuItemBtn) {
        addMenuItemBtn.addEventListener('click', function() {
          if (!currentSection) return;
          const details = sectionDetails[currentSection];
          if (!details.itemName) {
            alert('Menu item name is required');
            return;
          }
          stagedMenuItems.push(JSON.parse(JSON.stringify(details)));
          renderStagedMenuItems();
          alert('Menu item staged! You can add more or save all.');
        });
      }
      const saveAllMenuItemsBtn = document.getElementById('saveAllMenuItemsBtn');
      if (saveAllMenuItemsBtn) {
        saveAllMenuItemsBtn.addEventListener('click', async function() {
          if (stagedMenuItems.length === 0) {
            alert('No staged items to save.');
            return;
          }
          try {
            await fetch('/api/menu', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(stagedMenuItems)
            });
            alert('All staged menu items saved to server!');
            stagedMenuItems = [];
            renderStagedMenuItems();
            loadMenuFromServer();
          } catch (error) {
            alert('Failed to save menu items to server');
          }
        });
      }
    });

    // --- Render Staged Menu Items ---
    function renderStagedMenuItems() {
      const list = document.getElementById('stagedMenuItemsList');
      if (!list) return;
      if (stagedMenuItems.length === 0) {
        list.innerHTML = '<p class="text-muted">No staged items yet.</p>';
        return;
      }
      let html = '<ul>';
      stagedMenuItems.forEach((item, idx) => {
        html += `<li><strong>${item.itemName}</strong> - ${item.description || ''} <button onclick="removeStagedMenuItem(${idx})">Remove</button></li>`;
      });
      html += '</ul>';
      list.innerHTML = html;
    }
    window.removeStagedMenuItem = function(idx) {
      stagedMenuItems.splice(idx, 1);
      renderStagedMenuItems();
    }
  </script>
</body>
</html>