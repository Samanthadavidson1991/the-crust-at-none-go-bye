<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Menu Editor</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header>
    <h1 class="main-heading underline">Menu Editor</h1>
    <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
      <a href="admin-menu.html">Menu Editor</a>
      <a href="stock-management.html">Stock Management</a>
      <a href="timeslots.html">Time Slots</a>
      <a href="orders.html">Orders</a>
      <a href="running-orders.html">Running Orders</a>

      <a href="takings.html">Takings</a>
      <a href="pos.html">POS Manual Order</a>
      <a href="offers.html">Offers</a>
    </nav>
  </header>
  <main>
    <section>
      <h2>Add Section</h2>
      <form id="sectionCreatorForm">
        <input type="text" id="sectionNameInput" placeholder="Section name" required>
        <button type="submit">Add Section</button>
      </form>
    </section>
    <section>
      <h2>Sections</h2>
      <div id="sectionsContainer"></div>
    </section>
    <script>
      // Section creator logic with MongoDB backend
      const sectionForm = document.getElementById('sectionCreatorForm');
      const sectionInput = document.getElementById('sectionNameInput');
      const sectionsContainer = document.getElementById('sectionsContainer');
      const API_BASE_URL = window.location.hostname === 'localhost' ? '' : 'https://the-crust-at-none-go-bye-admin.onrender.com';

      // Load sections from backend on page load
      async function loadSections() {
        try {
          const res = await fetch(API_BASE_URL + '/api/sections', { credentials: 'include' });
          const data = await res.json();
          renderSections(data.sections || []);
        } catch (err) {
          console.error('Failed to load sections:', err);
          sectionsContainer.innerHTML = '<em>Error loading sections.</em>';
        }
      }

      // Add section to backend
      sectionForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const name = sectionInput.value.trim();
        if (!name) return;

        try {
          const res = await fetch(API_BASE_URL + '/api/sections', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ name })
          });

          if (res.ok) {
            sectionInput.value = '';
            loadSections(); // Reload sections from backend
          } else {
            const err = await res.json();
            alert('Error: ' + (err.error || 'Failed to add section'));
          }
        } catch (err) {
          alert('Failed to add section: ' + err.message);
        }
      });

      // Delete section from backend
      async function deleteSection(id) {
        if (!confirm('Delete this section?')) return;

        try {
          const res = await fetch(API_BASE_URL + '/api/sections/' + id, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (res.ok) {
            loadSections(); // Reload sections from backend
          } else {
            alert('Failed to delete section');
          }
        } catch (err) {
          alert('Failed to delete section: ' + err.message);
        }
      }

      // Render sections in UI
      function renderSections(sections) {
        sectionsContainer.innerHTML = '';
        if (!sections || sections.length === 0) {
          sectionsContainer.innerHTML = '<em>No sections yet. Add one above.</em>';
          return;
        }

        sections.forEach((section) => {
          const div = document.createElement('div');
          div.className = 'section-row';
          div.innerHTML = `<span>${section.name}</span> <button type='button' data-id='${section._id}' class='delete-section-btn'>Delete</button>`;
          sectionsContainer.appendChild(div);
        });

        // Add delete logic
        Array.from(document.getElementsByClassName('delete-section-btn')).forEach(btn => {
          btn.onclick = function() {
            const id = this.getAttribute('data-id');
            deleteSection(id);
          };
        });
      }

      // Initial load
      loadSections();
    </script>
  </main>
  <script src="/admin-menu.js"></script>
