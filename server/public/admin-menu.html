<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Menu Editor | None Go Bye</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    .admin-nav { margin: 24px 0; }
    .admin-nav a { font-size: 1.1rem; margin: 0 18px; color: #7c232a; text-decoration: underline; }
    .admin-section { max-width: 700px; margin: 40px auto; background: #f3f7ef; border-radius: 16px; padding: 32px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
    .admin-section h2 { margin-top: 0; }
    .menu-form input, .menu-form select { margin-bottom: 12px; width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc; }
    .menu-form button { background: #b9472e; color: #fff; border: none; border-radius: 8px; padding: 10px 24px; font-weight: bold; cursor: pointer; }
    .menu-list { margin-top: 32px; }
    .menu-item-admin { background: #fff; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; }
    .menu-item-admin span { font-weight: bold; }
    .menu-item-admin button { margin-left: 12px; }
  </style>
</head>
<body class="admin-page">
    <script>
      // Redirect to login if not authenticated
      fetch('/api/admin/check', { credentials: 'include' })
        .then(r => {
          if (!r.ok) window.location.href = 'login.html';
        });
    </script>
    <script src="admin-order-toast.js"></script>
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <header>
    <h1 class="main-heading underline">Admin  Menu Editor</h1>
    <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
      <a href="admin-menu.html">Menu Editor</a>
      <a href="stock-management.html">Stock Management</a>
      <a href="timeslots.html">Time Slots</a>
      <a href="orders.html">Orders</a>
      <a href="running-orders.html">Running Orders</a>
      <a href="takings.html">Takings</a>
      <a href="pos.html">POS Manual Order</a>
      <a href="offers.html">Special Offers</a>
      <a href="#" class="nav-disabled">Dashboard (coming soon)</a>
    </nav>
  </header>
  <main>
    <main id="main-content">
    <section class="admin-section">
      <h2>Edit Menu</h2>
      <div id="pizza-topping-master-section" style="margin-bottom:32px">
        <h3>Pizza Master Toppings</h3>
        <form id="addPizzaMasterToppingForm" style="margin-bottom:12px;display:flex;gap:8px;align-items:center">
          <input type="text" id="pizzaMasterToppingInput" placeholder="Topping name" required>
          <select id="pizzaMasterToppingType" required>
            <option value="">Type</option>
            <option value="meat">Meat</option>
            <option value="vegetable">Vegetable</option>
            <option value="other">Other</option>
          </select>
          <input type="number" id="pizzaMasterToppingPrice" placeholder="Price (£)" step="0.01" min="0" style="width:90px;" required>
          <button type="submit">Add Topping</button>
        </form>
        <div style="display:flex;gap:40px">
          <div style="flex:1">
            <h4>Meat</h4>
            <ul id="pizzaMeatToppingsList"></ul>
          </div>
          <div style="flex:1">
            <h4>Vegetable</h4>
            <ul id="pizzaVegToppingsList"></ul>
          </div>
        </div>
      </div>
      <div id="salad-topping-master-section" style="margin-bottom:32px">
        <h3>Salad Master Toppings</h3>
        <form id="addSaladMasterToppingForm" style="margin-bottom:12px;display:flex;gap:8px;align-items:center">
          <input type="text" id="saladMasterToppingInput" placeholder="Topping name" required>
          <select id="saladMasterToppingType" required>
            <option value="">Type</option>
            <option value="meat">Meat</option>
            <option value="vegetable">Vegetable</option>
            <option value="other">Other</option>
          </select>
          <input type="number" id="saladMasterToppingPrice" placeholder="Price (£)" step="0.01" min="0" style="width:90px;" required>
          <button type="submit">Add Topping</button>
        </form>
        <div style="display:flex;gap:40px">
          <div style="flex:1">
            <h4>Meat</h4>
            <ul id="saladMeatToppingsList"></ul>
          </div>
          <div style="flex:1">
            <h4>Vegetable</h4>
            <ul id="saladVegToppingsList"></ul>
          </div>
        </div>
      </div>
      <form class="menu-form" id="menuForm">
  <select name="category" id="categorySelect" required title="Select menu category">
          <option value="">Select Category</option>
          <option value="Pizza">Pizza</option>
          <option value="Sides">Sides</option>
          <option value="Desserts">Desserts</option>
          <option value="Drinks">Drinks</option>
          <option value="Salads">Salads</option>
        </select>
        <input type="text" name="name" placeholder="Item Name" required>
        <input type="text" name="description" placeholder="Description" required>
  <div id="sidesFields" class="d-none">
          <label><b>Options & Prices:</b></label><br>
          <div id="sidesOptionsList"></div>
          <input type="text" id="sideOptionNameInput" placeholder="Option name (e.g. Regular, With Dip)">
          <input type="number" id="sideOptionPriceInput" placeholder="Price (£)" step="0.01" min="0">
          <button type="button" id="addSideOptionBtn">Add Option</button>
          <br><br>
        </div>
  <div id="pizzaFields" class="d-none">
          <label><b>Toppings:</b></label>
          <div id="toppingsList"></div>
          <input type="text" id="toppingInput" placeholder="Add topping">
          <button type="button" id="addToppingBtn">Add Topping</button>
          <br><br>
          <label><b>Sizes & Prices:</b></label><br>
          <div id="sizesList"></div>
          <select id="sizeNameInput" style="margin-bottom: 12px;">
            <option value="">Select size</option>
            <option value="12in">12in</option>
            <option value="8in">8in</option>
            <option value="Gluten Free">Gluten Free</option>
          </select>
          <input type="number" id="sizePriceInput" placeholder="Price (£)" step="0.01" min="0">
          <button type="button" id="addSizeBtn">Add Size</button>
          <br><br>
          
        </div>
        <button type="submit">Add / Update Item</button>
      </form>
      <div class="menu-list">
        <h3>Current Menu Preview</h3>
        <div id="admin-menu-loading">Loading menu...</div>
  <div id="admin-menu-content" class="d-none"></div>
      </div>
    </section>
  <script>
                // --- Master Toppings Section ---
                // (Removed duplicate/legacy DOMContentLoaded for master toppings and menu preview)
            // --- Toppings, Sizes, and Side Options logic for menu item ---
            // Arrays to hold current form state
            let toppings = [];
            let sizes = [];
            let sideOptions = [];

            // DOM elements
            const addToppingBtn = document.getElementById('addToppingBtn');
            const toppingInput = document.getElementById('toppingInput');
            const toppingsList = document.getElementById('toppingsList');
            const addSizeBtn = document.getElementById('addSizeBtn');
            const sizeNameInput = document.getElementById('sizeNameInput');
            const sizePriceInput = document.getElementById('sizePriceInput');
            const sizesList = document.getElementById('sizesList');
            const addSideOptionBtn = document.getElementById('addSideOptionBtn');
            const sideOptionNameInput = document.getElementById('sideOptionNameInput');
            const sideOptionPriceInput = document.getElementById('sideOptionPriceInput');
            const sidesOptionsList = document.getElementById('sidesOptionsList');

            // Render toppings
            function renderToppings() {
              toppingsList.innerHTML = '';
              toppings.forEach((t, i) => {
                const span = document.createElement('span');
                span.textContent = t;
                span.style.marginRight = '8px';
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'x';
                removeBtn.type = 'button';
                removeBtn.style.marginLeft = '4px';
                removeBtn.onclick = () => { toppings.splice(i, 1); renderToppings(); };
                span.appendChild(removeBtn);
                toppingsList.appendChild(span);
              });
            }
            addToppingBtn.onclick = function() {
              const val = toppingInput.value.trim();
              if(val) { toppings.push(val); toppingInput.value = ''; renderToppings(); }
            };

            // Render sizes
            function renderSizes() {
              sizesList.innerHTML = '';
              sizes.forEach((s, i) => {
                const div = document.createElement('div');
                div.textContent = `${s.name} - £${parseFloat(s.price).toFixed(2)}`;
                div.style.marginRight = '8px';
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'x';
                removeBtn.type = 'button';
                removeBtn.style.marginLeft = '4px';
                removeBtn.onclick = () => { sizes.splice(i, 1); renderSizes(); };
                div.appendChild(removeBtn);
                sizesList.appendChild(div);
              });
            }
            addSizeBtn.onclick = function() {
              let name = sizeNameInput.value;
              const price = sizePriceInput.value.trim();
              // Only allow dropdown values for pizza
              const cat = document.getElementById('categorySelect').value;
              if (cat === 'Pizza') {
                if ((name === '12in' || name === '8in' || name === 'Gluten Free') && price && !isNaN(price)) {
                  sizes.push({name, price: parseFloat(price)});
                  sizeNameInput.value = '';
                  sizePriceInput.value = '';
                  renderSizes();
                }
              } else {
                // For non-pizza, allow free text (fallback, not shown in UI)
                if (name && price && !isNaN(price)) {
                  sizes.push({name, price: parseFloat(price)});
                  sizeNameInput.value = '';
                  sizePriceInput.value = '';
                  renderSizes();
                }
              }
            };

            // Render side options
            function renderSideOptions() {
              sidesOptionsList.innerHTML = '';
              sideOptions.forEach((s, i) => {
                const div = document.createElement('div');
                div.textContent = `${s.name} - £${parseFloat(s.price).toFixed(2)}`;
                div.style.marginRight = '8px';
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'x';
                removeBtn.type = 'button';
                removeBtn.style.marginLeft = '4px';
                removeBtn.onclick = () => { sideOptions.splice(i, 1); renderSideOptions(); };
                div.appendChild(removeBtn);
                sidesOptionsList.appendChild(div);
              });
            }
            addSideOptionBtn.onclick = function() {
              const name = sideOptionNameInput.value.trim();
              const price = sideOptionPriceInput.value.trim();
              if(name && price && !isNaN(price)) {
                sideOptions.push({name, price: parseFloat(price)});
                sideOptionNameInput.value = '';
                sideOptionPriceInput.value = '';
                renderSideOptions();
              }
            };

            // Reset all arrays and UI on form reset
            document.getElementById('menuForm').addEventListener('reset', () => {
              toppings = [];
              sizes = [];
              sideOptions = [];
              renderToppings();
              renderSizes();
              renderSideOptions();
            });

            // Initial render
            renderToppings();
            renderSizes();
            renderSideOptions();
        // Show/hide pizza and sides fields based on category
        document.addEventListener('DOMContentLoaded', function() {
          const categorySelect = document.getElementById('categorySelect');
          const pizzaFields = document.getElementById('pizzaFields');
          const sidesFields = document.getElementById('sidesFields');
          function updateFields() {
            const cat = categorySelect.value;
            if (cat === 'Pizza') {
              pizzaFields.classList.remove('d-none');
              sidesFields.classList.add('d-none');
            } else if (cat === 'Sides') {
              pizzaFields.classList.add('d-none');
              sidesFields.classList.remove('d-none');
            } else {
              pizzaFields.classList.add('d-none');
              sidesFields.classList.add('d-none');
            }
          }
          categorySelect.addEventListener('change', updateFields);
          updateFields();
        });
    // --- Admin Menu Preview Section ---
    async function fetchAdminMenu() {
      const loading = document.getElementById('admin-menu-loading');
      const content = document.getElementById('admin-menu-content');
      loading.style.display = '';
      content.classList.add('d-none');
      try {
        const res = await fetch('http://localhost:8081/api/menu');
        const menu = await res.json();
        renderAdminMenu(menu);
        loading.style.display = 'none';
        content.classList.remove('d-none');
      } catch (err) {
        loading.textContent = 'Error loading menu.';
        content.classList.add('d-none');
        console.error('Failed to fetch admin menu:', err);
      }
    }

    function renderAdminMenu(menu) {
      const content = document.getElementById('admin-menu-content');
      if (!menu || !Array.isArray(menu) || menu.length === 0) {
        content.innerHTML = '<em>No menu items yet.</em>';
        return;
      }
      // Group by category
      const categories = {};
      menu.forEach(item => {
        const cat = item.category || 'Other';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(item);
      });
      let html = '';
      Object.keys(categories).forEach(cat => {
        html += `<h4>${cat}</h4><ul style='padding-left:0;'>`;
        categories[cat].forEach(item => {
          html += `<li style='margin-bottom:8px;list-style:none;'><b>${item.name}</b> - ${item.description ? item.description : ''}`;
          if(cat === 'Pizza' && item.sizes && Array.isArray(item.sizes) && item.sizes.length) {
            html += '<ul style="list-style:none;padding:0;">';
            item.sizes.forEach(size => {
              html += `<li>${size.name}: <span class='price'>£${parseFloat(size.price).toFixed(2)}</span></li>`;
            });
            html += '</ul>';
          }
          html += `</li>`;
        });
        html += '</ul>';
      });
      content.innerHTML = html;
    }
    // --- Pizza Master Toppings Section ---
    async function fetchPizzaMasterToppings() {
      const res = await fetch('http://localhost:8081/api/pizza-topping-stock');
      const toppings = await res.json();
      renderPizzaMasterToppings(toppings);
    }
    function renderPizzaMasterToppings(toppings) {
      const meatList = document.getElementById('pizzaMeatToppingsList');
      const vegList = document.getElementById('pizzaVegToppingsList');
      let otherList = document.getElementById('pizzaOtherToppingsList');
      if (!otherList) {
        otherList = document.createElement('ul');
        otherList.id = 'pizzaOtherToppingsList';
        const otherDiv = document.createElement('div');
        otherDiv.style.flex = '1';
        const otherHeader = document.createElement('h4');
        otherHeader.textContent = 'Other';
        otherDiv.appendChild(otherHeader);
        otherDiv.appendChild(otherList);
        meatList.parentElement.parentElement.appendChild(otherDiv);
      }
      meatList.innerHTML = '';
      vegList.innerHTML = '';
      otherList.innerHTML = '';
      toppings.forEach(t => {
        const li = document.createElement('li');
        li.style.marginBottom = '4px';
        let isEditing = false;
        function renderToppingItem() {
          li.innerHTML = '';
          if (!isEditing) {
            li.textContent = `${t.topping} (${t.type || 'no type'}) £${t.price !== undefined ? parseFloat(t.price).toFixed(2) : '0.00'}`;
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.style.marginLeft = '8px';
            editBtn.onclick = () => { isEditing = true; renderToppingItem(); };
            li.appendChild(editBtn);
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Delete';
            delBtn.style.marginLeft = '8px';
            delBtn.onclick = async () => {
              await deletePizzaMasterTopping(t.topping);
              fetchPizzaMasterToppings();
            };
            li.appendChild(delBtn);
          } else {
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = t.topping;
            nameInput.style.width = '90px';
            const typeSelect = document.createElement('select');
            ['meat','vegetable','other'].forEach(opt => {
              const o = document.createElement('option');
              o.value = opt;
              o.textContent = opt.charAt(0).toUpperCase() + opt.slice(1);
              if (t.type === opt) o.selected = true;
              typeSelect.appendChild(o);
            });
            const priceInput = document.createElement('input');
            priceInput.type = 'number';
            priceInput.step = '0.01';
            priceInput.min = '0';
            priceInput.style.width = '70px';
            priceInput.value = t.price !== undefined ? parseFloat(t.price).toFixed(2) : '0.50';
            function updatePriceField() {
              if (typeSelect.value === 'other') {
                if (!priceInput.value || priceInput.value === '1.00' || priceInput.value === '0.60') priceInput.value = '0.50';
                priceInput.readOnly = false;
              } else if (typeSelect.value === 'meat') {
                priceInput.value = '1.00';
                priceInput.readOnly = false;
              } else if (typeSelect.value === 'vegetable') {
                priceInput.value = '0.60';
                priceInput.readOnly = false;
              } else {
                priceInput.value = '';
                priceInput.readOnly = false;
              }
            }
            typeSelect.addEventListener('change', updatePriceField);
            updatePriceField();
            li.appendChild(nameInput);
            li.appendChild(typeSelect);
            li.appendChild(priceInput);
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.style.marginLeft = '8px';
            saveBtn.onclick = async () => {
              const res = await fetch('http://localhost:8081/api/pizza-topping-stock');
              let allToppings = await res.json();
              const idx = allToppings.findIndex(x => x.topping === t.topping);
              if (idx > -1) {
                allToppings[idx] = {
                  ...allToppings[idx],
                  topping: nameInput.value.trim(),
                  type: typeSelect.value,
                  price: parseFloat(priceInput.value)
                };
                await fetch('http://localhost:8081/api/pizza-topping-stock', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ toppingStatus: allToppings })
                });
                isEditing = false;
                fetchPizzaMasterToppings();
              }
            };
            li.appendChild(saveBtn);
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.style.marginLeft = '8px';
            cancelBtn.onclick = () => { isEditing = false; renderToppingItem(); };
            li.appendChild(cancelBtn);
          }
        }
        renderToppingItem();
        if (typeof t.type === 'string') {
          const typeLower = t.type.trim().toLowerCase();
          if (typeLower === 'meat') {
            meatList.appendChild(li);
          } else if (typeLower === 'vegetable') {
            vegList.appendChild(li);
          } else {
            otherList.appendChild(li);
          }
        } else {
          otherList.appendChild(li);
        }
      });
    }

    async function deletePizzaMasterTopping(name) {
      const res = await fetch('http://localhost:8081/api/pizza-topping-stock');
      let toppings = await res.json();
      toppings = toppings.filter(t => t.topping !== name);
      await fetch('http://localhost:8081/api/pizza-topping-stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ toppingStatus: toppings })
      });
      fetchPizzaMasterToppings();
    }

    const pizzaMasterToppingType = document.getElementById('pizzaMasterToppingType');
    const pizzaMasterToppingPrice = document.getElementById('pizzaMasterToppingPrice');
    pizzaMasterToppingType.addEventListener('change', function() {
      if (this.value === 'other') {
        if (!pizzaMasterToppingPrice.value || pizzaMasterToppingPrice.value === '1.00' || pizzaMasterToppingPrice.value === '0.60') pizzaMasterToppingPrice.value = '0.50';
        pizzaMasterToppingPrice.readOnly = false;
      } else if (this.value === 'meat') {
        pizzaMasterToppingPrice.value = '1.00';
        pizzaMasterToppingPrice.readOnly = false;
      } else if (this.value === 'vegetable') {
        pizzaMasterToppingPrice.value = '0.60';
        pizzaMasterToppingPrice.readOnly = false;
      } else {
        pizzaMasterToppingPrice.value = '';
        pizzaMasterToppingPrice.readOnly = false;
      }
    });

    document.getElementById('addPizzaMasterToppingForm').onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById('pizzaMasterToppingInput').value.trim();
      const type = pizzaMasterToppingType.value;
      const price = parseFloat(pizzaMasterToppingPrice.value);
      if (!name || !type || isNaN(price)) return;
      const res = await fetch('http://localhost:8081/api/pizza-topping-stock');
      let toppings = await res.json();
      let toppingObj = { topping: name, outOfStock: false, type, price };
      toppings.push(toppingObj);
      await fetch('http://localhost:8081/api/pizza-topping-stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ toppingStatus: toppings })
      });
      document.getElementById('pizzaMasterToppingInput').value = '';
      pizzaMasterToppingType.value = '';
      pizzaMasterToppingPrice.value = '';
      fetchPizzaMasterToppings();
    };

    // --- Salad Master Toppings Section ---
    async function fetchSaladMasterToppings() {
      const res = await fetch('http://localhost:8081/api/salad-topping-stock');
      const toppings = await res.json();
      renderSaladMasterToppings(toppings);
    }
    function renderSaladMasterToppings(toppings) {
      const meatList = document.getElementById('saladMeatToppingsList');
      const vegList = document.getElementById('saladVegToppingsList');
      let otherList = document.getElementById('saladOtherToppingsList');
      if (!otherList) {
        otherList = document.createElement('ul');
        otherList.id = 'saladOtherToppingsList';
        const otherDiv = document.createElement('div');
        otherDiv.style.flex = '1';
        const otherHeader = document.createElement('h4');
        otherHeader.textContent = 'Other';
        otherDiv.appendChild(otherHeader);
        otherDiv.appendChild(otherList);
        meatList.parentElement.parentElement.appendChild(otherDiv);
      }
      meatList.innerHTML = '';
      vegList.innerHTML = '';
      otherList.innerHTML = '';
      toppings.forEach(t => {
        const li = document.createElement('li');
        li.style.marginBottom = '4px';
        let isEditing = false;
        function renderToppingItem() {
          li.innerHTML = '';
          if (!isEditing) {
            li.textContent = `${t.topping} (${t.type || 'no type'}) £${t.price !== undefined ? parseFloat(t.price).toFixed(2) : '0.00'}`;
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.style.marginLeft = '8px';
            editBtn.onclick = () => { isEditing = true; renderToppingItem(); };
            li.appendChild(editBtn);
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Delete';
            delBtn.style.marginLeft = '8px';
            delBtn.onclick = async () => {
              await deleteSaladMasterTopping(t.topping);
              fetchSaladMasterToppings();
            };
            li.appendChild(delBtn);
          } else {
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = t.topping;
            nameInput.style.width = '90px';
            const typeSelect = document.createElement('select');
            ['meat','vegetable','other'].forEach(opt => {
              const o = document.createElement('option');
              o.value = opt;
              o.textContent = opt.charAt(0).toUpperCase() + opt.slice(1);
              if (t.type === opt) o.selected = true;
              typeSelect.appendChild(o);
            });
            const priceInput = document.createElement('input');
            priceInput.type = 'number';
            priceInput.step = '0.01';
            priceInput.min = '0';
            priceInput.style.width = '70px';
            priceInput.value = t.price !== undefined ? parseFloat(t.price).toFixed(2) : '0.50';
            function updatePriceField() {
              if (typeSelect.value === 'other') {
                if (!priceInput.value || priceInput.value === '1.00' || priceInput.value === '0.60') priceInput.value = '0.50';
                priceInput.readOnly = false;
              } else if (typeSelect.value === 'meat') {
                priceInput.value = '1.00';
                priceInput.readOnly = false;
              } else if (typeSelect.value === 'vegetable') {
                priceInput.value = '0.60';
                priceInput.readOnly = false;
              } else {
                priceInput.value = '';
                priceInput.readOnly = false;
              }
            }
            typeSelect.addEventListener('change', updatePriceField);
            updatePriceField();
            li.appendChild(nameInput);
            li.appendChild(typeSelect);
            li.appendChild(priceInput);
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.style.marginLeft = '8px';
            saveBtn.onclick = async () => {
              const res = await fetch('http://localhost:8081/api/salad-topping-stock');
              let allToppings = await res.json();
              const idx = allToppings.findIndex(x => x.topping === t.topping);
              if (idx > -1) {
                allToppings[idx] = {
                  ...allToppings[idx],
                  topping: nameInput.value.trim(),
                  type: typeSelect.value,
                  price: parseFloat(priceInput.value)
                };
                await fetch('http://localhost:8081/api/salad-topping-stock', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ toppingStatus: allToppings })
                });
                isEditing = false;
                fetchSaladMasterToppings();
              }
            };
            li.appendChild(saveBtn);
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.style.marginLeft = '8px';
            cancelBtn.onclick = () => { isEditing = false; renderToppingItem(); };
            li.appendChild(cancelBtn);
          }
        }
        renderToppingItem();
        if (typeof t.type === 'string') {
          const typeLower = t.type.trim().toLowerCase();
          if (typeLower === 'meat') {
            meatList.appendChild(li);
          } else if (typeLower === 'vegetable') {
            vegList.appendChild(li);
          } else {
            otherList.appendChild(li);
          }
        } else {
          otherList.appendChild(li);
        }
      });
    }

    async function deleteSaladMasterTopping(name) {
      const res = await fetch('http://localhost:8081/api/salad-topping-stock');
      let toppings = await res.json();
      toppings = toppings.filter(t => t.topping !== name);
      await fetch('http://localhost:8081/api/salad-topping-stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ toppingStatus: toppings })
      });
      fetchSaladMasterToppings();
    }

    const saladMasterToppingType = document.getElementById('saladMasterToppingType');
    const saladMasterToppingPrice = document.getElementById('saladMasterToppingPrice');
    saladMasterToppingType.addEventListener('change', function() {
      if (this.value === 'other') {
        if (!saladMasterToppingPrice.value || saladMasterToppingPrice.value === '1.00' || saladMasterToppingPrice.value === '0.60') saladMasterToppingPrice.value = '0.50';
        saladMasterToppingPrice.readOnly = false;
      } else if (this.value === 'meat') {
        saladMasterToppingPrice.value = '1.00';
        saladMasterToppingPrice.readOnly = false;
      } else if (this.value === 'vegetable') {
        saladMasterToppingPrice.value = '0.60';
        saladMasterToppingPrice.readOnly = false;
      } else {
        saladMasterToppingPrice.value = '';
        saladMasterToppingPrice.readOnly = false;
      }
    });

    document.getElementById('addSaladMasterToppingForm').onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById('saladMasterToppingInput').value.trim();
      const type = saladMasterToppingType.value;
      const price = parseFloat(saladMasterToppingPrice.value);
      if (!name || !type || isNaN(price)) return;
      const res = await fetch('http://localhost:8081/api/salad-topping-stock');
      let toppings = await res.json();
      let toppingObj = { topping: name, outOfStock: false, type, price };
      toppings.push(toppingObj);
      await fetch('http://localhost:8081/api/salad-topping-stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ toppingStatus: toppings })
      });
      document.getElementById('saladMasterToppingInput').value = '';
      saladMasterToppingType.value = '';
      saladMasterToppingPrice.value = '';
      fetchSaladMasterToppings();
    };

    // On page load, fetch both sets of toppings
    document.addEventListener('DOMContentLoaded', function() {
      fetchPizzaMasterToppings();
      fetchSaladMasterToppings();
      fetchAdminMenu();
    });
    addToppingBtn.onclick = function() {
      const val = toppingInput.value.trim();
      if(val) { toppings.push(val); toppingInput.value = ''; renderToppings(); }still 
    };

    // Sizes logic
    // (Removed duplicate sizes logic, now handled above)

    // Add toppings and sizes to form data on submit
    document.getElementById('menuForm').onsubmit = async function(e) {
      // Add toppings to a hidden input for backend
      let hidden = document.getElementById('toppingsHidden');
      if(!hidden) {
        hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'toppings';
        hidden.id = 'toppingsHidden';
        this.appendChild(hidden);
      }
      hidden.value = JSON.stringify(toppings);
      // Add sizes to a hidden input for backend
      let sizesHidden = document.getElementById('sizesHidden');
      if(!sizesHidden) {
        sizesHidden = document.createElement('input');
        sizesHidden.type = 'hidden';
        sizesHidden.name = 'sizes';
        sizesHidden.id = 'sizesHidden';
        this.appendChild(sizesHidden);
      }
      sizesHidden.value = JSON.stringify(sizes);
      // Add side options to a hidden input for backend
      let sideOptionsHidden = document.getElementById('sideOptionsHidden');
      if(!sideOptionsHidden) {
        sideOptionsHidden = document.createElement('input');
        sideOptionsHidden.type = 'hidden';
        sideOptionsHidden.name = 'sideOptions';
        sideOptionsHidden.id = 'sideOptionsHidden';
        this.appendChild(sideOptionsHidden);
      }
      sideOptionsHidden.value = JSON.stringify(sideOptions);

      // Submit form via AJAX to backend
      e.preventDefault();
      const formData = new FormData(this);
      const data = {};
      for (const [key, value] of formData.entries()) {
        // Parse JSON fields
        if(key === 'toppings') {
          let arr = [];
          try {
            arr = value ? JSON.parse(value) : [];
          } catch {
            arr = typeof value === 'string' ? value.split(',').map(t => t.trim()).filter(Boolean) : [];
          }
          data[key] = arr;
        } else if(key === 'sizes' || key === 'sideOptions') {
          data[key] = value ? JSON.parse(value) : [];
        } else if(key === 'glutenFree') {
          // Do nothing: glutenFree is now handled by size only
        } else {
          data[key] = value;
        }
      }
      await fetch('http://localhost:8081/api/menu', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      // Reset form and local arrays
      this.reset();
      toppings = [];
      sizes = [];
      sideOptions = [];
      renderToppings();
      renderSizes();
      renderSideOptions();
      updateMainPriceField && updateMainPriceField();
      // Refresh menu preview after add/update
      fetchAdminMenu();
    };
  </script>
  </main>
</body>
</html>