<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Menu Editor</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header>
    <h1 class="main-heading underline">Menu Editor</h1>
    <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
      <a href="admin-menu.html">Menu Editor</a>
      <a href="stock-management.html">Stock Management</a>
      <a href="timeslots.html">Time Slots</a>
      <a href="orders.html">Orders</a>
      <a href="running-orders.html">Running Orders</a>

      <a href="takings.html">Takings</a>
      <a href="pos.html">POS Manual Order</a>
      <a href="offers.html">Offers</a>
    </nav>
  </header>
  <main>
    <section>
      <h2>Master Toppings</h2>
      <form id="toppingCreatorForm">
        <input type="text" id="toppingNameInput" placeholder="Topping name" required>
        <button type="submit">Add Topping</button>
      </form>
      <div id="toppingsContainer"></div>
    </section>
    <section>
      <h2>Add Section</h2>
      <form id="sectionCreatorForm">
        <input type="text" id="sectionNameInput" placeholder="Section name" required>
        <button type="submit">Add Section</button>
      </form>
    </section>
    <section>
      <h2>Sections</h2>
      <div id="sectionsContainer"></div>
        <section>
          <h2>Add Menu Item</h2>
          <form id="menuItemForm">
            <label>Item Name<br>
              <input type="text" id="itemNameInput" required placeholder="Menu item name">
            </label><br>
            <label>Description (optional)<br>
              <textarea id="itemDescInput" placeholder="Description"></textarea>
            </label><br>
            <label><input type="checkbox" id="showsToppingsInput"> Shows toppings</label><br>
            <label>Section<br>
              <select id="sectionDropdown" required style="min-width: 200px;"></select>
            </label><br>
            <div id="sizesArea">
              <label>Add Size/Type & Price</label><br>
              <input type="text" id="sizeNameInput" placeholder="Size/Type (e.g. 12in, Large)">
              <input type="number" id="sizePriceInput" placeholder="Price (\u00a3)" step="0.01" min="0">
              <button type="button" id="addSizeBtn">Add Size/Type</button>
              <ul id="sizesList"></ul>
            </div>
            <div id="singlePriceArea">
              <label>Single Price (if no sizes/types)</label><br>
              <input type="number" id="singlePriceInput" placeholder="Price (\u00a3)" step="0.01" min="0">
            </div>
            <div>
              <label>Toppings for this item:</label>
              <div id="itemToppingsButtons" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px;"></div>
            </div>
            <button type="submit">Add Menu Item</button>
          </form>
        </section>
        <script>
                      // --- ITEM TOPPINGS LOGIC ---
                      const itemToppingsButtons = document.getElementById('itemToppingsButtons');
                      let selectedToppingIds = [];

                      function populateItemToppingsButtons() {
                        itemToppingsButtons.innerHTML = '';
                        if (!toppings || toppings.length === 0) {
                          itemToppingsButtons.innerHTML = '<em>No master toppings available</em>';
                          return;
                        }
                        toppings.forEach(topping => {
                          const btn = document.createElement('button');
                          btn.type = 'button';
                          btn.textContent = topping.name;
                          btn.className = 'topping-btn';
                          btn.setAttribute('data-id', topping._id);
                          btn.style.border = '1px solid #ccc';
                          btn.style.borderRadius = '4px';
                          btn.style.padding = '4px 10px';
                          btn.style.background = selectedToppingIds.includes(topping._id) ? '#ffe066' : '#f9f9f9';
                          btn.style.cursor = 'pointer';
                          btn.onclick = function() {
                            const id = topping._id;
                            if (selectedToppingIds.includes(id)) {
                              selectedToppingIds = selectedToppingIds.filter(tid => tid !== id);
                            } else {
                              selectedToppingIds.push(id);
                            }
                            populateItemToppingsButtons();
                          };
                          itemToppingsButtons.appendChild(btn);
                        });
                      }

                      // Call this after toppings are loaded
                      function onToppingsLoadedForItems() {
                        populateItemToppingsButtons();
                      }

                      // Patch loadToppings to also update item toppings buttons
                      const originalLoadToppings = loadToppings;
                      loadToppings = async function() {
                        await originalLoadToppings();
                        onToppingsLoadedForItems();
                      };
                // --- MASTER TOPPINGS LOGIC ---
                const toppingForm = document.getElementById('toppingCreatorForm');
                const toppingInput = document.getElementById('toppingNameInput');
                const toppingsContainer = document.getElementById('toppingsContainer');
                let toppings = [];

                async function loadToppings() {
                  try {
                    const res = await fetch(API_BASE_URL + '/api/toppings', { credentials: 'include' });
                    const data = await res.json();
                    toppings = data.toppings || [];
                    renderToppings();
                  } catch (err) {
                    toppingsContainer.innerHTML = '<em>Error loading toppings.</em>';
                  }
                }

                function renderToppings() {
                  toppingsContainer.innerHTML = '';
                  if (!toppings || toppings.length === 0) {
                    toppingsContainer.innerHTML = '<em>No toppings yet. Add one above.</em>';
                    return;
                  }
                  toppings.forEach(topping => {
                    const div = document.createElement('div');
                    div.className = 'topping-row';
                    div.innerHTML = `<span>${topping.name}</span> <button type='button' data-id='${topping._id}' class='delete-topping-btn'>Delete</button>`;
                    toppingsContainer.appendChild(div);
                  });
                  Array.from(document.getElementsByClassName('delete-topping-btn')).forEach(btn => {
                    btn.onclick = async function() {
                      const id = this.getAttribute('data-id');
                      if (!confirm('Delete this topping?')) return;
                      try {
                        const res = await fetch(API_BASE_URL + '/api/toppings/' + id, {
                          method: 'DELETE',
                          credentials: 'include'
                        });
                        if (res.ok) {
                          loadToppings();
                        } else {
                          alert('Failed to delete topping');
                        }
                      } catch (err) {
                        alert('Failed to delete topping: ' + err.message);
                      }
                    };
                  });
                }

                toppingForm.addEventListener('submit', async function(e) {
                  e.preventDefault();
                  const name = toppingInput.value.trim();
                  if (!name) return;
                  try {
                    const res = await fetch(API_BASE_URL + '/api/toppings', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      credentials: 'include',
                      body: JSON.stringify({ name })
                    });
                    if (res.ok) {
                      toppingInput.value = '';
                      loadToppings();
                    } else {
                      const err = await res.json();
                      alert('Error: ' + (err.error || 'Failed to add topping'));
                    }
                  } catch (err) {
                    alert('Failed to add topping: ' + err.message);
                  }
                });
          // Flexible menu item creator logic
          const menuItemForm = document.getElementById('menuItemForm');
          const itemNameInput = document.getElementById('itemNameInput');
          const itemDescInput = document.getElementById('itemDescInput');
          const showsToppingsInput = document.getElementById('showsToppingsInput');
          const sectionDropdown = document.getElementById('sectionDropdown');
          const sizeNameInput = document.getElementById('sizeNameInput');
          const sizePriceInput = document.getElementById('sizePriceInput');
          const addSizeBtn = document.getElementById('addSizeBtn');
          const sizesList = document.getElementById('sizesList');
          const singlePriceInput = document.getElementById('singlePriceInput');
          let sizes = [];
          let sections = [];

          addSizeBtn.onclick = function() {
            const name = sizeNameInput.value.trim();
            const price = sizePriceInput.value.trim();
            if (name && price && !isNaN(price)) {
              sizes.push({ name, price: parseFloat(price) });
              sizeNameInput.value = '';
              sizePriceInput.value = '';
              renderSizes();
            }
          };

          function renderSizes() {
            sizesList.innerHTML = '';
            sizes.forEach((s, i) => {
              const li = document.createElement('li');
              li.textContent = `${s.name} - \u00a3${s.price.toFixed(2)}`;
              const removeBtn = document.createElement('button');
              removeBtn.textContent = 'x';
              removeBtn.type = 'button';
              removeBtn.onclick = () => { sizes.splice(i, 1); renderSizes(); };
              li.appendChild(removeBtn);
              sizesList.appendChild(li);
            });
            // Show/hide single price input
            document.getElementById('singlePriceArea').style.display = sizes.length === 0 ? '' : 'none';
          }
          renderSizes();

          function renderSectionDropdown() {
            sectionDropdown.innerHTML = '';
            if (!sections || sections.length === 0) {
              sectionDropdown.innerHTML = '<option value="" disabled selected>No sections available</option>';
              sectionDropdown.disabled = true;
            } else {
              sectionDropdown.disabled = false;
              sectionDropdown.innerHTML = '<option value="" disabled selected>Select section</option>';
              sections.forEach(section => {
                const opt = document.createElement('option');
                opt.value = section.name;
                opt.textContent = section.name;
                sectionDropdown.appendChild(opt);
              });
            }
          }

          menuItemForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = itemNameInput.value.trim();
            const description = itemDescInput.value.trim();
            const section = sectionDropdown.value;
            const showsToppings = showsToppingsInput.checked;
              let item = { name, toppings: selectedToppingIds };
            if (description) item.description = description;
            item.showsToppings = showsToppings;
            if (sizes.length > 0) {
              item.sizes = sizes;
            } else {
              const price = singlePriceInput.value.trim();
              if (price && !isNaN(price)) {
                item.price = parseFloat(price);
              }
            }
            if (section) item.section = section;
            // Save to backend
            try {
              const res = await fetch(API_BASE_URL + '/api/menu', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(item)
              });
              if (res.ok) {
                alert('Menu item added!');
                menuItemForm.reset();
                sizes = [];
                renderSizes();
                loadMenuPreview();
              } else {
                const err = await res.json();
                alert('Error: ' + (err.error || 'Failed to add item'));
              }
            } catch (err) {
              alert('Failed to add item: ' + err.message);
            }
          });
        </script>
    </section>
    <script>
      // Section creator logic with MongoDB backend
      const sectionForm = document.getElementById('sectionCreatorForm');
      const sectionInput = document.getElementById('sectionNameInput');
      const sectionsContainer = document.getElementById('sectionsContainer');
      const API_BASE_URL = window.location.hostname === 'localhost' ? '' : 'https://the-crust-at-none-go-bye-admin.onrender.com';

      // Load sections from backend on page load
      async function loadSections() {
        try {
          const res = await fetch(API_BASE_URL + '/api/sections', { credentials: 'include' });
          const data = await res.json();
          sections = data.sections || [];
          renderSections(sections);
          renderSectionDropdown();
        } catch (err) {
          console.error('Failed to load sections:', err);
          sectionsContainer.innerHTML = '<em>Error loading sections.</em>';
        }
      }

      // Add section to backend
      sectionForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const name = sectionInput.value.trim();
        if (!name) return;

        try {
          const res = await fetch(API_BASE_URL + '/api/sections', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ name })
          });

          if (res.ok) {
            sectionInput.value = '';
            loadSections(); // Reload sections from backend
          } else {
            const err = await res.json();
            alert('Error: ' + (err.error || 'Failed to add section'));
          }
        } catch (err) {
          alert('Failed to add section: ' + err.message);
        }
      });

      // Delete section from backend
      async function deleteSection(id) {
        if (!confirm('Delete this section?')) return;

        try {
          const res = await fetch(API_BASE_URL + '/api/sections/' + id, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (res.ok) {
            loadSections(); // Reload sections from backend
          } else {
            alert('Failed to delete section');
          }
        } catch (err) {
          alert('Failed to delete section: ' + err.message);
        }
      }

      // Render sections in UI
      function renderSections(sections) {
        sectionsContainer.innerHTML = '';
        if (!sections || sections.length === 0) {
          sectionsContainer.innerHTML = '<em>No sections yet. Add one above.</em>';
          return;
        }

        sections.forEach((section) => {
          const div = document.createElement('div');
          div.className = 'section-row';
          div.innerHTML = `<span>${section.name}</span> <button type='button' data-id='${section._id}' class='delete-section-btn'>Delete</button>`;
          sectionsContainer.appendChild(div);
        });

        // Add delete logic
        Array.from(document.getElementsByClassName('delete-section-btn')).forEach(btn => {
          btn.onclick = function() {
            const id = this.getAttribute('data-id');
            deleteSection(id);
          };
        });
      }

      // Initial load
      loadSections();

      // --- MENU PREVIEW ---
      const menuPreviewContainer = document.createElement('section');
      menuPreviewContainer.innerHTML = '<h2>Menu Preview</h2><div id="menuPreview"></div>';
      document.querySelector('main').appendChild(menuPreviewContainer);

      async function loadMenuPreview() {
        try {
          const res = await fetch(API_BASE_URL + '/api/menu', { credentials: 'include' });
          const data = await res.json();
          renderMenuPreview(data.items || []);
        } catch (err) {
          document.getElementById('menuPreview').innerHTML = '<em>Error loading menu preview.</em>';
        }
      }

      function renderMenuPreview(menuItems) {
        const preview = document.getElementById('menuPreview');
        preview.innerHTML = '';
        if (!menuItems || menuItems.length === 0) {
          preview.innerHTML = '<em>No menu items yet.</em>';
          return;
        }
        // Group by section
        const grouped = {};
        menuItems.forEach(item => {
          if (!grouped[item.section]) grouped[item.section] = [];
          grouped[item.section].push(item);
        });
        Object.keys(grouped).forEach(section => {
          const secDiv = document.createElement('div');
          secDiv.className = 'menu-preview-section';
          secDiv.innerHTML = `<h3>${section}</h3>`;
          grouped[section].forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'menu-preview-item';
            itemDiv.innerHTML = `<strong>${item.name}</strong> - ${item.description ? item.description : ''}<br>`;
            if (item.sizes && item.sizes.length > 0) {
              itemDiv.innerHTML += '<ul>' + item.sizes.map(s => `<li>${s.name}: \u00a3${s.price.toFixed(2)}</li>`).join('') + '</ul>';
            } else if (item.price) {
              itemDiv.innerHTML += `<span>Price: \u00a3${item.price.toFixed(2)}</span>`;
            }
            // Add delete button
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Delete';
            delBtn.className = 'delete-menu-item-btn';
            delBtn.style.marginLeft = '10px';
            delBtn.onclick = async function() {
              if (!confirm('Delete this menu item?')) return;
              try {
                const res = await fetch(API_BASE_URL + '/api/menu/' + item._id, {
                  method: 'DELETE',
                  credentials: 'include'
                });
                if (res.ok) {
                  loadMenuPreview();
                } else {
                  alert('Failed to delete menu item');
                }
              } catch (err) {
                alert('Failed to delete menu item: ' + err.message);
              }
            };
            itemDiv.appendChild(delBtn);
            secDiv.appendChild(itemDiv);
          });
          preview.appendChild(secDiv);
        });
      }

      loadMenuPreview();
    </script>
  </main>
  <script src="/admin-menu.js"></script>
