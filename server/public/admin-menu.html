<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin ‚Äì Menu Editor | None Go Bye</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="admin-page">
  <script>
    // Login/session check
    fetch('/api/admin/check', { credentials: 'include' })
      .then(r => {
        if (!r.ok) window.location.href = 'login.html';
      });
  </script>
  <script src="/admin-order-toast.js"></script>
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <header>
    <h1 class="main-heading underline">Admin Menu Editor <button id="lock-page-btn" class="lock-page-btn" onclick="lockAdminPage()">Lock this page</button></h1>
    <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
      <a href="admin-menu.html">Menu Editor</a>
      <a href="stock-management.html">Stock Management</a>
      <a href="timeslots.html">Time Slots</a>
      <a href="orders.html">Orders</a>
      <a href="running-orders.html">Running Orders</a>
      <a href="takings.html">Takings</a>
      <a href="pos.html">POS Manual Order</a>
      <a href="offers.html">Special Offers</a>
    </nav>
  </header>
  <main id="main-content">
    <div class="master-toppings card">
      <h2>Master Toppings</h2>
      <div class="toppings-group">
        <div class="toppings-category">
          <h3>Pizza Toppings</h3>
          <div class="toppings-columns">
            <div class="toppings-col">
              <h4 class="toppings-heading">Vegetable</h4>
              <ul id="pizzaVegToppingsList" class="toppings-list"></ul>
            </div>
            <div class="toppings-col">
              <h4 class="toppings-heading">Meat</h4>
              <ul id="pizzaMeatToppingsList" class="toppings-list"></ul>
            </div>
            <div class="toppings-col">
              <h4 class="toppings-heading">Other</h4>
              <ul id="pizzaOtherToppingsList" class="toppings-list"></ul>
            </div>
          </div>
          <label>Vegetable Price (¬£): <input type="number" id="pizzaVegDefaultPrice" step="0.01" min="0" value="0.60"></label>
          <label>Meat Price (¬£): <input type="number" id="pizzaMeatDefaultPrice" step="0.01" min="0" value="1.00"></label>
          <label>Other Price (¬£): <input type="number" id="pizzaOtherDefaultPrice" step="0.01" min="0" value="0.50"></label>
        </div>
          <form id="addPizzaMasterToppingForm" class="topping-form">
            <input type="text" id="pizzaMasterToppingInput" placeholder="Topping name" required>
            <select id="pizzaMasterToppingType" required title="Select topping type">
              <option value="">Type</option>
              <option value="vegetable">Vegetable</option>
              <option value="meat">Meat</option>
              <option value="other">Other</option>
            </select>
            <button type="submit">Add Topping</button>
          </form>
        </div>
        <div class="toppings-category">
          <h3>Salad Toppings</h3>
          <div class="toppings-columns">
            <div class="toppings-col">
              <h4 class="toppings-heading">Vegetable</h4>
              <ul id="saladVegToppingsList" class="toppings-list"></ul>
            </div>
            <div class="toppings-col">
              <h4 class="toppings-heading">Meat</h4>
              <ul id="saladMeatToppingsList" class="toppings-list"></ul>
            </div>
            <div class="toppings-col">
              <h4 class="toppings-heading">Other</h4>
              <ul id="saladOtherToppingsList" class="toppings-list"></ul>
            </div>
          </div>
          <div class="default-prices">
            <label>Vegetable Price (¬£): <input type="number" id="saladVegDefaultPrice" step="0.01" min="0" value="0.60"></label>
            <label>Meat Price (¬£): <input type="number" id="saladMeatDefaultPrice" step="0.01" min="0" value="1.00"></label>
            <label>Other Price (¬£): <input type="number" id="saladOtherDefaultPrice" step="0.01" min="0" value="0.50"></label>
          </div>
        </div>
          <form id="addSaladMasterToppingForm" class="topping-form">
            <input type="text" id="saladMasterToppingInput" placeholder="Topping name" required>
            <select id="saladMasterToppingType" required title="Select topping type">
              <option value="">Type</option>
              <option value="vegetable">Vegetable</option>
              <option value="meat">Meat</option>
              <option value="other">Other</option>
            </select>
            <button type="submit">Add Topping</button>
          </form>
        </div>
        <div class="toppings-category">
          <h3>Other Toppings</h3>
          <div class="toppings-columns">
            <div class="toppings-col">
              <h4 class="toppings-heading">Vegetable</h4>
              <ul id="otherVegToppingsList" class="toppings-list"></ul>
            </div>
            <div class="toppings-col">
              <h4 class="toppings-heading">Meat</h4>
              <ul id="otherMeatToppingsList" class="toppings-list"></ul>
            </div>
            <div class="toppings-col">
              <h4 class="toppings-heading">Other</h4>
              <ul id="otherOtherToppingsList" class="toppings-list"></ul>
            </div>
          </div>
          <div class="default-prices">
            <label>Vegetable Price (¬£): <input type="number" id="otherVegDefaultPrice" step="0.01" min="0" value="0.60"></label>
            <label>Meat Price (¬£): <input type="number" id="otherMeatDefaultPrice" step="0.01" min="0" value="1.00"></label>
            <label>Other Price (¬£): <input type="number" id="otherOtherDefaultPrice" step="0.01" min="0" value="0.50"></label>
          </div>
        </div>
          <form id="addOtherMasterToppingForm" class="topping-form">
            <input type="text" id="otherMasterToppingInput" placeholder="Topping name" required>
            <select id="otherMasterToppingType" required title="Select topping type">
              <option value="">Type</option>
              <option value="vegetable">Vegetable</option>
              <option value="meat">Meat</option>
              <option value="other">Other</option>
            </select>
            <button type="submit">Add Topping</button>
          </form>
        </div>
      </div>
    </div>
    <section class="admin-section">
      <div class="menu-section-controls card">
        <h2>Menu Sections</h2>
        <div class="form-row">
          <label for="newSectionInput" class="newSectionLabel">Add New Section:</label>
          <input type="text" id="newSectionInput" placeholder="New section name">
          <button id="addSectionBtn">Add Section</button>
        </div>
        <small class="help-text">Each section below manages its own menu items.</small>
      </div>
      <div id="allSectionsContainer"></div>
      <script>
      <!-- moved script to bottom of file -->
    </section>
    <section class="menu-preview card">
      <h2>Menu Preview</h2>
      <div id="menuPreviewContent"></div>
    </section>
  </main>
  <!-- scripts moved to bottom -->
    // --- Global State ---
    let masterToppings = {
      pizza: [],
      salad: [],
      other: []
    };
    let menuSections = [];
    // sectionDetails: { [sectionName]: [ { item fields... }, ... ] }
    let sectionDetails = {};
    let currentSection = '';
    let editingItemIndex = null;

    // --- Lock Page Logic ---
        // --- Section Items UI Logic ---
        function updateSectionItemsUI() {
          const listDiv = document.getElementById('menuItemsList');
          listDiv.innerHTML = '';
          console.log('[DEBUG] updateSectionItemsUI: currentSection =', currentSection);
          console.log('[DEBUG] updateSectionItemsUI: sectionDetails keys =', Object.keys(sectionDetails));
          // TEMP: Show all items from all sections for debugging
          let totalItems = 0;
          Object.entries(sectionDetails).forEach(([section, items]) => {
            if (!Array.isArray(items)) return;
            items.forEach((item, idx) => {
              totalItems++;
              const card = document.createElement('div');
              card.className = 'menu-item-card';
              card.style.boxShadow = '0 2px 12px rgba(185,71,46,0.08)';
              card.style.border = '2px solid #f3f7ef';
              card.style.background = '#fff';
              card.style.margin = '0';
              card.style.maxWidth = '340px';
              card.style.padding = '1.2rem 1rem';
              card.style.textAlign = 'left';
              card.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;">
                  <b style="font-size:1.2em;">${item.name}</b>
                  <span style="font-size:0.9em;color:#888;">[Section: ${section}]</span>
                  <span>
                    <button class="edit-menu-item-btn" data-section="${section}" data-idx="${idx}" title="Edit" style="background:#e9ece5;border:none;border-radius:50%;padding:6px 10px;cursor:pointer;font-size:1.1em;margin-right:4px;">‚úèÔ∏è</button>
                    <button class="delete-menu-item-btn" data-section="${section}" data-idx="${idx}" title="Delete" style="background:#ffeaea;border:none;border-radius:50%;padding:6px 10px;cursor:pointer;font-size:1.1em;">üóëÔ∏è</button>
                  </span>
                </div>
                <div style="color:#888;margin-bottom:8px;">${item.description || ''}</div>
                <div style="margin-bottom:8px;"><span style="font-weight:600;">Sizes:</span> ${item.sizes.map(s => `<span style='background:#f3f7ef;border-radius:12px;padding:2px 10px;margin-right:6px;'>${s.name} (¬£${s.price})</span>`).join('')}</div>
                <div><span style="font-weight:600;">Toppings:</span> ${item.toppings.map(t => t.name || t).join(', ') || '<span style="color:#bbb;">None</span>'}</div>
              `;
              listDiv.appendChild(card);
            });
          });
          if (totalItems === 0) {
            listDiv.innerHTML = '<em>No items in any section.</em>';
          }
          // Attach event listeners for all edit/delete buttons
          Array.from(listDiv.getElementsByClassName('edit-menu-item-btn')).forEach(btn => {
            btn.onclick = () => editMenuItem(parseInt(btn.dataset.idx), btn.dataset.section);
          });
          Array.from(listDiv.getElementsByClassName('delete-menu-item-btn')).forEach(btn => {
            btn.onclick = () => deleteMenuItem(parseInt(btn.dataset.idx), btn.dataset.section);
          });
        }

        // Removed obsolete addNewMenuItemBtn handler; now handled per section card

        function showMenuItemEditor(item = null, idx = null) {
          document.getElementById('menuItemEditor').style.display = '';
          // If the form doesn't exist, inject it (idempotent)
          const editor = document.getElementById('menuItemEditor');
          if (editor && !document.getElementById('editorAddSizeTypeForm')) {
            const form = document.createElement('form');
            form.id = 'editorAddSizeTypeForm';
            form.innerHTML = `
              <input type="text" id="editorSizeTypeInput" placeholder="Size/type name" required>
              <input type="number" id="editorSizeTypePriceInput" placeholder="Price (¬£)" step="0.01" min="0" required>
              <button type="submit">Add Size/Type</button>
            `;
            editor.appendChild(form);
            const ul = document.createElement('ul');
            ul.id = 'editorSizeTypeList';
            editor.appendChild(ul);
          }
          document.getElementById('editorItemName').value = item ? item.name : '';
          document.getElementById('editorDescription').value = item ? item.description : '';
          // Sizes
          editorSizeTypes = item ? [...item.sizes] : [];
          updateEditorSizeTypeList();
          // Toppings
          editorToppings = item ? [...item.toppings] : [];
          updateEditorToppingsList();
          // Populate toppings dropdown
          const toppingSelect = document.getElementById('editorToppingSelect');
          toppingSelect.innerHTML = '<option value="">Select topping</option>';
          // Determine section category
          let category = 'pizza';
          if (currentSection && currentSection.toLowerCase().includes('salad')) category = 'salad';
          else if (currentSection && currentSection.toLowerCase().includes('other')) category = 'other';
          const toppings = masterToppings[category] || [];
          toppings.forEach(tp => {
            if (!editorToppings.some(t => t.name === tp.name)) {
              toppingSelect.innerHTML += `<option value="${tp.name}">${tp.name}</option>`;
            }
          });
          editingItemIndex = idx;
        }

        const cancelBtn = document.getElementById('cancelMenuItemBtn');
        if (cancelBtn) {
          cancelBtn.onclick = () => {
            document.getElementById('menuItemEditor').style.display = 'none';
            editingItemIndex = null;
          };
        }

        const saveBtn = document.getElementById('saveMenuItemBtn');
        if (saveBtn) {
          saveBtn.onclick = () => {
            if (!currentSection || currentSection.trim() === '') {
              alert('Please select a valid section before saving a menu item.');
              return;
            }
            const name = document.getElementById('editorItemName').value.trim();
            const description = document.getElementById('editorDescription').value.trim();
            if (!name) {
              alert('Menu item name required');
              return;
            }
            // Convert sizes to {name, price} for backend
            const sizes = editorSizeTypes.map(sz => ({ name: sz.name || sz.type, price: sz.price }));
            const newItem = {
              name,
              description,
              sizes,
              toppings: [...editorToppings]
            };
            if (editingItemIndex !== null) {
              sectionDetails[currentSection][editingItemIndex] = newItem;
            } else {
              if (!sectionDetails[currentSection]) sectionDetails[currentSection] = [];
              sectionDetails[currentSection].push(newItem);
            }
            document.getElementById('menuItemEditor').style.display = 'none';
            editingItemIndex = null;
            updateSectionItemsUI();
            console.log('[DEBUG] sectionDetails after save:', JSON.parse(JSON.stringify(sectionDetails)));
            saveMenuToServer();
            // Do NOT reload from backend after saving a single item; keep all items in sectionDetails
          };
        }

        function editMenuItem(idx) {
          // Support section override for debug mode
          let section = currentSection;
          if (arguments.length > 1 && arguments[1]) section = arguments[1];
          const item = sectionDetails[section][idx];
          showMenuItemEditor(item, idx);
        }

        function deleteMenuItem(idx) {
          // Support section override for debug mode
          let section = currentSection;
          if (arguments.length > 1 && arguments[1]) section = arguments[1];
          if (confirm('Delete this menu item?')) {
            sectionDetails[section].splice(idx, 1);
            updateSectionItemsUI();
            renderMenuPreview();
            saveMenuToServer();
          }
        }

        // --- Editor Size/Type Logic ---
        let editorSizeTypes = [];
        document.getElementById('editorAddSizeTypeForm').onsubmit = e => {
          e.preventDefault();
          const name = document.getElementById('editorSizeTypeInput').value.trim();
          const price = parseFloat(document.getElementById('editorSizeTypePriceInput').value);
          if (isNaN(price)) {
            alert('Please enter a price for the size/type.');
            return;
          }
          editorSizeTypes.push({ name, price });
          document.getElementById('editorSizeTypeInput').value = '';
          document.getElementById('editorSizeTypePriceInput').value = '';
          updateEditorSizeTypeList();
        };

        function updateEditorSizeTypeList() {
          const ul = document.getElementById('editorSizeTypeList');
          ul.innerHTML = '';
          editorSizeTypes.forEach((sz, idx) => {
            const li = document.createElement('li');
            li.textContent = `${sz.name} (¬£${sz.price})`;
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Remove';
            delBtn.onclick = () => {
              editorSizeTypes.splice(idx, 1);
              updateEditorSizeTypeList();
            };
            li.appendChild(delBtn);
            ul.appendChild(li);
          });
        }

        // --- Editor Toppings Logic ---
        let editorToppings = [];
        document.getElementById('editorAddToppingForm').onsubmit = e => {
          e.preventDefault();
          const sel = document.getElementById('editorToppingSelect');
          const name = sel.value;
          if (!name) return;
          if (!editorToppings.some(t => t.name === name)) {
            editorToppings.push({ name });
            updateEditorToppingsList();
          }
        };

        function updateEditorToppingsList() {
          const ul = document.getElementById('editorToppingsList');
          ul.innerHTML = '';
          editorToppings.forEach((tp, idx) => {
            const li = document.createElement('li');
            li.textContent = tp.name;
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Remove';
            delBtn.onclick = () => {
              editorToppings.splice(idx, 1);
              updateEditorToppingsList();
            };
            li.appendChild(delBtn);
            ul.appendChild(li);
          });
        }
    function lockAdminPage() {
      fetch('/api/admin/lock', { method: 'POST', credentials: 'include' })
        .then(r => {
          if (r.ok) {
            alert('Page locked. You will not be logged out automatically.');
          } else {
            alert('Failed to lock page.');
          }
        });
    }

    // --- Load menu from server ---
    async function loadMenuFromServer() {
      try {
        const response = await fetch('/api/menu', { credentials: 'include' });
        const data = await response.json();
        sectionDetails = {};
        const foundSections = new Set();
        console.log('[DEBUG] Loaded menu data:', data);
        if (data.items && Array.isArray(data.items)) {
          data.items.forEach(item => {
            // Only default to 'Uncategorized' if section is truly missing or empty
            const section = (item.section && item.section.trim()) ? item.section.trim() : 'Uncategorized';
            foundSections.add(section);
            if (!sectionDetails[section]) sectionDetails[section] = [];
            sectionDetails[section].push({
              name: item.name || '',
              description: item.description || '',
              sizes: item.sizes || [],
              toppings: (item.toppings || []).map(tp => typeof tp === 'string' ? { name: tp, price: 0 } : tp)
            });
          });
        }
        menuSections = Array.from(foundSections);
        console.log('[DEBUG] sectionDetails after load:', sectionDetails);
        console.log('[DEBUG] menuSections after load:', menuSections);
        updateAllUI();
        // Automatically select and show the first section after loading
        if (menuSections.length > 0) {
          const sectionSelect = document.getElementById('menuSectionSelect');
          sectionSelect.value = menuSections[0];
          showSectionDetails(menuSections[0]);
        }
      } catch (error) {
        console.error('Failed to load menu from server:', error);
      }
    }

    // --- Save menu to server ---
    async function saveMenuToServer() {
      try {
        // Always sync menuSections with sectionDetails keys before saving
        menuSections = Object.keys(sectionDetails).filter(
          key => Array.isArray(sectionDetails[key])
        );
        // Flatten sectionDetails to array of menu items for backend
        const items = [];
        Object.entries(sectionDetails).forEach(([section, arr]) => {
          if (Array.isArray(arr)) {
            arr.forEach(item => {
              items.push({
                name: item.name,
                description: item.description,
                sizes: item.sizes || [],
                toppings: (item.toppings || []).map(tp => typeof tp === 'string' ? tp : tp.name),
                section
              });
            });
          }
        });
        console.log('[DEBUG] Items sent to backend:', items);
        if (items.length === 0) {
          alert('Warning: You are about to save an empty menu. Please add at least one section and item.');
        }
        await fetch('/api/menu', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(items)
        });
        alert('Menu saved to server!');
      } catch (error) {
        console.error('Failed to save menu to server:', error);
        alert('Failed to save menu to server');
      }
    }

    // --- Load Menu Sections ---
    async function loadMenuSections() {
      try {
        const response = await fetch('/api/menu', { credentials: 'include' });
        const data = await response.json();
        const sections = new Set();
        if (data.items && Array.isArray(data.items)) {
          data.items.forEach(item => {
            if (item.section) sections.add(item.section);
            // Always initialize as array
            if (item.section && !sectionDetails[item.section]) {
              sectionDetails[item.section] = [];
            }
          });
        }
        menuSections = Array.from(sections);
        updateSectionDropdown();
      } catch (error) {
        console.error('Failed to load menu sections:', error);
        alert('Failed to load menu sections');
      }
    }

    // --- Update Section Dropdown ---
    function updateSectionDropdown() {
      const select = document.getElementById('menuSectionSelect');
      if (!select) return;
      select.innerHTML = '<option value="">-- Select Section --</option>';
      menuSections.forEach(section => {
        const option = document.createElement('option');
        option.value = section;
        option.textContent = section;
        select.appendChild(option);
      });
    }

    // --- Show Section Details ---
    function showSectionDetails(section) {
      currentSection = section;
      const detailsDiv = document.getElementById('sectionDetails');
      if (!detailsDiv) return;
      if (!section) {
        detailsDiv.style.display = 'none';
        return;
      }
      detailsDiv.style.display = '';
      // Determine category from section name (simple logic, adjust as needed)
      let category = 'pizza';
      if (section.toLowerCase().includes('salad')) category = 'salad';
      else if (section.toLowerCase().includes('other')) category = 'other';
      populateSectionToppingSelect(category, section);
      // Populate details
      document.getElementById('sectionItemName').value = sectionDetails[section]?.itemName || '';
      document.getElementById('sectionDescription').value = sectionDetails[section]?.description || '';
      renderSizeTypeList(section);
      renderSectionToppings(section);
    }

    // --- Save Section Details ---
    function saveSectionDetails() {
      if (!currentSection) return;
      sectionDetails[currentSection] = sectionDetails[currentSection] || {};
      sectionDetails[currentSection].itemName = document.getElementById('sectionItemName').value;
      sectionDetails[currentSection].description = document.getElementById('sectionDescription').value;
      saveSectionDetailsToStorage();
      alert('Section details saved!');
    }

    // --- Add New Section ---
    // Handler moved to bottom script block
      // --- Section Toppings Form ---
      const addSectionToppingForm = document.getElementById('addSectionToppingForm');
      if (addSectionToppingForm) {
        addSectionToppingForm.addEventListener('submit', function(e) {
          e.preventDefault();
          if (!currentSection) return;
          const toppingName = document.getElementById('sectionToppingSelect').value;
          if (!toppingName) {
            alert('Please select a topping');
            return;
          }
          sectionDetails[currentSection].toppings = sectionDetails[currentSection].toppings || [];
          if (sectionDetails[currentSection].toppings.includes(toppingName)) {
            alert('Topping already added');
            return;
          }
          sectionDetails[currentSection].toppings.push(toppingName);
          // Always save toppings as array of strings
          sectionDetails[currentSection].toppings = sectionDetails[currentSection].toppings.map(tp => typeof tp === 'string' ? tp : tp.name);
          renderSectionToppings(currentSection);
        });
      }
      // --- Size/Type Form ---
      const addSizeTypeForm = document.getElementById('addSizeTypeForm');
      if (addSizeTypeForm) {
        addSizeTypeForm.addEventListener('submit', function(e) {
          e.preventDefault();
          if (!currentSection) return;
          const sizeType = document.getElementById('sizeTypeInput').value.trim();
          const price = parseFloat(document.getElementById('sizeTypePriceInput').value);
          if (!sizeType || isNaN(price)) {
            alert('Please enter a size/type name and price');
            return;
          }
          sectionDetails[currentSection].sizeTypes = sectionDetails[currentSection].sizeTypes || [];
          // Always save as { name: ..., price: ... }
          sectionDetails[currentSection].sizeTypes.push({ name: sizeType, price });
          saveSectionDetailsToStorage();
          renderSizeTypeList(currentSection);
          addSizeTypeForm.reset();
        });
      }
      // --- Add Pizza Master Topping ---
      const addPizzaMasterToppingForm = document.getElementById('addPizzaMasterToppingForm');
      if (addPizzaMasterToppingForm) {
        addPizzaMasterToppingForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const name = document.getElementById('pizzaMasterToppingInput').value.trim();
          const type = document.getElementById('pizzaMasterToppingType').value;
          if (!name || !type) {
            alert('Please enter a topping name and select a type');
            return;
          }
          // Get default price for type
          const price = getPriceForType('pizza', type);
          masterToppings.pizza.push({ name, type, price });
          saveMasterToppings();
          renderMasterToppings('pizza');
          addPizzaMasterToppingForm.reset();
          // Refresh toppings dropdown for current section
          if (currentSection) populateSectionToppingSelect('pizza', currentSection);
        });
      }
      // --- Add Salad Master Topping ---
      const addSaladMasterToppingForm = document.getElementById('addSaladMasterToppingForm');
      if (addSaladMasterToppingForm) {
        addSaladMasterToppingForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const name = document.getElementById('saladMasterToppingInput').value.trim();
          const type = document.getElementById('saladMasterToppingType').value;
          if (!name || !type) {
            alert('Please enter a topping name and select a type');
            return;
          }
          const price = getPriceForType('salad', type);
          masterToppings.salad.push({ name, type, price });
          saveMasterToppings();
          renderMasterToppings('salad');
          addSaladMasterToppingForm.reset();
          if (currentSection) populateSectionToppingSelect('salad', currentSection);
        });
      }
      // --- Add Other Master Topping ---
      const addOtherMasterToppingForm = document.getElementById('addOtherMasterToppingForm');
      if (addOtherMasterToppingForm) {
        addOtherMasterToppingForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const name = document.getElementById('otherMasterToppingInput').value.trim();
          const type = document.getElementById('otherMasterToppingType').value;
          if (!name || !type) {
            alert('Please enter a topping name and select a type');
            return;
          }
          const price = getPriceForType('other', type);
          masterToppings.other.push({ name, type, price });
          saveMasterToppings();
          renderMasterToppings('other');
          addOtherMasterToppingForm.reset();
          if (currentSection) populateSectionToppingSelect('other', currentSection);
        });
      }
      loadMasterToppings();
      loadMenuSections();
      updateAllUI();
      // Delete section logic
      const deleteSectionBtn = document.getElementById('deleteSectionBtn');
      deleteSectionBtn.onclick = function() {
        const sectionSelect = document.getElementById('menuSectionSelect');
        const section = sectionSelect.value;
        if (!section) {
          alert('Select a section to delete');
          return;
        }
        if (!confirm(`Delete section "${section}" and all its items?`)) return;
        // Remove from menuSections and sectionDetails
        menuSections = menuSections.filter(s => s !== section);
        delete sectionDetails[section];
        // Update dropdown and UI
        updateSectionDropdown();
        sectionSelect.value = '';
        updateSectionItemsUI();
        renderMenuPreview();
        saveMenuToServer();
      };
    });

    // --- Populate Section Topping Select ---
    function populateSectionToppingSelect(category, section) {
      const select = document.getElementById('sectionToppingSelect');
      if (!select) return;
      let toppings = [];
      if (category === 'pizza') toppings = masterToppings.pizza;
      else if (category === 'salad') toppings = masterToppings.salad;
      else toppings = masterToppings.other;
      // Only show master toppings not already added to this menu item
      const addedToppings = sectionDetails[section]?.toppings || [];
      select.innerHTML = '<option value="">Select topping</option>';
      toppings.forEach(tp => {
        if (!addedToppings.includes(tp.name)) {
          select.innerHTML += `<option value="${tp.name}">${tp.name}</option>`;
        }
      });
    }

    // --- Render Section Toppings ---
    function renderSectionToppings(section) {
      const list = document.getElementById('sectionToppingsList');
      if (!list || !sectionDetails[section]) return;
      list.innerHTML = '';
      (sectionDetails[section].toppings || []).forEach((topping, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${topping}</span> <button onclick="deleteSectionTopping('${section}', ${idx})">Remove</button>`;
        list.appendChild(li);
      });
    }
    window.deleteSectionTopping = function(section, idx) {
      sectionDetails[section].toppings.splice(idx, 1);
      renderSectionToppings(section);
    }

    // --- Render Size/Type List ---
    function renderSizeTypeList(section) {
      const list = document.getElementById('sizeTypeList');
      if (!list || !sectionDetails[section]) return;
      list.innerHTML = '';
      (sectionDetails[section].sizeTypes || []).forEach((item, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${item.name} - ¬£${item.price.toFixed(2)}</span> <button onclick="deleteSizeType('${section}', ${idx})">Delete</button>`;
        list.appendChild(li);
      });
    }
    // --- Delete Size/Type ---
    function deleteSizeType(section, idx) {
      if (!sectionDetails[section]) return;
      if (confirm('Are you sure you want to delete this size/type?')) {
        sectionDetails[section].sizeTypes.splice(idx, 1);
        saveSectionDetailsToStorage();
        renderSizeTypeList(section);
      }
    }
    // --- Save Section Details to LocalStorage ---
    function saveSectionDetailsToStorage() {
      localStorage.setItem('sectionDetails', JSON.stringify(sectionDetails));
    }
    // --- Load Section Details from LocalStorage ---
    function loadSectionDetailsFromStorage() {
      const saved = localStorage.getItem('sectionDetails');
      if (saved) {
        sectionDetails = JSON.parse(saved);
      }
    }
    // --- Master Toppings Logic (unchanged) ---
    function getPriceForType(category, type) {
      const vegPrice = document.getElementById(`${category}VegDefaultPrice`);
      const meatPrice = document.getElementById(`${category}MeatDefaultPrice`);
      const otherPrice = document.getElementById(`${category}OtherDefaultPrice`);
      if (type === 'vegetable' && vegPrice) return parseFloat(vegPrice.value);
      if (type === 'meat' && meatPrice) return parseFloat(meatPrice.value);
      if (type === 'other' && otherPrice) return parseFloat(otherPrice.value);
      return 0.50;
    }
    function loadMasterToppings() {
      const saved = localStorage.getItem('masterToppings');
      if (saved) {
        masterToppings = JSON.parse(saved);
      }
      renderMasterToppings('pizza');
      renderMasterToppings('salad');
      renderMasterToppings('other');
    }
    function saveMasterToppings() {
      localStorage.setItem('masterToppings', JSON.stringify(masterToppings));
    }
    function renderMasterToppings(category) {
      // Render toppings by type into three columns
      const vegList = document.getElementById(`${category}VegToppingsList`);
      const meatList = document.getElementById(`${category}MeatToppingsList`);
      const otherList = document.getElementById(`${category}OtherToppingsList`);
      if (!vegList || !meatList || !otherList) return;
      vegList.innerHTML = '';
      meatList.innerHTML = '';
      otherList.innerHTML = '';
      const toppings = masterToppings[category] || [];
      toppings.forEach((topping, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${topping.name} (${topping.type}) - ¬£${topping.price.toFixed(2)}</span>
          <button onclick="deleteMasterTopping('${category}', ${index})">Delete</button>
        `;
        if (topping.type === 'vegetable') vegList.appendChild(li);
        else if (topping.type === 'meat') meatList.appendChild(li);
        else otherList.appendChild(li);
      });
    }
    function deleteMasterTopping(category, index) {
      if (confirm('Are you sure you want to delete this topping?')) {
        masterToppings[category].splice(index, 1);
        saveMasterToppings();
        renderMasterToppings(category);
      }
    }
    // --- Render Menu Preview ---
    function renderMenuPreview() {
      const preview = document.getElementById('menuPreviewContent');
      if (!preview) return;
      let html = '';
      Object.entries(sectionDetails).forEach(([section, items]) => {
        if (!Array.isArray(items) || items.length === 0) return;
        html += `<div class="menu-preview-section">
          <h2>${section}</h2>`;
        items.forEach(item => {
          html += `<div class="menu-preview-item">
            <b>${item.name}</b> <span class="text-muted">${item.description || ''}</span>`;
          if (item.sizes && item.sizes.length) {
            html += '<ul class="menu-preview-sizes">';
            item.sizes.forEach(sz => {
              html += `<li>${sz.name} - ¬£${parseFloat(sz.price).toFixed(2)}</li>`;
            });
            html += '</ul>';
          }
          if (item.toppings && item.toppings.length) {
            html += '<ul class="menu-preview-toppings">';
            item.toppings.forEach(tp => {
              html += `<li>${tp.name ? tp.name : tp}</li>`;
            });
            html += '</ul>';
          }
          html += '</div>';
        });
        html += '</div><hr>';
      });
      preview.innerHTML = html || '<p class="text-muted">No menu items yet. Add sections and details above.</p>';
    }
    // Update preview after any change
    function updateAllUI() {
      renderMasterToppings('pizza');
      renderMasterToppings('salad');
      renderMasterToppings('other');
      renderMenuPreview();
    }
    // Call updateAllUI after changes
    document.addEventListener('DOMContentLoaded', function() {
      // ...existing code...
      loadMasterToppings();
      loadMenuSections();
      updateAllUI();
    });
    // After saving section details, adding/removing size/type/topping, call saveMenuToServer
    // Example:
    // saveMenuToServer();
    // --- Add Menu Item to Staged List ---
    document.addEventListener('DOMContentLoaded', function() {
      const addMenuItemBtn = document.getElementById('addMenuItemBtn');
      if (addMenuItemBtn) {
        addMenuItemBtn.addEventListener('click', async function() {
          if (!currentSection) return;
          // Always read the latest name and description from the input fields
          const details = sectionDetails[currentSection];
          details.itemName = document.getElementById('sectionItemName').value.trim();
          details.description = document.getElementById('sectionDescription').value.trim();
          if (!details.itemName) {
            alert('Menu item name is required');
            document.getElementById('sectionItemName').focus();
            return;
          }
          // Determine category from section name
          let category = 'pizza';
          if (currentSection.toLowerCase().includes('salad')) category = 'salad';
          else if (currentSection.toLowerCase().includes('other')) category = 'other';
          // Always save toppings as array of strings
          details.toppings = (details.toppings || []).map(tp => typeof tp === 'string' ? tp : tp.name);
          // Save directly to backend (update if exists, else create)
          try {
            await fetch('/api/menu', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                name: details.itemName,
                description: details.description,
                sizes: details.sizeTypes || [],
                toppings: details.toppings,
                section: currentSection,
                category // Set category for live menu
              })
            });
            alert('Menu item saved!');
            // Reset all fields for next item
            details.itemName = '';
            details.description = '';
            details.sizeTypes = [];
            details.toppings = [];
            document.getElementById('sectionItemName').value = '';
            document.getElementById('sectionDescription').value = '';
            renderSizeTypeList(currentSection);
            renderSectionToppings(currentSection);
            loadMenuFromServer();
          } catch (error) {
            alert('Failed to save menu item to server');
          }
        });
      }
    });
  </script>
</body>
<script>
// --- Add Section Handler (moved to bottom) ---
document.addEventListener('DOMContentLoaded', function() {
  const addSectionBtn = document.getElementById('addSectionBtn');
  const newSectionInput = document.getElementById('newSectionInput');
  if (addSectionBtn && newSectionInput) {
    console.log('[DEBUG] Add Section handler attached');
    addSectionBtn.addEventListener('click', function() {
      console.log('[DEBUG] Add Section button clicked');
      const sectionName = newSectionInput.value.trim();
      if (!sectionName) {
        alert('Please enter a section name');
        return;
      }
      if (sectionDetails[sectionName]) {
        alert('This section already exists');
        return;
      }
      sectionDetails[sectionName] = [];
      newSectionInput.value = '';
      renderAllSections();
      if (typeof updateSectionDropdown === 'function') updateSectionDropdown();
      if (typeof renderMenuPreview === 'function') renderMenuPreview();
      alert(`Section "${sectionName}" added successfully`);
    });
  } else {
    console.log('[DEBUG] Add Section handler NOT attached: addSectionBtn or newSectionInput missing');
  }
});

// --- Render all sections as cards with their own menu item lists ---
function renderAllSections() {
  const container = document.getElementById('allSectionsContainer');
  container.innerHTML = '';
  Object.keys(sectionDetails).forEach(section => {
    const card = document.createElement('div');
    card.className = 'section-card card';
    card.innerHTML = `
      <h3 class="section-title">${section}</h3>
      <div class="section-items-list" id="itemsList_${section}"></div>
      <button class="add-menu-item-btn" data-section="${section}">‚ûï Add Item</button>
    `;
    container.appendChild(card);
    renderSectionItems(section);
  });
  // Attach add item button listeners
  Array.from(document.getElementsByClassName('add-menu-item-btn')).forEach(btn => {
    btn.onclick = () => showMenuItemEditor(null, null, btn.dataset.section);
  });
}

function renderSectionItems(section) {
  const listDiv = document.getElementById(`itemsList_${section}`);
  listDiv.innerHTML = '';
  const items = sectionDetails[section] || [];
  items.forEach((item, idx) => {
    const card = document.createElement('div');
    card.className = 'menu-item-card';
    card.innerHTML = `
      <div class="menu-item-header">
        <b class="menu-item-title">${item.name}</b>
        <span>
          <button class="edit-menu-item-btn" data-section="${section}" data-idx="${idx}" title="Edit">‚úèÔ∏è</button>
          <button class="delete-menu-item-btn" data-section="${section}" data-idx="${idx}" title="Delete">üóëÔ∏è</button>
        </span>
      </div>
      <div class="menu-item-desc">${item.description || ''}</div>
      <div class="menu-item-sizes"><span class="menu-item-label">Sizes:</span> ${item.sizes.map(s => `<span class='menu-item-size-badge'>${s.name} (¬£${s.price})</span>`).join('')}</div>
      <div class="menu-item-toppings"><span class="menu-item-label">Toppings:</span> ${item.toppings.map(t => t.name || t).join(', ') || '<span class="menu-item-none">None</span>'}</div>
    `;
    listDiv.appendChild(card);
  });
  // Attach event listeners
  Array.from(listDiv.getElementsByClassName('edit-menu-item-btn')).forEach(btn => {
    btn.onclick = () => showMenuItemEditor(sectionDetails[btn.dataset.section][btn.dataset.idx], btn.dataset.idx, btn.dataset.section);
  });
  Array.from(listDiv.getElementsByClassName('delete-menu-item-btn')).forEach(btn => {
    btn.onclick = () => deleteMenuItem(btn.dataset.idx, btn.dataset.section);
  });
}
// Call renderAllSections() after any change to sectionDetails
</script>
</html>