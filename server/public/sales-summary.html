<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Running Orders | None Go Bye</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body { background: #f3f7ef; }
    .running-orders-table { width: 100%; border-collapse: collapse; margin-top: 24px; }
    .running-orders-table th, .running-orders-table td { padding: 12px; border-bottom: 1px solid #ccc; text-align: left; }
    .running-orders-table th { background: #e9ece5; }
    .running-orders-table tr:last-child td { border-bottom: none; }
  .order-status-accepted { background: #e0ffe0; }
  .order-status-pending { background: #fffbe0; }
  .order-status-declined { background: #ffe0e0; }
  .order-new { background: #b4e1ff !important; font-weight: bold; }
    .order-items-list { margin: 0; padding-left: 18px; }
  </style>
</head>
<body>
    <!-- Login redirect removed for dashboard access -->
  <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
  <header>
    <h1 class="main-heading underline">Running Orders (Today)</h1>
    <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
      <a href="admin-menu.html">Menu Editor</a>
      <a href="stock-management.html">Stock Management</a>
      <a href="timeslots.html">Time Slots</a>
      <a href="orders.html">Orders</a>
      <a href="running-orders.html">Running Orders</a>
      <a href="takings.html">Takings</a>
      <a href="pos.html">POS Manual Order</a>
      <a href="offers.html">Special Offers</a>
      <a href="#" class="nav-disabled">Dashboard (coming soon)</a>
    </nav>
  </header>
  <main>
    <main id="main-content">
    <section class="admin-section">
      <table class="running-orders-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Time Slot</th>
            <th>Start By</th>
            <th>Items</th>
            <th>Notes</th>
            <th>Allergens</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="running-orders-tbody">
          <tr><td colspan="7">Loading orders...</td></tr>
        </tbody>
      </table>
    </section>
  </main>
  <script>
    function isToday(dateString) {
      const today = new Date();
      const d = new Date(dateString);
      return d.getFullYear() === today.getFullYear() &&
             d.getMonth() === today.getMonth() &&
             d.getDate() === today.getDate();
    }
  async function fetchRunningOrders() {
      const tbody = document.getElementById('running-orders-tbody');
      tbody.innerHTML = '<tr><td colspan="4">Loading orders...</td></tr>';
  const now = new Date();
  try {
        const res = await fetch('https://admin.thecrustatngb.co.uk/api/orders');
        const orders = await res.json();
        const todaysOrders = orders.filter(o => o.createdAt && isToday(o.createdAt));
        // Sort by timeSlot (earliest first), then by creation time (oldest first)
        todaysOrders.sort((a, b) => {
          const getStart = s => {
            if (!s) return 0;
            const m = /^([0-9]{1,2}):([0-9]{2})/.exec(s);
            if (!m) return 0;
            return parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
          };
          const slotDiff = getStart(a.timeSlot) - getStart(b.timeSlot);
          if (slotDiff !== 0) return slotDiff;
          // If same slot, order by createdAt (oldest first)
          return new Date(a.createdAt) - new Date(b.createdAt);
        });
        if (!todaysOrders.length) {
          tbody.innerHTML = '<tr><td colspan="7">No orders for today.</td></tr>';
          return;
        }
        tbody.innerHTML = '';
  for (const order of todaysOrders) {
          let itemsHtml = '';
          let doughCount = 0;
          if (Array.isArray(order.items) && order.items.length) {
            itemsHtml = '<ul class="order-items-list">' + order.items.map(item => {
              doughCount += Number(item.quantity) || 1;
              return `<li>${item.quantity || 1} Ã— ${item.name}${item.size ? ' (' + item.size + ')' : ''}</li>`;
            }).join('') + '</ul>';
          } else {
            itemsHtml = '<span class="muted">None</span>';
          }
          // Estimate travel time (minutes)
          let travelTime = 10; // fallback default
          try {
            // Use the same Haversine + road factor as orders page
            if (order.address && order.address.postcode) {
              const res = await fetch('https://api.postcodes.io/postcodes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ postcodes: ['LS18 5HZ', order.address.postcode] })
              });
              const data = await res.json();
              if (data.result && data.result.length === 2 && data.result[0].result && data.result[1].result) {
                const lat1 = data.result[0].result.latitude, lon1 = data.result[0].result.longitude;
                const lat2 = data.result[1].result.latitude, lon2 = data.result[1].result.longitude;
                const R = 3958.8;
                const dLat = (lat2-lat1) * Math.PI/180;
                const dLon = (lon2-lon1) * Math.PI/180;
                const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                const miles = R * c * 1.4;
                travelTime = Math.round((miles / 25) * 60); // 25 mph
              }
            }
          } catch {}
          // 3 min to find house + 4 min per dough + 10 min buffer for finishing/packing
          const prepTime = 3 + (4 * doughCount) + 10;
          // Parse start of time slot
          let startBy = '?';
          if (order.timeSlot) {
            const m = /^([0-9]{1,2}):([0-9]{2})/.exec(order.timeSlot);
            if (m) {
              let hour = parseInt(m[1], 10);
              let min = parseInt(m[2], 10);
              // Subtract travel and prep time
              let totalMins = hour * 60 + min - travelTime - prepTime;
              if (totalMins < 0) totalMins += 24 * 60;
              const startHour = Math.floor(totalMins / 60);
              const startMin = totalMins % 60;
              startBy = `${startHour.toString().padStart(2, '0')}:${startMin.toString().padStart(2, '0')}`;
            }
          }
          let statusClass = '';
          if (order.status === 'Accepted') statusClass = 'order-status-accepted';
          else if (order.status === 'Declined') statusClass = 'order-status-declined';
          else statusClass = 'order-status-pending';
          // Highlight new orders (placed in last 2 minutes)
          let newClass = '';
          if (order.createdAt && (now - new Date(order.createdAt) < 2 * 60 * 1000)) newClass = 'order-new';
          tbody.innerHTML += `
            <tr class="${statusClass} ${newClass}">
              <td>${order.name || ''}</td>
              <td>${order.timeSlot || ''}</td>
              <td>${startBy}</td>
              <td>${itemsHtml}</td>
              <td>${order.customerNotes ? `<span style='color:#b9472e'>${order.customerNotes}</span>` : '<span class="muted">None</span>'}</td>
              <td>${order.allergens ? `<span style='color:#b9472e'>${order.allergens}</span>` : '<span class="muted">None</span>'}</td>
              <td>${order.status || 'Pending'}</td>
            </tr>
          `;
        }
      } catch (err) {
        tbody.innerHTML = '<tr><td colspan="4">Error loading orders.</td></tr>';
      }
    }
    fetchRunningOrders();
  setInterval(fetchRunningOrders, 60000); // auto-refresh every 60s
  </script>
</body>
</html>