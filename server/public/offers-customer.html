<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Special Offers | None Go Bye</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="offers-page">
<body class="offers-page app-body" id="offers-customer-page">
  <nav class="main-nav nav-margin">
    <a href="index.html">Home</a>
    <a href="menu.html">Menu</a>
    <a href="checkout.html">Checkout</a>
    <a href="offers-customer.html">Special Offers</a>
  </nav>
  <main id="main-content">
    <h1 class="main-heading underline">Special Offers</h1>
    <section class="offers-section styled-offers-section">
      <div id="customer-offer-list"></div>
    </section>
      <style>
        .offer-item {
          background: #fff;
          border: 1.5px solid #e9c46a;
          border-radius: 8px;
          box-shadow: 0 1px 6px rgba(233,196,106,0.08);
          margin-bottom: 18px;
          padding: 16px 14px;
          font-family: 'Quicksand', Arial, sans-serif;
          color: #b9472e;
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        .offer-item button {
          background: #e9c46a;
          color: #fff;
          border: none;
          border-radius: 6px;
          padding: 8px 18px;
          font-weight: bold;
          font-size: 1em;
          cursor: pointer;
          transition: background 0.2s;
        }
        .offer-item button:hover {
          background: #b9472e;
        }
      </style>
  </main>
  <script>
    let globalOffers = [];
    let globalMenu = [];
    async function fetchOffers() {
      const [offersRes, menuRes] = await Promise.all([
        fetch('/api/offers'),
        fetch('/api/menu')
      ]);
      globalOffers = await offersRes.json();
      const menuData = await menuRes.json();
      globalMenu = menuData.items || [];
      renderOffers(globalOffers);
    }
    function renderOffers(offers) {
      const list = document.getElementById('customer-offer-list');
      if (!offers.length) {
        list.innerHTML = '<em>No special offers available.</em>';
        return;
      }
      list.innerHTML = offers.map((offer, idx) => {
        let price = offer.price ? `£${parseFloat(offer.price).toFixed(2)}` : '';
        let dateStr = '';
        if (offer.startDate || offer.endDate) {
          dateStr = `<span style='color:#888;font-size:0.95em'>${offer.startDate ? 'From ' + new Date(offer.startDate).toLocaleDateString() : ''}${offer.endDate ? ' to ' + new Date(offer.endDate).toLocaleDateString() : ''}</span>`;
        }
        return `
          <div class='offer-item'>
            <span><b>${offer.title}</b> - ${offer.desc}${price ? ' <b>'+price+'</b>' : ''} ${dateStr}</span>
            <button onclick='chooseOffer(${idx})'>Choose</button>
          </div>
        `;
      }).join('');
    }
    window.chooseOffer = function(idx) {
      const offer = globalOffers[idx];
      if (!offer.offerItems || !offer.offerItems.length) {
        alert('No eligible items for this offer.');
        return;
      }
      // Build eligible items from offerItems
      let itemList = offer.offerItems.map((oi, i) => {
        const menuItem = globalMenu.find(m => m._id === oi.itemId);
        let extra = oi.extra && !isNaN(oi.extra) ? ` (+£${parseFloat(oi.extra).toFixed(2)})` : '';
        return `<option value='${i}'>${menuItem ? menuItem.name : oi.itemId}${extra}</option>`;
      }).join('');
      let html = `<div style='padding:18px;'>
        <b>Choose your item for this offer:</b><br>
        <select id='offer-item-select'>${itemList}</select>
        <div id='offer-size-select-div' style='margin-top:12px;'></div>
        <button id='confirm-offer-item-btn'>Confirm</button>
      </div>`;
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.3)';
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = '9999';
      modal.innerHTML = `<div style='background:#fff;padding:32px;border-radius:10px;box-shadow:0 2px 12px #0002;'>${html}</div>`;
      document.body.appendChild(modal);

      // Size selection logic
      function renderSizes(idx) {
        const oi = offer.offerItems[idx];
        if (!oi || !oi.sizes || !oi.sizes.length) {
          document.getElementById('offer-size-select-div').innerHTML = '';
          return;
        }
        let sizeList = oi.sizes.map((sz, j) => {
          let extra = sz.extra && !isNaN(sz.extra) ? ` (+£${parseFloat(sz.extra).toFixed(2)})` : '';
          return `<option value='${j}'>${sz.name}${extra}</option>`;
        }).join('');
        document.getElementById('offer-size-select-div').innerHTML = `<b>Choose size:</b><br><select id='offer-size-select'>${sizeList}</select>`;
      }
      // Initial render
      renderSizes(0);
      modal.querySelector('#offer-item-select').onchange = function() {
        renderSizes(this.value);
      };
      modal.querySelector('#confirm-offer-item-btn').onclick = function() {
        const itemIdx = modal.querySelector('#offer-item-select').value;
        const oi = offer.offerItems[itemIdx];
        let extra = oi.extra && !isNaN(oi.extra) ? parseFloat(oi.extra) : 0;
        let selectedSize = null;
        let sizeExtra = 0;
        if (oi.sizes && oi.sizes.length) {
          const sizeIdx = modal.querySelector('#offer-size-select').value;
          if (sizeIdx !== undefined && oi.sizes[sizeIdx]) {
            selectedSize = oi.sizes[sizeIdx].name;
            if (oi.sizes[sizeIdx].extra && !isNaN(oi.sizes[sizeIdx].extra)) {
              sizeExtra = parseFloat(oi.sizes[sizeIdx].extra);
            }
          }
        }
        localStorage.setItem('selectedOffer', offer._id);
        localStorage.setItem('selectedOfferItem', oi.itemId);
        if (selectedSize) localStorage.setItem('selectedOfferItemSize', selectedSize);
        else localStorage.removeItem('selectedOfferItemSize');
        const totalExtra = (extra || 0) + (sizeExtra || 0);
        if (totalExtra > 0) {
          localStorage.setItem('selectedOfferItemExtra', totalExtra);
        } else {
          localStorage.removeItem('selectedOfferItemExtra');
        }
        document.body.removeChild(modal);
        alert('Offer and item selected! You can now use it at checkout.');
      };
    }
    fetchOffers();
  </script>
</body>
</html>
