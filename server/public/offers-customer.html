<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Special Offers | None Go Bye</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="offers-page">
<body class="offers-page app-body" id="offers-customer-page">
  <nav class="main-nav" style="margin-bottom: 24px;">
    <a href="index.html">Home</a>
    <a href="menu.html">Menu</a>
    <a href="checkout.html">Checkout</a>
    <a href="offers-customer.html">Special Offers</a>
  </nav>
  <main id="main-content">
    <h1 class="main-heading underline">Special Offers</h1>
    <section class="offers-section" style="background: #fffbe6; border-radius: 12px; box-shadow: 0 2px 12px rgba(233,196,106,0.08); padding: 24px 18px; margin: 18px auto; max-width: 600px;">
      <div id="customer-offer-list"></div>
    </section>
      <style>
        .offer-item {
          background: #fff;
          border: 1.5px solid #e9c46a;
          border-radius: 8px;
          box-shadow: 0 1px 6px rgba(233,196,106,0.08);
          margin-bottom: 18px;
          padding: 16px 14px;
          font-family: 'Quicksand', Arial, sans-serif;
          color: #b9472e;
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        .offer-item button {
          background: #e9c46a;
          color: #fff;
          border: none;
          border-radius: 6px;
          padding: 8px 18px;
          font-weight: bold;
          font-size: 1em;
          cursor: pointer;
          transition: background 0.2s;
        }
        .offer-item button:hover {
          background: #b9472e;
        }
      </style>
  </main>
  <script>
    let globalOffers = [];
    let globalMenu = [];
    async function fetchOffers() {
      const [offersRes, menuRes] = await Promise.all([
        fetch('/api/offers'),
        fetch('/api/menu')
      ]);
      globalOffers = await offersRes.json();
      const menuData = await menuRes.json();
      globalMenu = menuData.items || [];
      renderOffers(globalOffers);
    }
    function renderOffers(offers) {
      const list = document.getElementById('customer-offer-list');
      if (!offers.length) {
        list.innerHTML = '<em>No special offers available.</em>';
        return;
      }
      list.innerHTML = offers.map((offer, idx) => {
        let price = offer.price ? `£${parseFloat(offer.price).toFixed(2)}` : '';
        let dateStr = '';
        if (offer.startDate || offer.endDate) {
          dateStr = `<span style='color:#888;font-size:0.95em'>${offer.startDate ? 'From ' + new Date(offer.startDate).toLocaleDateString() : ''}${offer.endDate ? ' to ' + new Date(offer.endDate).toLocaleDateString() : ''}</span>`;
        }
        return `
          <div class='offer-item'>
            <span><b>${offer.title}</b> - ${offer.desc}${price ? ' <b>'+price+'</b>' : ''} ${dateStr}</span>
            <button onclick='chooseOffer(${idx})'>Choose</button>
          </div>
        `;
      }).join('');
    }
    window.chooseOffer = function(idx) {
      const offer = globalOffers[idx];
      // Find eligible items for the first section (can be extended for multi-section offers)
      const section = (offer.sections && offer.sections[0]) || null;
      const blocked = (offer.blockedItems && offer.blockedItems[0]) || [];
      const extraPrices = (offer.extraPrices && offer.extraPrices[0]) || {};
      const eligibleItems = globalMenu.filter(item => item.section === section && !blocked.includes(item._id));
      if (!section || eligibleItems.length === 0) {
        alert('No eligible items for this offer.');
        return;
      }
      // Show a prompt to pick an item, showing extra price if set
      let itemList = eligibleItems.map(i => {
        let extra = '';
        if (extraPrices && typeof extraPrices === 'object' && extraPrices[i._id] !== undefined) {
          const val = parseFloat(extraPrices[i._id]);
          if (!isNaN(val) && val > 0) extra = ` (+£${val.toFixed(2)})`;
        }
        return `<option value='${i._id}'>${i.name}${extra}</option>`;
      }).join('');
      const html = `
        <div style='padding:18px;'>
          <b>Choose your item from section: ${section}</b><br>
          <select id='offer-item-select'>${itemList}</select>
          <button id='confirm-offer-item-btn'>Confirm</button>
        </div>
      `;
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.3)';
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = '9999';
      modal.innerHTML = `<div style='background:#fff;padding:32px;border-radius:10px;box-shadow:0 2px 12px #0002;'>${html}</div>`;
      document.body.appendChild(modal);
      modal.querySelector('#confirm-offer-item-btn').onclick = function() {
        const selectedId = modal.querySelector('#offer-item-select').value;
        let extra = '';
        if (extraPrices && typeof extraPrices === 'object' && extraPrices[selectedId] !== undefined) {
          const val = parseFloat(extraPrices[selectedId]);
          if (!isNaN(val) && val > 0) extra = val;
        }
        localStorage.setItem('selectedOffer', offer._id);
        localStorage.setItem('selectedOfferItem', selectedId);
        if (extra) {
          localStorage.setItem('selectedOfferItemExtra', extra);
        } else {
          localStorage.removeItem('selectedOfferItemExtra');
        }
        document.body.removeChild(modal);
        alert('Offer and item selected! You can now use it at checkout.');
      };
    }
    fetchOffers();
  </script>
</body>
</html>
