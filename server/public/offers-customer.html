<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Special Offers | None Go Bye</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="offers-page">
<body class="offers-page app-body" id="offers-customer-page">
  <nav class="main-nav nav-margin">
    <a href="index.html">Home</a>
    <a href="menu.html">Menu</a>
    <a href="checkout.html">Checkout</a>
    <a href="offers-customer.html">Special Offers</a>
  </nav>
  <main id="main-content">
    <h1 class="main-heading underline">Special Offers</h1>
    <section class="offers-section styled-offers-section">
      <div id="customer-offer-list"></div>
    </section>
      <style>
        .offer-item {
          background: #fff;
          border: 1.5px solid #e9c46a;
          border-radius: 8px;
          box-shadow: 0 1px 6px rgba(233,196,106,0.08);
          margin-bottom: 18px;
          padding: 16px 14px;
          font-family: 'Quicksand', Arial, sans-serif;
          color: #b9472e;
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        .offer-item button {
          background: #e9c46a;
          color: #fff;
          border: none;
          border-radius: 6px;
          padding: 8px 18px;
          font-weight: bold;
          font-size: 1em;
          cursor: pointer;
          transition: background 0.2s;
        }
        .offer-item button:hover {
          background: #b9472e;
        }
      </style>
  </main>
  <script>
    let globalOffers = [];
    let globalMenu = [];
    async function fetchOffers() {
      const [offersRes, menuRes] = await Promise.all([
        fetch('/api/offers'),
        fetch('/api/menu')
      ]);
      globalOffers = await offersRes.json();
      const menuData = await menuRes.json();
      globalMenu = menuData.items || [];
      renderOffers(globalOffers);
    }
    function renderOffers(offers) {
      const list = document.getElementById('customer-offer-list');
      if (!offers.length) {
        list.innerHTML = '<em>No special offers available.</em>';
        return;
      }
      list.innerHTML = offers.map((offer, idx) => {
        let price = offer.price ? `£${parseFloat(offer.price).toFixed(2)}` : '';
        let dateStr = '';
        if (offer.startDate || offer.endDate) {
          dateStr = `<span style='color:#888;font-size:0.95em'>${offer.startDate ? 'From ' + new Date(offer.startDate).toLocaleDateString() : ''}${offer.endDate ? ' to ' + new Date(offer.endDate).toLocaleDateString() : ''}</span>`;
        }
        return `
          <div class='offer-item'>
            <span><b>${offer.title}</b> - ${offer.desc}${price ? ' <b>'+price+'</b>' : ''} ${dateStr}</span>
            <button onclick='chooseOffer(${idx})'>Choose</button>
          </div>
        `;
      }).join('');
    }
    window.chooseOffer = function(idx) {
      const offer = globalOffers[idx];
      if (!offer.offerItems || !offer.offerItems.length) {
        alert('No eligible items for this offer.');
        return;
      }
      // Group offerItems by section
      const sectionMap = {};
      offer.offerItems.forEach(oi => {
        if (!sectionMap[oi.section]) sectionMap[oi.section] = [];
        sectionMap[oi.section].push(oi);
      });
      let html = `<div style='padding:18px;'>`;
      let sectionKeys = Object.keys(sectionMap);
      if (sectionKeys.length > 1) {
        html += `<b>Choose one item from each section:</b><br>`;
      } else {
        html += `<b>Choose your item for this offer:</b><br>`;
      }
      sectionKeys.forEach((section, sIdx) => {
        html += `<div style='margin-bottom:16px;'><b>${section}</b><br>`;
        let itemList = sectionMap[section].map((oi, i) => {
          const menuItem = globalMenu.find(m => m._id === oi.itemId);
          let extra = oi.extra && !isNaN(oi.extra) ? ` (+£${parseFloat(oi.extra).toFixed(2)})` : '';
          return `<option value='${i}'>${menuItem ? menuItem.name : oi.itemId}${extra}</option>`;
        }).join('');
        html += `<select class='offer-item-select' data-section='${section}' id='offer-item-select-${sIdx}'>${itemList}</select>`;
        html += `<div class='offer-size-select-div' id='offer-size-select-div-${sIdx}' style='margin-top:12px;'></div>`;
        html += `</div>`;
      });
      html += `<button id='confirm-offer-item-btn'>Confirm</button></div>`;
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.3)';
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = '9999';
      modal.innerHTML = `<div style='background:#fff;padding:32px;border-radius:10px;box-shadow:0 2px 12px #0002;'>${html}</div>`;
      document.body.appendChild(modal);

      // Size selection logic for each section
      sectionKeys.forEach((section, sIdx) => {
        function renderSizes(idx) {
          const oi = sectionMap[section][idx];
          const sizeDiv = modal.querySelector(`#offer-size-select-div-${sIdx}`);
          if (!oi || !oi.sizes || !oi.sizes.length) {
            sizeDiv.innerHTML = '';
            return;
          }
          let sizeList = oi.sizes.map((sz, j) => {
            let extra = sz.extra && !isNaN(sz.extra) ? ` (+£${parseFloat(sz.extra).toFixed(2)})` : '';
            return `<option value='${j}'>${sz.name}${extra}</option>`;
          }).join('');
          sizeDiv.innerHTML = `<b>Choose size:</b><br><select class='offer-size-select' data-section='${section}' id='offer-size-select-${sIdx}'>${sizeList}</select>`;
        }
        // Initial render
        renderSizes(0);
        modal.querySelector(`#offer-item-select-${sIdx}`).onchange = function() {
          renderSizes(this.value);
        };
      });

      modal.querySelector('#confirm-offer-item-btn').onclick = function() {
        // For each section, get selected item and size
        let selected = [];
        sectionKeys.forEach((section, sIdx) => {
          const itemIdx = modal.querySelector(`#offer-item-select-${sIdx}`).value;
          const oi = sectionMap[section][itemIdx];
          let extra = oi.extra && !isNaN(oi.extra) ? parseFloat(oi.extra) : 0;
          let selectedSize = null;
          let sizeExtra = 0;
          const sizeSel = modal.querySelector(`#offer-size-select-${sIdx}`);
          if (oi.sizes && oi.sizes.length && sizeSel) {
            const sizeIdx = sizeSel.value;
            if (sizeIdx !== undefined && oi.sizes[sizeIdx]) {
              selectedSize = oi.sizes[sizeIdx].name;
              if (oi.sizes[sizeIdx].extra && !isNaN(oi.sizes[sizeIdx].extra)) {
                sizeExtra = parseFloat(oi.sizes[sizeIdx].extra);
              }
            }
          }
          selected.push({
            section,
            itemId: oi.itemId,
            size: selectedSize,
            extra: (extra || 0) + (sizeExtra || 0)
          });
        });
        // Store as JSON in localStorage
        localStorage.setItem('selectedOffer', offer._id);
        localStorage.setItem('selectedOfferSelections', JSON.stringify(selected));
        document.body.removeChild(modal);
        alert('Offer selections saved! You can now use them at checkout.');
      };
    }
    fetchOffers();
  </script>
</body>
</html>
